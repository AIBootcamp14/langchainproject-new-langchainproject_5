# 05. ëŒ€í™” ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ (ConversationMemory)

## ğŸ“‹ ë¬¸ì„œ ì •ë³´
- **ì‘ì„±ì¼**: 2025-11-03
- **ì‹œìŠ¤í…œëª…**: ëŒ€í™” ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œ
- **êµ¬í˜„ íŒŒì¼**: `src/memory/chat_history.py`
- **ìš°ì„ ìˆœìœ„**: â­ (ë³´í†µ - ëŒ€í™” ì»¨í…ìŠ¤íŠ¸ ê´€ë¦¬)
- **ì°¸ê³  ë¬¸ì„œ**: ì´ ë¬¸ì„œëŠ” PRDì— ë³„ë„ ëª…ì„¸ê°€ ì—†ìœ¼ë©° êµ¬í˜„ ì½”ë“œ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë¨

---

## ğŸ“Œ ì‹œìŠ¤í…œ ê°œìš”

### ëª©ì  ë° ë°°ê²½

ëŒ€í™” ë©”ëª¨ë¦¬ ì‹œìŠ¤í…œì€ **ë©€í‹°í„´ ëŒ€í™”ì—ì„œ ì´ì „ ëŒ€í™” ë‚´ìš©ì„ ê¸°ì–µí•˜ì—¬ ì»¨í…ìŠ¤íŠ¸ë¥¼ ìœ ì§€**í•˜ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤. `src/memory/chat_history.py`ì— `ChatMemoryManager` í´ë˜ìŠ¤ë¡œ êµ¬í˜„ë˜ì–´ ìˆìœ¼ë©°, Agentì™€ í†µí•©í•˜ì—¬ ì‚¬ìš©ë©ë‹ˆë‹¤.

### ì£¼ìš” ì—­í• 

1. **ë©”ì‹œì§€ ì €ì¥**: ì‚¬ìš©ì ë° AI ë©”ì‹œì§€ ì €ì¥
2. **íˆìŠ¤í† ë¦¬ ì¡°íšŒ**: ì „ì²´ ëŒ€í™” íˆìŠ¤í† ë¦¬ ë°˜í™˜
3. **ì„¸ì…˜ ê´€ë¦¬**: ì„ íƒì ìœ¼ë¡œ DB ê¸°ë°˜ ì„¸ì…˜ ì§€ì›
4. **ì»¨í…ìŠ¤íŠ¸ ìœ ì§€**: ì´ì „ ëŒ€í™” ê¸°ì–µìœ¼ë¡œ ìì—°ìŠ¤ëŸ¬ìš´ ëŒ€í™”

### ì§€ì› ë©”ëª¨ë¦¬ íƒ€ì…

| íƒ€ì… | êµ¬í˜„ | ì €ì¥ì†Œ | ì‚¬ìš© ì‹œë‚˜ë¦¬ì˜¤ |
|------|------|--------|--------------|
| **ConversationBufferMemory** | ê¸°ë³¸ | ë©”ëª¨ë¦¬ | ë‹¨ì¼ ì„¸ì…˜, ì¼ì‹œì  ëŒ€í™” |
| **PostgresChatMessageHistory** | ì„ íƒ | PostgreSQL | ì˜êµ¬ ì €ì¥, ì„¸ì…˜ ë³µì› |

---

## ğŸ—ï¸ ChatMemoryManager í´ë˜ìŠ¤ êµ¬ì¡°

### ì£¼ìš” ë©”ì„œë“œ

| ë©”ì„œë“œ | ì„¤ëª… | êµ¬í˜„ ë‚´ìš© |
|--------|------|-----------|
| `__init__()` | ë©”ëª¨ë¦¬ ì´ˆê¸°í™” | ConversationBufferMemory ìƒì„± |
| `add_user_message(message)` | ì‚¬ìš©ì ë©”ì‹œì§€ ì¶”ê°€ | chat_memoryì— ì €ì¥ |
| `add_ai_message(message)` | AI ë©”ì‹œì§€ ì¶”ê°€ | chat_memoryì— ì €ì¥ |
| `get_history()` | ì „ì²´ íˆìŠ¤í† ë¦¬ ì¡°íšŒ | load_memory_variables í˜¸ì¶œ |
| `clear()` | íˆìŠ¤í† ë¦¬ ì´ˆê¸°í™” | ë©”ëª¨ë¦¬ í´ë¦¬ì–´ |

### ë©”ëª¨ë¦¬ êµ¬ì¡°

```python
from langchain.memory import ConversationBufferMemory

class ChatMemoryManager:
    def __init__(self):
        self.memory = ConversationBufferMemory(
            return_messages=True,
            memory_key="chat_history"
        )
```

**íŠ¹ì§•:**
- `return_messages=True`: ë©”ì‹œì§€ ê°ì²´ë¡œ ë°˜í™˜
- `memory_key="chat_history"`: Agent stateì˜ messages í•„ë“œì™€ ì—°ê²°

---

## ğŸ”— Agentì™€ì˜ í†µí•©

### ë©€í‹°í„´ ëŒ€í™” ì‹œë‚˜ë¦¬ì˜¤

```python
from src.memory.chat_history import ChatMemoryManager
from src.agent.graph import create_agent_graph

# ë©”ëª¨ë¦¬ ë§¤ë‹ˆì € ìƒì„±
memory = ChatMemoryManager()

# ì²« ë²ˆì§¸ ì§ˆë¬¸
state1 = {
    "question": "RAGê°€ ë­ì•¼?",
    "difficulty": "easy",
    "messages": memory.get_history()["chat_history"]
}
result1 = agent.invoke(state1)

# ë©”ëª¨ë¦¬ì— ì¶”ê°€
memory.add_user_message(state1["question"])
memory.add_ai_message(result1["final_answer"])

# ë‘ ë²ˆì§¸ ì§ˆë¬¸ (ì´ì „ ëŒ€í™” ê¸°ì–µ)
state2 = {
    "question": "ê·¸ëŸ¼ ì–´ë””ì— ì‚¬ìš©ë¼?",  # ëŒ€ëª…ì‚¬ "ê·¸ëŸ¼" ì‚¬ìš© ê°€ëŠ¥
    "difficulty": "easy",
    "messages": memory.get_history()["chat_history"]
}
result2 = agent.invoke(state2)
```

**íš¨ê³¼:**
- ë‘ ë²ˆì§¸ ì§ˆë¬¸ì—ì„œ "ê·¸ëŸ¼"ì´ "RAG"ë¥¼ ê°€ë¦¬í‚¨ë‹¤ëŠ” ê²ƒì„ LLMì´ ì´í•´
- ì´ì „ ë‹µë³€ì˜ ì»¨í…ìŠ¤íŠ¸ë¥¼ í™œìš©í•˜ì—¬ ìì—°ìŠ¤ëŸ¬ìš´ ë‹µë³€ ìƒì„±

---

## ğŸ“‹ ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš° ê´€ë¦¬

### ìµœê·¼ Ní„´ë§Œ ìœ ì§€

ëŒ€í™”ê°€ ê¸¸ì–´ì§€ë©´ í† í° ì œí•œì— ë„ë‹¬í•  ìˆ˜ ìˆìœ¼ë¯€ë¡œ ìµœê·¼ Ní„´ë§Œ ìœ ì§€í•˜ëŠ” ì „ëµì´ í•„ìš”í•©ë‹ˆë‹¤:

```python
class LimitedMemoryManager(ChatMemoryManager):
    """ìµœê·¼ Ní„´ë§Œ ìœ ì§€í•˜ëŠ” ë©”ëª¨ë¦¬ ë§¤ë‹ˆì €"""

    def __init__(self, max_turns=10):
        super().__init__()
        self.max_turns = max_turns

    def _trim_history(self):
        """ìµœê·¼ Ní„´ë§Œ ìœ ì§€"""
        messages = self.memory.chat_memory.messages
        if len(messages) > self.max_turns * 2:  # user + ai = 2 messages per turn
            self.memory.chat_memory.messages = messages[-(self.max_turns * 2):]
```

**ì‚¬ìš©:**
```python
memory = LimitedMemoryManager(max_turns=10)
```

---

## ğŸ”— ì„¸ì…˜ ê¸°ë°˜ ë©”ëª¨ë¦¬ (ì„ íƒ)

### PostgreSQL ì €ì¥

ì˜êµ¬ ì €ì¥ì´ í•„ìš”í•œ ê²½ìš° PostgresChatMessageHistoryë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

```python
from langchain_postgres import PostgresChatMessageHistory
import os

def get_session_history(session_id: str):
    """ì„¸ì…˜ ê¸°ë°˜ ë©”ëª¨ë¦¬ (PostgreSQL ì €ì¥)"""
    connection_string = os.getenv("DATABASE_URL")

    return PostgresChatMessageHistory(
        session_id=session_id,
        connection_string=connection_string,
        table_name="chat_history"
    )
```

**ì‚¬ìš©:**
```python
# ì‚¬ìš©ìë³„ ì„¸ì…˜
session_history = get_session_history("user_123")
session_history.add_user_message("RAGê°€ ë­ì•¼?")
session_history.add_ai_message("RAGëŠ”...")

# ë‚˜ì¤‘ì— ì„¸ì…˜ ë³µì›
session_history = get_session_history("user_123")
messages = session_history.messages
print(messages)
```

---

## âš ï¸ ì£¼ì˜ì‚¬í•­

### 1. í† í° ì œí•œ ê´€ë¦¬

ëŒ€í™”ê°€ ê¸¸ì–´ì§€ë©´ í† í° ì´ˆê³¼ê°€ ë°œìƒí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤:

**ë°©ë²• 1: ìµœê·¼ 10í„´ë§Œ ìœ ì§€**
```python
memory = LimitedMemoryManager(max_turns=10)
```

**ë°©ë²• 2: ì£¼ê¸°ì  ì´ˆê¸°í™”**
```python
if len(memory.get_history()["chat_history"]) > 20:
    memory.clear()
```

### 2. ì„¸ì…˜ ê´€ë¦¬

ì‚¬ìš©ìë³„ ì„¸ì…˜ IDë¥¼ ëª…í™•íˆ ê´€ë¦¬:

```python
session_id = f"user_{user_id}"
session_history = get_session_history(session_id)
```

### 3. ë©”ëª¨ë¦¬ íƒ€ì… ì„ íƒ

| ìƒí™© | ì¶”ì²œ ë©”ëª¨ë¦¬ |
|------|------------|
| ë‹¨ì¼ ì„¸ì…˜, ì¼ì‹œì  ëŒ€í™” | ConversationBufferMemory |
| ì˜êµ¬ ì €ì¥ í•„ìš” | PostgresChatMessageHistory |
| ì„¸ì…˜ ë³µì› í•„ìš” | PostgresChatMessageHistory |

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **[03_AI_Agent_ì‹œìŠ¤í…œ.md](./03_AI_Agent_ì‹œìŠ¤í…œ.md)** - Agentì—ì„œ ë©”ëª¨ë¦¬ ì‚¬ìš©
- **[04_LLM_í´ë¼ì´ì–¸íŠ¸.md](./04_LLM_í´ë¼ì´ì–¸íŠ¸.md)** - LLM í† í° ê´€ë¦¬

---

## ğŸ“ ìš”ì•½

### êµ¬í˜„ëœ í•µì‹¬ ê¸°ëŠ¥

1. âœ… ì‚¬ìš©ì ë©”ì‹œì§€ ì €ì¥ (`add_user_message`)
2. âœ… AI ë©”ì‹œì§€ ì €ì¥ (`add_ai_message`)
3. âœ… ëŒ€í™” íˆìŠ¤í† ë¦¬ ì¡°íšŒ (`get_history`)
4. âœ… ë©”ëª¨ë¦¬ ì´ˆê¸°í™” (`clear`)
5. âœ… ì„¸ì…˜ ê¸°ë°˜ ë©”ëª¨ë¦¬ (PostgreSQL, ì„ íƒ)
6. âœ… ì»¨í…ìŠ¤íŠ¸ ìœˆë„ìš° ê´€ë¦¬ (ìµœê·¼ Ní„´)

### ì‚¬ìš© íŒ¨í„´

```python
# ë©”ëª¨ë¦¬ ìƒì„±
memory = ChatMemoryManager()

# ë©”ì‹œì§€ ì¶”ê°€
memory.add_user_message("RAGê°€ ë­ì•¼?")
memory.add_ai_message("RAGëŠ” Retrieval-Augmented Generation...")

# íˆìŠ¤í† ë¦¬ ì¡°íšŒ
history = memory.get_history()
messages = history["chat_history"]

# Agentì™€ í†µí•©
state = {
    "question": "ê·¸ëŸ¼ ì–´ë””ì— ì‚¬ìš©ë¼?",
    "messages": memory.get_history()["chat_history"]
}
result = agent.invoke(state)
```

### ëª¨ë²” ì‚¬ë¡€

1. Agent ì‹¤í–‰ë§ˆë‹¤ ë©”ëª¨ë¦¬ í†µí•©
2. ìµœê·¼ 10í„´ë§Œ ìœ ì§€ (í† í° ì ˆì•½)
3. ì„¸ì…˜ ê¸°ë°˜ ë©”ëª¨ë¦¬ë¡œ ì˜êµ¬ ì €ì¥ (í•„ìš” ì‹œ)
4. ì£¼ê¸°ì ìœ¼ë¡œ ë©”ëª¨ë¦¬ ì´ˆê¸°í™”
5. ì‚¬ìš©ìë³„ session_id ê´€ë¦¬
