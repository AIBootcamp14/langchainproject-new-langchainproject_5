# 담당역할_06: 로깅 및 모니터링 시스템

## 문서 정보
- **작성일**: 2025-10-31
- **프로젝트명**: 논문 리뷰 챗봇 (AI Agent + RAG)
- **팀명**: 연결의 민족
- **담당 기능**: 로깅 시스템, 모니터링, 실험 추적 관리

---

## 담당자 정보

**담당자**: 최현화[팀장]

**역할**: 로깅 및 모니터링 시스템 구축

---

## 담당 업무 개요

이 역할은 프로젝트 전체에서 사용되는 **로깅 시스템 구축** 및 **사용자 질의 모니터링** 기능을 담당합니다.

### 주요 책임

1. **Logger 클래스 구현** (`src/utils/logger.py`)
   - 타임스탬프 자동 추가
   - 파일 및 콘솔 동시 출력
   - 표준 출력 리디렉션
   - tqdm 진행률 표시 통합

2. **query_logs 테이블 구현**
   - 사용자 질의 로그 저장
   - 응답 시간 측정
   - 도구 사용 통계

3. **실험 폴더 구조 관리**
   - `experiments/날짜/날짜_시간_실험명/` 구조 지원
   - 로그 파일 자동 생성 및 관리

---

## 참여 기간 및 우선순위

### 참여 기간
- **전체 기간 참여** (2025-10-28 ~ 2025-11-06, 10일)
- **우선 작업 기간**: 프로젝트 초기 (10/28-10/30, 3일)
  - Logger 클래스를 먼저 구현해야 다른 팀원들이 사용 가능

### 우선순위
1. **최우선 (Day 1-2)**: Logger 클래스 구현
2. **우선 (Day 3-4)**: query_logs 테이블 및 로깅 기능 구현
3. **선택 (Day 5+)**: 로그 분석 도구, 대시보드 (추가선택기능)

---

## 세부 업무 및 구현 내용

### 1. Logger 클래스 구현

**파일 경로**: `src/utils/logger.py`

#### 1.1 클래스 구조

```python
import sys
from datetime import datetime
from pathlib import Path
from typing import Optional


class Logger:
    """
    프로젝트 전체에서 사용하는 로깅 클래스

    주요 기능:
    - 타임스탬프 자동 추가
    - 파일 및 콘솔 동시 출력
    - 표준 출력 리디렉션
    - tqdm 진행률 표시 통합
    """

    def __init__(self, log_path: str, print_also: bool = True):
        """
        Logger 초기화

        Args:
            log_path: 로그 파일 경로 (예: "experiments/20251030/experiment.log")
            print_also: True면 콘솔에도 출력
        """
        self.log_path = Path(log_path)
        self.print_also = print_also

        # 로그 폴더 생성
        self.log_path.parent.mkdir(parents=True, exist_ok=True)

        # 로그 파일 열기
        self.log_file = open(self.log_path, 'a', encoding='utf-8')

        # 리디렉션 백업
        self._stdout_backup = None
        self._stderr_backup = None

    def write(self, message: str, print_also: Optional[bool] = None, print_error: bool = False):
        """
        로그 메시지 기록

        Args:
            message: 기록할 메시지
            print_also: 콘솔 출력 여부 (None이면 기본값 사용)
            print_error: True면 에러 메시지로 표시 (빨간색)
        """
        # 빈 메시지 무시
        if not message or not message.strip():
            return

        # 타임스탬프 추가
        timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
        log_line = f"{timestamp} | {message}"

        # 파일에 기록
        self.log_file.write(log_line + '\n')
        self.log_file.flush()

        # 콘솔 출력
        should_print = print_also if print_also is not None else self.print_also
        if should_print:
            if print_error:
                # 에러 메시지는 빨간색으로
                print(f"\033[91m{log_line}\033[0m")
            else:
                print(log_line)

    def start_redirect(self):
        """표준 출력/에러를 로그 파일로 리디렉션 시작"""
        self._stdout_backup = sys.stdout
        self._stderr_backup = sys.stderr

        sys.stdout = self
        sys.stderr = self

    def stop_redirect(self):
        """표준 출력/에러 리디렉션 중지"""
        if self._stdout_backup:
            sys.stdout = self._stdout_backup
        if self._stderr_backup:
            sys.stderr = self._stderr_backup

    def tqdm_redirect(self):
        """tqdm 진행률 표시를 로그로 리디렉션"""
        try:
            from tqdm import tqdm
            # tqdm의 file 파라미터를 현재 Logger로 설정
            return tqdm
        except ImportError:
            self.write("tqdm이 설치되지 않았습니다.", print_error=True)
            return None

    def flush(self):
        """버퍼 플러시"""
        self.log_file.flush()

    def close(self):
        """로그 파일 닫기"""
        if hasattr(self, 'log_file') and self.log_file:
            self.log_file.close()

    def __del__(self):
        """소멸자 - 파일 자동 닫기"""
        self.close()
```

#### 1.2 사용 예시

```python
import os
from datetime import datetime
from src.utils.logger import Logger

# 로그 폴더 경로 생성
today = datetime.now().strftime("%Y%m%d")
time_now = datetime.now().strftime("%H%M%S")
experiment_name = "rag_vectordb_build"

# 실험 폴더 생성
log_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"
os.makedirs(log_dir, exist_ok=True)

# Logger 인스턴스 생성
logger = Logger(
    log_path=f"{log_dir}/experiment.log",
    print_also=True  # 콘솔에도 출력
)

# 로그 기록
logger.write("VectorDB 구축 시작")
logger.write(f"총 {len(documents)}개 문서 로드 완료")

# 에러 메시지 (빨간색)
logger.write("오류: 파일을 찾을 수 없습니다.", print_error=True)

# Logger 종료
logger.close()
```

#### 1.3 표준 출력 리디렉션

```python
logger = Logger(f"{log_dir}/training.log")

# 리디렉션 시작
logger.start_redirect()

# 이제 print도 자동으로 로그에 기록됨
print("이 메시지는 로그 파일에 저장됩니다.")

# 리디렉션 중지
logger.stop_redirect()

logger.close()
```

---

### 2. query_logs 테이블 구현

**목적**: 사용자 질의, 응답 시간, 사용된 도구 등을 기록하여 시스템 성능 분석 및 개선에 활용

#### 2.1 데이터베이스 스키마

**파일 경로**: `database/schema.sql`에 추가

```sql
-- query_logs 테이블 생성
CREATE TABLE IF NOT EXISTS query_logs (
    log_id SERIAL PRIMARY KEY,
    user_query TEXT NOT NULL,              -- 사용자 질문
    difficulty_mode VARCHAR(20),           -- 'easy' 또는 'hard'
    tool_used VARCHAR(50),                 -- 사용된 도구명
    response TEXT,                         -- 생성된 응답
    response_time_ms INT,                  -- 응답 시간 (밀리초)
    success BOOLEAN DEFAULT TRUE,          -- 성공 여부
    error_message TEXT,                    -- 오류 메시지 (있는 경우)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

-- 인덱스 생성
CREATE INDEX IF NOT EXISTS idx_query_logs_created_at ON query_logs(created_at DESC);
CREATE INDEX IF NOT EXISTS idx_query_logs_tool_used ON query_logs(tool_used);
CREATE INDEX IF NOT EXISTS idx_query_logs_success ON query_logs(success);
CREATE INDEX IF NOT EXISTS idx_query_logs_difficulty ON query_logs(difficulty_mode);
```

#### 2.2 QueryLogger 클래스

**파일 경로**: `src/utils/query_logger.py`

```python
import psycopg2
from datetime import datetime
from typing import Optional
import os
from dotenv import load_dotenv

load_dotenv()


class QueryLogger:
    """
    사용자 질의 로그를 PostgreSQL에 저장하는 클래스
    """

    def __init__(self):
        """PostgreSQL 연결 초기화"""
        self.conn = psycopg2.connect(
            host=os.getenv("POSTGRES_HOST", "localhost"),
            port=os.getenv("POSTGRES_PORT", "5432"),
            database=os.getenv("POSTGRES_DB", "papers"),
            user=os.getenv("POSTGRES_USER"),
            password=os.getenv("POSTGRES_PASSWORD")
        )

    def log_query(
        self,
        user_query: str,
        difficulty_mode: str,
        tool_used: str,
        response: str,
        response_time_ms: int,
        success: bool = True,
        error_message: Optional[str] = None
    ):
        """
        사용자 질의 로그 저장

        Args:
            user_query: 사용자 질문
            difficulty_mode: 'easy' 또는 'hard'
            tool_used: 사용된 도구명
            response: 생성된 응답
            response_time_ms: 응답 시간 (밀리초)
            success: 성공 여부
            error_message: 오류 메시지 (있는 경우)
        """
        cursor = self.conn.cursor()

        try:
            cursor.execute("""
                INSERT INTO query_logs
                (user_query, difficulty_mode, tool_used, response,
                 response_time_ms, success, error_message)
                VALUES (%s, %s, %s, %s, %s, %s, %s)
            """, (
                user_query,
                difficulty_mode,
                tool_used,
                response,
                response_time_ms,
                success,
                error_message
            ))

            self.conn.commit()

        except Exception as e:
            self.conn.rollback()
            print(f"로그 저장 실패: {e}")

        finally:
            cursor.close()

    def get_statistics(self, days: int = 7):
        """
        최근 N일간 통계 조회

        Args:
            days: 조회 기간 (일)

        Returns:
            dict: 통계 정보
        """
        cursor = self.conn.cursor()

        try:
            # 전체 쿼리 수
            cursor.execute("""
                SELECT COUNT(*)
                FROM query_logs
                WHERE created_at >= NOW() - INTERVAL '%s days'
            """, (days,))
            total_queries = cursor.fetchone()[0]

            # 평균 응답 시간
            cursor.execute("""
                SELECT AVG(response_time_ms)
                FROM query_logs
                WHERE created_at >= NOW() - INTERVAL '%s days'
            """, (days,))
            avg_response_time = cursor.fetchone()[0]

            # 도구별 사용 횟수
            cursor.execute("""
                SELECT tool_used, COUNT(*)
                FROM query_logs
                WHERE created_at >= NOW() - INTERVAL '%s days'
                GROUP BY tool_used
                ORDER BY COUNT(*) DESC
            """, (days,))
            tool_usage = cursor.fetchall()

            # 성공률
            cursor.execute("""
                SELECT
                    COUNT(*) FILTER (WHERE success = TRUE) * 100.0 / COUNT(*)
                FROM query_logs
                WHERE created_at >= NOW() - INTERVAL '%s days'
            """, (days,))
            success_rate = cursor.fetchone()[0]

            return {
                'total_queries': total_queries,
                'avg_response_time_ms': avg_response_time,
                'tool_usage': tool_usage,
                'success_rate': success_rate
            }

        finally:
            cursor.close()

    def close(self):
        """연결 종료"""
        if self.conn:
            self.conn.close()

    def __del__(self):
        """소멸자"""
        self.close()
```

#### 2.3 AI Agent와 통합

**파일 경로**: `src/agent/graph.py` (최현화와 협업)

```python
from src.utils.query_logger import QueryLogger
import time

def create_agent_with_logging():
    """로깅 기능이 통합된 Agent 생성"""

    query_logger = QueryLogger()

    def logged_agent_invoke(question: str, difficulty: str):
        """로깅이 포함된 Agent 실행"""
        start_time = time.time()

        try:
            # Agent 실행
            result = agent_executor.invoke({
                "question": question,
                "difficulty": difficulty
            })

            # 응답 시간 계산
            response_time_ms = int((time.time() - start_time) * 1000)

            # 로그 저장
            query_logger.log_query(
                user_query=question,
                difficulty_mode=difficulty,
                tool_used=result.get("tool_used", "unknown"),
                response=result.get("final_answer", ""),
                response_time_ms=response_time_ms,
                success=True
            )

            return result

        except Exception as e:
            # 오류 로그 저장
            response_time_ms = int((time.time() - start_time) * 1000)

            query_logger.log_query(
                user_query=question,
                difficulty_mode=difficulty,
                tool_used="error",
                response="",
                response_time_ms=response_time_ms,
                success=False,
                error_message=str(e)
            )

            raise

    return logged_agent_invoke
```

---

### 3. 실험 폴더 구조 관리

#### 3.1 폴더 구조 규칙

모든 실험 결과물은 다음 구조로 저장:

```
experiments/
└── 20251030/                              # 날짜 (YYYYMMDD)
    ├── 20251030_143052_rag_vectordb_build/
    │   ├── experiment.log                 # 로그 파일
    │   ├── config.yaml                    # 실험 설정
    │   ├── results.json                   # 실험 결과
    │   └── vectordb/                      # VectorDB 결과
    │
    └── 20251030_150823_agent_execution/
        ├── experiment.log
        ├── config.yaml
        └── responses.json
```

#### 3.2 ExperimentManager 클래스

**파일 경로**: `src/utils/experiment_manager.py`

```python
import os
import yaml
import json
from datetime import datetime
from pathlib import Path
from src.utils.logger import Logger


class ExperimentManager:
    """
    실험 폴더 생성 및 관리 클래스
    """

    def __init__(self, experiment_name: str):
        """
        실험 매니저 초기화

        Args:
            experiment_name: 실험명 (예: "rag_vectordb_build")
        """
        # 날짜와 시간 생성
        today = datetime.now().strftime("%Y%m%d")
        time_now = datetime.now().strftime("%H%M%S")

        # 실험 폴더 경로
        self.experiment_dir = Path(f"experiments/{today}/{today}_{time_now}_{experiment_name}")
        self.experiment_dir.mkdir(parents=True, exist_ok=True)

        # Logger 생성
        self.logger = Logger(
            log_path=str(self.experiment_dir / "experiment.log"),
            print_also=True
        )

        self.logger.write("=" * 50)
        self.logger.write(f"실험 시작: {experiment_name}")
        self.logger.write(f"실험 폴더: {self.experiment_dir}")
        self.logger.write("=" * 50)

    def save_config(self, config: dict):
        """
        실험 설정 저장

        Args:
            config: 설정 딕셔너리
        """
        config_path = self.experiment_dir / "config.yaml"

        with open(config_path, 'w', encoding='utf-8') as f:
            yaml.dump(config, f, allow_unicode=True)

        self.logger.write(f"설정 파일 저장: {config_path}")

    def save_results(self, results: dict):
        """
        실험 결과 저장

        Args:
            results: 결과 딕셔너리
        """
        results_path = self.experiment_dir / "results.json"

        with open(results_path, 'w', encoding='utf-8') as f:
            json.dump(results, f, ensure_ascii=False, indent=2)

        self.logger.write(f"결과 파일 저장: {results_path}")

    def get_output_dir(self, subdir: str = None) -> Path:
        """
        출력 디렉토리 경로 반환

        Args:
            subdir: 서브 디렉토리명 (예: "vectordb")

        Returns:
            Path: 출력 디렉토리 경로
        """
        if subdir:
            output_dir = self.experiment_dir / subdir
            output_dir.mkdir(exist_ok=True)
            return output_dir

        return self.experiment_dir

    def close(self):
        """실험 종료"""
        self.logger.write("=" * 50)
        self.logger.write("실험 종료")
        self.logger.write("=" * 50)
        self.logger.close()
```

#### 3.3 사용 예시

```python
from src.utils.experiment_manager import ExperimentManager

# 실험 시작
exp = ExperimentManager("rag_vectordb_build")

# 설정 저장
config = {
    'model': 'gpt-4',
    'temperature': 0.7,
    'chunk_size': 1000
}
exp.save_config(config)

# 실험 로직
exp.logger.write("VectorDB 구축 시작...")
# ... 실험 코드 ...

# 결과 저장
results = {
    'total_documents': 100,
    'total_chunks': 500,
    'execution_time': 120.5
}
exp.save_results(results)

# 실험 종료
exp.close()
```

---

## 참고 PRD 문서

아래 PRD 문서들을 참고하여 구현하세요:

1. **[05_로깅_시스템.md](../PRD/05_로깅_시스템.md)** ⭐⭐⭐
   - Logger 클래스 상세 명세
   - 로깅 정책 및 규칙
   - 사용 예시

2. **[06_실험_추적_관리.md](../PRD/06_실험_추적_관리.md)** ⭐⭐⭐
   - 실험 폴더 구조
   - 명명 규칙
   - 필수 파일

3. **[11_데이터베이스_설계.md](../PRD/11_데이터베이스_설계.md)** ⭐⭐
   - query_logs 테이블 스키마
   - 인덱스 설계
   - 백업 및 복구

---

## 협업 방법

### 다른 담당자와의 협업

#### 1. 박재홍 (논문데이터수집) - 데이터베이스 초기화
- **협업 내용**: query_logs 테이블 스키마를 `database/schema.sql`에 추가
- **타이밍**: 박재홍이 DB 초기 설정 시 함께 실행
- **전달 사항**: query_logs 테이블 CREATE 문 및 인덱스

#### 2. 최현화 (AI Agent 메인) - Agent 로깅 통합
- **협업 내용**: Agent 실행 시 QueryLogger로 로그 기록
- **타이밍**: Agent graph 구현 완료 후
- **전달 사항**: QueryLogger 클래스 사용법, logged_agent_invoke 함수

#### 3. 전체 팀원 - Logger 클래스 사용
- **협업 내용**: 모든 실험 및 개발 시 Logger 사용
- **타이밍**: Logger 구현 완료 즉시
- **전달 사항**: Logger 사용법 문서화, 예시 코드

---

## 구현 체크리스트

### Phase 1: Logger 클래스 구현 (우선순위 1)
- [ ] `src/utils/logger.py` 파일 생성
- [ ] Logger 클래스 구현
  - [ ] `__init__()` - 파일 열기, 폴더 생성
  - [ ] `write()` - 타임스탬프 추가, 파일/콘솔 출력
  - [ ] `start_redirect()`, `stop_redirect()` - 표준 출력 리디렉션
  - [ ] `tqdm_redirect()` - tqdm 통합
  - [ ] `flush()`, `close()` - 파일 관리
- [ ] 테스트 스크립트 작성 및 검증
- [ ] 사용법 문서화 및 팀원 공유

### Phase 2: query_logs 테이블 구현 (우선순위 2)
- [ ] `database/schema.sql`에 query_logs 테이블 추가
- [ ] 인덱스 생성
- [ ] `src/utils/query_logger.py` 파일 생성
- [ ] QueryLogger 클래스 구현
  - [ ] `log_query()` - 로그 저장
  - [ ] `get_statistics()` - 통계 조회
- [ ] 최현화와 협업하여 Agent에 통합
- [ ] 테스트 및 검증

### Phase 3: 실험 관리 (우선순위 3)
- [ ] `src/utils/experiment_manager.py` 파일 생성
- [ ] ExperimentManager 클래스 구현
  - [ ] 실험 폴더 자동 생성
  - [ ] config.yaml, results.json 저장
- [ ] 사용 예시 작성
- [ ] 팀원 교육

### Phase 4: 문서화 및 테스트 (지속)
- [ ] README.md 업데이트 (Logger 사용법)
- [ ] 샘플 코드 작성
- [ ] 단위 테스트 작성
- [ ] 통합 테스트

---

## 규칙 및 주의사항

### 1. 로깅 규칙
- **모든 실험은 Logger를 사용하여 기록**
- `print()` 사용 금지 → `logger.write()` 사용
- 로그 파일은 `experiments/날짜/날짜_시간_실험명/` 구조로 저장

### 2. 실험명 명명 규칙

| 카테고리 | 형식 | 예시 |
|----------|------|------|
| 기능 개발 | `feature_<기능명>` | `feature_web_search_tool` |
| RAG 실험 | `rag_<내용>` | `rag_vectordb_build` |
| Agent 실험 | `agent_<내용>` | `agent_tool_calling` |
| 평가 | `eval_<대상>` | `eval_chatbot_accuracy` |
| 디버깅 | `debug_<문제>` | `debug_memory_leak` |

### 3. 코드 품질
- 모든 클래스와 함수에 docstring 작성
- 타입 힌팅 사용 (Python 3.10+)
- 에러 처리 철저히 (try-except)
- 리소스 자동 정리 (`__del__`, `close()`)

### 4. 테스트
- 단위 테스트 작성 (`tests/utils/test_logger.py`)
- Logger 클래스는 프로젝트 전체에서 사용되므로 철저한 테스트 필요
- PostgreSQL 연결 실패 시 처리 로직 포함

### 5. 성능 고려사항
- 로그 파일은 버퍼링 사용 (`flush()` 적절히 호출)
- query_logs 테이블에 인덱스 적용으로 조회 성능 보장
- 대용량 로그 시 파일 크기 관리 (선택사항)

---

## 예상 결과물

### 1. 파일 구조

```
src/
└── utils/
    ├── logger.py              # Logger 클래스
    ├── query_logger.py        # QueryLogger 클래스
    └── experiment_manager.py  # ExperimentManager 클래스

database/
└── schema.sql                 # query_logs 테이블 포함

tests/
└── utils/
    ├── test_logger.py
    ├── test_query_logger.py
    └── test_experiment_manager.py

experiments/                   # 실험 결과 폴더
└── 20251030/
    └── 20251030_143052_rag_vectordb_build/
        ├── experiment.log
        ├── config.yaml
        └── results.json
```

### 2. 사용 예시

**Logger 클래스:**
```python
from src.utils.logger import Logger

logger = Logger("experiments/20251030/test.log")
logger.write("테스트 시작")
logger.close()
```

**QueryLogger 클래스:**
```python
from src.utils.query_logger import QueryLogger

query_logger = QueryLogger()
query_logger.log_query(
    user_query="RAG에 대해 알려줘",
    difficulty_mode="easy",
    tool_used="search_paper",
    response="RAG는...",
    response_time_ms=1500
)
```

**ExperimentManager 클래스:**
```python
from src.utils.experiment_manager import ExperimentManager

exp = ExperimentManager("my_experiment")
exp.save_config({'model': 'gpt-4'})
exp.logger.write("실험 진행 중...")
exp.save_results({'accuracy': 0.95})
exp.close()
```
