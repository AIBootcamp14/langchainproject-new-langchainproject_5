# test_agent_system.py 사용법

## 개요

Phase 1: 기반 시스템 통합 테스트 스크립트입니다.

**목적**: LLM 클라이언트, AgentState, Agent 그래프의 기본 기능을 검증합니다.

**위치**: `tests/integration/test_agent_system.py`

**관련 브랜치**: `feature/agent-system`

---

## 실행 방법

### 1. 기본 실행

```bash
python tests/integration/test_agent_system.py
```

### 2. pytest를 통한 실행

```bash
pytest tests/integration/test_agent_system.py -v
```

---

## 사전 요구사항

### 환경 변수 설정

테스트를 완전히 통과하려면 다음 환경 변수가 필요합니다:

```bash
# .env 파일
OPENAI_API_KEY=your_openai_api_key
SOLAR_API_KEY=your_SOLAR_API_KEY
```

**참고**: 환경 변수가 설정되지 않아도 Agent 그래프 구조 검증은 가능합니다.

---

## 테스트 항목

### 1. LLM 클라이언트 테스트

#### 테스트 내용
- **OpenAI 클라이언트 초기화**:
  - `ChatOpenAI` 인스턴스 생성
  - API 키 연결 확인

- **Solar 클라이언트 초기화**:
  - `ChatUpstage` 인스턴스 생성
  - Upstage API 키 연결 확인

- **get_llm_for_task() 함수**:
  - 작업 유형별 LLM 선택 검증
  - `routing`: Solar (빠른 응답)
  - `generation`: GPT-4 (높은 정확도)
  - `summarization`: GPT-4 (품질 중요)

#### 예상 결과
```
[1-1] OpenAI 클라이언트 초기화 테스트...
✅ OpenAI 클라이언트 초기화 성공

[1-2] Solar 클라이언트 초기화 테스트...
✅ Solar 클라이언트 초기화 성공

[1-3] get_llm_for_task() 함수 테스트...
✅ get_llm_for_task() 함수 정상 작동
```

### 2. Agent 그래프 컴파일 테스트

#### 테스트 내용
- **Agent 그래프 생성**:
  - `create_agent_graph()` 함수 호출
  - LangGraph StateGraph 컴파일 성공 여부

- **그래프 구조 확인**:
  - 그래프 객체 정상 생성
  - None이 아닌 유효한 객체 반환

#### 예상 결과
```
[2-1] Agent 그래프 생성 테스트...
✅ Agent 그래프 생성 및 컴파일 성공

[2-2] 그래프 구조 확인...
✅ 그래프 객체 정상 생성
```

### 3. 라우터 노드 테스트

#### 테스트 내용
- **도구 선택 로직 검증**:
  - 질문 분석 및 적절한 도구 선택
  - 라우터 → 도구 노드 조건부 분기

#### 테스트 케이스

| 질문 | 예상 도구 | 난이도 |
|------|----------|--------|
| "Transformer 논문에 대해 알려줘" | `search_paper` 또는 `general` | easy |
| "안녕하세요" | `general` | easy |

#### 예상 결과
```
[3-1] Agent 그래프 생성...
✅ Agent 그래프 생성 성공

[3-2] 테스트 케이스 1: Transformer 논문에 대해 알려줘
   선택된 도구: search_paper
   ✅ 예상 도구 중 하나 선택됨
   최종 답변: RAG 검색 노드 (구현 예정)...
   ✅ 테스트 케이스 1 통과

[3-3] 테스트 케이스 2: 안녕하세요
   선택된 도구: general
   ✅ 예상 도구 중 하나 선택됨
   최종 답변: 일반 답변 노드 (구현 예정)...
   ✅ 테스트 케이스 2 통과
```

---

## 전체 테스트 결과

### API 키가 설정된 경우

```
============================================================
Phase 1: 기반 시스템 테스트 시작
============================================================

[환경변수 확인]
✅ OPENAI_API_KEY 설정됨
✅ SOLAR_API_KEY 설정됨

============================================================
테스트 1: LLM 클라이언트
============================================================
✅ LLM 클라이언트 테스트 통과

============================================================
테스트 2: Agent 그래프 컴파일
============================================================
✅ Agent 그래프 컴파일 테스트 통과

============================================================
테스트 3: 라우터 노드 (도구 선택 로직)
============================================================
✅ 라우터 노드 테스트 통과

============================================================
테스트 결과 요약
============================================================
LLM 클라이언트: ✅ 통과
Agent 그래프 컴파일: ✅ 통과
라우터 노드: ✅ 통과

============================================================
🎉 모든 테스트 통과!
============================================================
```

### API 키가 없는 경우

```
============================================================
Phase 1: 기반 시스템 테스트 시작
============================================================

[환경변수 확인]
❌ OPENAI_API_KEY 미설정
⚠️  SOLAR_API_KEY 미설정 (Solar 테스트 제한)

============================================================
테스트 1: LLM 클라이언트
============================================================
❌ OpenAI 클라이언트 초기화 실패: The api_key client option must be set...

============================================================
테스트 2: Agent 그래프 컴파일
============================================================
✅ Agent 그래프 컴파일 테스트 통과

============================================================
테스트 3: 라우터 노드 (도구 선택 로직)
============================================================
✅ 라우터 노드 테스트 통과

============================================================
테스트 결과 요약
============================================================
LLM 클라이언트: ❌ 실패
Agent 그래프 컴파일: ✅ 통과
라우터 노드: ✅ 통과

============================================================
⚠️  일부 테스트 실패
============================================================
```

---

## 주의 사항

1. **API 키 미설정 시**:
   - LLM 클라이언트 테스트는 실패
   - 그래프 구조 검증은 정상 작동
   - 실제 LLM 호출 없이 구조만 확인 가능

2. **브랜치 확인**:
   - `feature/agent-system` 브랜치에서 실행
   - 다른 브랜치에서는 파일이 없을 수 있음

3. **의존성 패키지**:
   - `langchain-openai>=0.3.35`
   - `langchain-upstage>=0.7.4`
   - `langgraph>=1.0.1`
   - `langchain-community>=0.3.31`
   - `langchain-core>=0.3.78`

4. **실행 위치**:
   - 프로젝트 루트 디렉토리에서 실행 권장

---

## 관련 파일

- `src/llm/client.py`: LLM 클라이언트 구현
- `src/agent/state.py`: AgentState 정의
- `src/agent/nodes.py`: Agent 노드 함수
- `src/agent/graph.py`: Agent 그래프 구성
