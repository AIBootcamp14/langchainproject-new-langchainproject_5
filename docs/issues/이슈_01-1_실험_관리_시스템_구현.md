## 제목 : 실험 관리 시스템 구현 (ExperimentManager + Session ID 자동 부여)

---

## 📋 작업 개요
**작업 주제:** ExperimentManager 클래스 기반 실험 폴더 구조 및 자동 추적 시스템 개발
**담당자:** @최현화
**마감일:** 10/31 24:00

## 📅 기간
- 시작일: 2025-10-31
- 종료일: 2025-10-31


---

## 📌 이슈 목적

챗봇 실행마다 체계적인 실험 관리를 위한 ExperimentManager 클래스를 구현합니다. Session ID 자동 부여, 7개 서브 폴더 구조, metadata.json 기반 추적, 평가 지표 저장 기능을 개발하여 모든 실험 데이터를 체계적으로 기록하고 분석할 수 있는 시스템을 구축합니다.

**핵심 목표:**
- ExperimentManager 클래스 구현 (with 문 지원)
- Session ID 자동 부여 시스템 (날짜별 session_001, 002...)
- 7개 서브 폴더 자동 생성 (tools, database, prompts, ui, outputs, evaluation, debug)
- metadata.json 기반 실험 추적
- RAG 평가 지표, Agent 정확도, 응답 시간, 비용 분석 저장
- 실험 검색 및 집계 스크립트 개발

---

## ✅ 작업 항목 체크리스트

### Phase 1: ExperimentManager 기본 구현 (2일)
- [ ] ExperimentManager 클래스 구현 (`src/utils/experiment_manager.py`)
  - [ ] `__init__()` 메서드 구현
    - [ ] 날짜/시간 기반 폴더명 생성 (YYYYMMDD_HHMMSS)
    - [ ] Session ID 자동 부여 (_get_next_session_id)
    - [ ] 메인 폴더 생성 (experiments/날짜/날짜_시간_session_XXX/)
    - [ ] 7개 서브 폴더 생성 (tools, database, prompts, ui, outputs, evaluation, debug)
  - [ ] `__enter__()` 및 `__exit__()` 메서드 구현 (with 문 지원)
  - [ ] Logger 초기화 (chatbot.log)
  - [ ] metadata.json 생성 및 초기화
- [ ] Session ID 자동 부여 로직
  - [ ] 당일 기존 세션 폴더 검색
  - [ ] 최대 session_XXX 번호 추출
  - [ ] 다음 번호 자동 할당 (session_001, 002...)
  - [ ] 날짜 변경 시 session_001로 초기화

### Phase 2: 도구별 Logger 및 데이터 저장 (2일)
- [ ] 도구별 Logger 생성 메서드
  - [ ] `get_tool_logger(tool_name)` 구현
    - [ ] tools/ 폴더에 도구별 로그 파일 생성
    - [ ] rag_paper.log, web_search.log, glossary.log 등
  - [ ] Logger 인스턴스 캐싱 (중복 생성 방지)
- [ ] DB 쿼리 저장 메서드
  - [ ] `save_db_query(query, results)` 구현
    - [ ] database/queries.json에 쿼리 및 결과 저장
    - [ ] 타임스탬프 및 쿼리 타입 기록
- [ ] 프롬프트 저장 메서드
  - [ ] `save_prompt(prompt_type, content)` 구현
    - [ ] prompts/ 폴더에 프롬프트별 txt 파일 저장
    - [ ] system_prompt.txt, user_prompt.txt, rag_prompt.txt 등

### Phase 3: UI 및 평가 지표 저장 (2일)
- [ ] UI 상호작용 저장 메서드
  - [ ] `save_ui_interaction(interaction_data)` 구현
    - [ ] ui/interactions.json에 사용자 질문 및 난이도 저장
    - [ ] 대화 턴 번호, 타임스탬프 기록
- [ ] 평가 지표 저장 메서드 (5개)
  - [ ] `save_rag_metrics(metrics)` 구현
    - [ ] evaluation/rag_metrics.json 저장
    - [ ] Recall@K, Precision@K, Faithfulness 기록
  - [ ] `save_agent_accuracy(accuracy_data)` 구현
    - [ ] evaluation/agent_accuracy.json 저장
    - [ ] 도구 선택 정확도, 성공/실패율 기록
  - [ ] `save_latency_report(latency_data)` 구현
    - [ ] evaluation/latency_report.json 저장
    - [ ] p50, p95, p99 응답 시간 기록
  - [ ] `save_cost_analysis(cost_data)` 구현
    - [ ] evaluation/cost_analysis.json 저장
    - [ ] 토큰 사용량, USD/KRW 비용 기록
  - [ ] `save_test_results(test_data)` 구현
    - [ ] evaluation/test_results.json 저장
    - [ ] 테스트 시나리오별 결과 기록

### Phase 4: 출력 및 메타데이터 관리 (1일)
- [ ] 최종 답변 저장 메서드
  - [ ] `save_final_response(response)` 구현
    - [ ] outputs/response.txt 저장
    - [ ] 질문, 난이도, 답변, 사용 도구 기록
- [ ] 메타데이터 업데이트 메서드
  - [ ] `update_metadata(key, value)` 구현
    - [ ] metadata.json 동적 업데이트
    - [ ] 실험 진행 상황 반영
  - [ ] `_save_final_metadata()` 구현
    - [ ] 실험 종료 시 최종 메타데이터 저장
    - [ ] end_time, status 업데이트
- [ ] 경로 반환 메서드
  - [ ] `get_experiment_dir()` 구현
  - [ ] `get_tools_dir()`, `get_database_dir()` 등 구현

### Phase 5: 실험 검색 및 집계 스크립트 (1일)
- [ ] 실험 검색 스크립트 (`scripts/find_experiments.py`)
  - [ ] metadata.json 기반 검색 함수
  - [ ] 필터링 옵션: 난이도, 사용 도구, 날짜, 응답 시간
  - [ ] 검색 결과 출력 (경로, 메타데이터 요약)
- [ ] 평가 지표 집계 스크립트 (`scripts/aggregate_metrics.py`)
  - [ ] 여러 실험의 evaluation/ 폴더 데이터 수집
  - [ ] 평균, 최소, 최대값 계산
  - [ ] CSV/JSON 형식으로 결과 저장
  - [ ] 시각화 옵션 (matplotlib)

### Phase 6: 통합 테스트 및 문서화 (1일)
- [ ] 단위 테스트 작성 (`tests/test_experiment_manager.py`)
  - [ ] Session ID 자동 부여 테스트
  - [ ] 폴더 구조 생성 테스트
  - [ ] metadata.json 업데이트 테스트
  - [ ] 평가 지표 저장 테스트
  - [ ] with 문 컨텍스트 매니저 테스트
- [ ] 통합 테스트
  - [ ] Agent + ExperimentManager 통합 실행
  - [ ] 7개 서브 폴더에 데이터 정상 저장 확인
  - [ ] 검색 스크립트로 실험 조회 테스트
- [ ] 사용 예시 문서 작성
  - [ ] README에 ExperimentManager 사용법 추가
  - [ ] 7가지 사용 예시 코드 포함

---

## 📦 설치/실행 명령어 예시

```bash
# 가상환경 활성화
source .venv/bin/activate

# 필요한 패키지 설치 (기본 패키지에 포함)
pip install pathlib

# ExperimentManager 단독 테스트
python src/utils/experiment_manager.py

# Agent와 통합 실행 테스트
python src/agent/graph.py

# 실험 검색 스크립트 실행
python scripts/find_experiments.py --difficulty Easy --tool rag_paper

# 평가 지표 집계 스크립트 실행
python scripts/aggregate_metrics.py --date 20251031 --output results.csv

# 단위 테스트 실행
pytest tests/test_experiment_manager.py -v
```

---

### ⚡️ 참고

**중요 사항:**
1. **Session ID 규칙**: 날짜별로 session_001부터 시작, 자동 증가
2. **폴더 구조**: 7개 서브 폴더 필수 생성 (tools, database, prompts, ui, outputs, evaluation, debug)
3. **metadata.json**: 실험 시작 시 생성, 종료 시 최종 업데이트
4. **with 문 지원**: `with ExperimentManager() as exp:` 형태로 사용
5. **Logger 통합**: 모든 로그는 ExperimentManager의 logger 사용
6. **평가 지표**: 5개 JSON 파일에 평가 결과 저장 (rag_metrics, agent_accuracy, latency_report, cost_analysis, test_results)

**폴더 구조 예시:**
```
experiments/20251031/
└── 20251031_103015_session_001/
    ├── metadata.json                 # 실험 메타데이터
    ├── chatbot.log                   # 메인 로그
    ├── tools/                        # 도구별 로그
    │   ├── rag_paper.log
    │   ├── web_search.log
    │   └── glossary.log
    ├── database/                     # DB 쿼리 기록
    │   └── queries.json
    ├── prompts/                      # 프롬프트 저장
    │   ├── system_prompt.txt
    │   ├── user_prompt.txt
    │   └── rag_prompt.txt
    ├── ui/                           # UI 상호작용 기록
    │   └── interactions.json
    ├── outputs/                      # 최종 답변
    │   └── response.txt
    ├── evaluation/                   # 평가 지표
    │   ├── rag_metrics.json
    │   ├── agent_accuracy.json
    │   ├── latency_report.json
    │   ├── cost_analysis.json
    │   └── test_results.json
    └── debug/                        # 디버그 정보
        └── error.log
```

**metadata.json 구조:**
```json
{
  "session_id": "session_001",
  "date": "20251031",
  "start_time": "2025-10-31 10:30:15",
  "end_time": "2025-10-31 10:35:42",
  "difficulty": "Easy",
  "question": "RAG에 대해 알려줘",
  "tool_used": "rag_paper",
  "status": "completed",
  "response_time_sec": 327.5,
  "token_usage": {
    "prompt_tokens": 1250,
    "completion_tokens": 890,
    "total_tokens": 2140
  },
  "cost_usd": 0.0214,
  "cost_krw": 28.62
}
```

**주의:**
- Session ID는 항상 3자리 숫자로 포맷팅 (001, 002, ..., 099)
- 100개를 넘어가면 자동으로 자릿수 증가
- 날짜가 바뀌면 session_001로 다시 시작
- metadata.json은 항상 UTF-8 인코딩으로 저장
- with 블록 종료 시 자동으로 Logger 종료 및 metadata 업데이트

---

### 유용한 링크

**필수 참고 PRD 문서:**
- [docs/PRD/01_프로젝트_개요.md](../PRD/01_프로젝트_개요.md) - 프로젝트 전체 개요
- [docs/PRD/02_프로젝트_구조.md](../PRD/02_프로젝트_구조.md) - 폴더 구조 (src/utils/)
- [docs/PRD/05_로깅_시스템.md](../PRD/05_로깅_시스템.md) ⭐ - Logger 클래스 사용법 및 ExperimentManager 통합
- [docs/PRD/06_실험_추적_관리.md](../PRD/06_실험_추적_관리.md) ⭐ - 실험 폴더 구조 및 Session ID 규칙
- [docs/PRD/09_평가_기준.md](../PRD/09_평가_기준.md) - 평가 지표 정의 (RAG, Agent, Latency, Cost)
- [docs/PRD/10_기술_요구사항.md](../PRD/10_기술_요구사항.md) - 기술 스택

**필수 참고 역할 문서:**
- [docs/roles/담당역할_01-1_최현화_실험_관리_시스템.md](../roles/담당역할_01-1_최현화_실험_관리_시스템.md) ⭐⭐⭐ - ExperimentManager 전체 구현 코드 및 사용 예시

**필수 참고 레퍼런스 문서:**
- [docs/references/실험_폴더_구조_최종안.md](../references/실험_폴더_구조_최종안.md) ⭐ - 7개 서브 폴더 구조 및 ExperimentManager 전체 코드

**참고 PRD 문서:**
- [docs/PRD/03_브랜치_전략.md](../PRD/03_브랜치_전략.md) - Feature 브랜치 전략
- [docs/PRD/04_일정_관리.md](../PRD/04_일정_관리.md) - 개발 일정 및 마일스톤
- [docs/PRD/12_AI_Agent_설계.md](../PRD/12_AI_Agent_설계.md) - Agent와 통합 방법

**외부 링크:**
- [Python pathlib 문서](https://docs.python.org/3/library/pathlib.html)
- [Python Context Managers](https://docs.python.org/3/reference/datamodel.html#context-managers)
- [JSON 파일 다루기](https://docs.python.org/3/library/json.html)

## 🔖 추천 라벨

`feature` `evaluation` `config` `pipeline` `documentation` `high`

---
