# PostgreSQL + pgvector 데이터베이스 설치 및 설정 가이드

## 문서 정보
- **작성일**: 2025-11-01
- **프로젝트명**: 논문 리뷰 챗봇 (AI Agent + RAG)
- **팀명**: 연결의 민족
- **목적**: PostgreSQL + pgvector 데이터베이스 설치 및 설정 실행 가이드

---

## 목차
1. [개요](#1-개요)
2. [필수 패키지 설치](#2-필수-패키지-설치)
3. [PostgreSQL 설치 및 설정](#3-postgresql-설치-및-설정)
4. [pgvector Extension 설치](#4-pgvector-extension-설치)
5. [환경 변수 설정](#5-환경-변수-설정)
6. [데이터베이스 생성](#6-데이터베이스-생성)
7. [스키마 생성](#7-스키마-생성)
8. [연결 및 테스트](#8-연결-및-테스트)
9. [백업 및 복구](#9-백업-및-복구)
10. [트러블슈팅](#10-트러블슈팅)

---

## 1. 개요

### 1.1 PostgreSQL + pgvector란?

**PostgreSQL**은 강력한 오픈소스 관계형 데이터베이스입니다.
**pgvector**는 PostgreSQL에서 벡터 임베딩을 저장하고 유사도 검색을 수행할 수 있게 해주는 확장 기능입니다.

### 1.2 왜 통합 솔루션인가?

기존에는 관계형 데이터(논문 메타데이터)와 벡터 데이터(임베딩)를 별도의 DB에 저장했습니다:
- **관계형 데이터**: PostgreSQL
- **벡터 데이터**: Chroma, Pinecone, Qdrant 등

**통합 솔루션의 장점**:
- 하나의 DB에서 관계형 + 벡터 검색 모두 처리
- 운영 및 유지보수 간소화
- 트랜잭션 일관성 보장
- Langchain과 완벽한 통합

### 1.3 프로젝트 데이터 구조

```
PostgreSQL (papers DB)
├── papers 테이블 (관계형)             # 논문 메타데이터
├── glossary 테이블 (관계형)           # 용어집
├── query_logs 테이블 (관계형)         # 사용자 질의 로그
├── paper_chunks (pgvector)          # 논문 본문 청크 임베딩
├── paper_abstracts (pgvector)       # 논문 초록 임베딩
└── glossary_embeddings (pgvector)   # 용어집 임베딩
```

---

## 2. 필수 패키지 설치

### 2.1 requirements.txt 업데이트

프로젝트 루트의 `requirements.txt` 파일에 다음 패키지를 추가합니다:

```txt
# ------------------------- PostgreSQL 및 pgvector ------------------------- #
psycopg2-binary==2.9.9                # PostgreSQL 어댑터
pgvector==0.2.3                       # pgvector Python 클라이언트

# ------------------------- Langchain PostgreSQL ------------------------- #
langchain-postgres==0.0.1             # Langchain PostgreSQL 통합

# ------------------------- Database 유틸리티 ------------------------- #
python-dotenv==1.0.0                  # 환경 변수 관리
```

### 2.2 pip 설치 명령어

```bash
# ------------------------- 가상 환경 활성화 ------------------------- #
# 방식 1
source venv/bin/activate              # Linux/Mac
# venv\Scripts\activate               # Windows

# 방식 2
pyenv activate langchain_py3_11_9

# ------------------------- 패키지 설치 ------------------------- #
pip install -r requirements.txt

# 또는 개별 설치
pip install psycopg2-binary==2.9.9
pip install pgvector==0.2.3
pip install langchain-postgres==0.0.1
pip install python-dotenv==1.0.0
```

### 2.3 설치 확인

```bash
# Python에서 import 테스트
python -c "import psycopg2; print('psycopg2 설치 완료')"
python -c "import pgvector; print('pgvector 설치 완료')"
```

---

## 3. PostgreSQL 설치 및 설정

### 3.1 PostgreSQL 15+ 설치

#### Linux (Ubuntu/Debian)

```bash
# ---------------------- PostgreSQL 패키지 저장소 추가 ---------------------- #
sudo sh -c 'echo "deb http://apt.postgresql.org/pub/repos/apt $(lsb_release -cs)-pgdg main" > /etc/apt/sources.list.d/pgdg.list'
wget --quiet -O - https://www.postgresql.org/media/keys/ACCC4CF8.asc | sudo apt-key add -

# ---------------------- 패키지 업데이트 및 설치 ---------------------- #
sudo apt update
sudo apt install postgresql-15 postgresql-contrib-15

# ---------------------- PostgreSQL 서비스 시작 ---------------------- #
sudo systemctl start postgresql
sudo systemctl enable postgresql          # 부팅 시 자동 시작

# ---------------------- 설치 확인 ---------------------- #
psql --version                            # PostgreSQL 버전 확인
```

#### macOS (Homebrew)

```bash
# ---------------------- Homebrew로 PostgreSQL 설치 ---------------------- #
brew install postgresql@15

# ---------------------- PostgreSQL 서비스 시작 ---------------------- #
brew services start postgresql@15

# ---------------------- 설치 확인 ---------------------- #
psql --version
```

#### Windows

1. [PostgreSQL 공식 사이트](https://www.postgresql.org/download/windows/) 접속
2. Windows용 설치 프로그램 다운로드
3. 설치 마법사 실행
4. 설치 경로 및 비밀번호 설정
5. Port 5432 (기본값) 사용

### 3.2 PostgreSQL 사용자 생성 및 설정

**중요**: 이 단계는 반드시 먼저 완료해야 합니다!

```bash
# ---------------------- postgres 사용자로 접속 ---------------------- #
sudo -u postgres psql

# ---------------------- langchain 사용자 생성 ---------------------- #
# .env 파일의 POSTGRES_USER, POSTGRES_PASSWORD와 동일하게 설정
CREATE USER langchain WITH PASSWORD 'dusrufdmlalswhr';

# ---------------------- 데이터베이스 생성 권한 부여 ---------------------- #
ALTER USER langchain CREATEDB;

# ---------------------- 슈퍼유저 권한 부여 (개발 환경) ---------------------- #
ALTER USER langchain WITH SUPERUSER;

# ---------------------- 사용자 생성 확인 ---------------------- #
\du

# ---------------------- 출력 예시 ---------------------- #
#                                   List of roles
#  Role name |                         Attributes
# -----------+------------------------------------------------------------
#  langchain | Superuser, Create DB
#  postgres  | Superuser, Create role, Create DB, Replication, Bypass RLS

# ---------------------- 종료 ---------------------- #
\q
```

**확인**: langchain 사용자가 목록에 나타나야 합니다.

### 3.3 비밀번호 자동 인증 설정 (~/.pgpass)

이 설정을 완료하면 이후 모든 psql 명령어에서 `-h localhost`와 비밀번호 입력 없이 간편하게 접속할 수 있습니다.

```bash
# ---------------------- ~/.pgpass 파일 생성 ---------------------- #
cat > ~/.pgpass << 'EOF'
localhost:5432:*:langchain:dusrufdmlalswhr
EOF

# ---------------------- 파일 권한 설정 (필수!) ---------------------- #
chmod 600 ~/.pgpass

# ---------------------- 설정 확인 ---------------------- #
ls -la ~/.pgpass

# ---------------------- 출력 예시 ---------------------- #
# -rw------- 1 ieyeppo ieyeppo 44 Nov  1 12:00 /home/ieyeppo/.pgpass
```

**~/.pgpass 파일 형식**: `호스트:포트:데이터베이스:사용자명:비밀번호`
- `localhost:5432:*:langchain:dusrufdmlalswhr`
- `*`는 모든 데이터베이스를 의미

**설정 후 사용 방법**:
```bash
# ---------------------- 비밀번호 입력 없이 간편 접속! ---------------------- #
# 주의: -U langchain을 반드시 명시해야 합니다 (생략 시 OS 사용자명으로 접속 시도)
psql -h localhost -U langchain -d papers
```

**보안 주의사항**:
- 파일 권한은 반드시 `600` (소유자만 읽기/쓰기)이어야 합니다
- 권한이 잘못되면 PostgreSQL이 파일을 무시합니다

---

## 4. pgvector Extension 설치

### 4.1 pgvector 소스 설치

```bash
# ---------------------- 필수 패키지 설치 ---------------------- #
sudo apt install build-essential git postgresql-server-dev-15

# ---------------------- pgvector GitHub 저장소 클론 ---------------------- #
cd /tmp
git clone https://github.com/pgvector/pgvector.git
cd pgvector

# ---------------------- 컴파일 및 설치 ---------------------- #
make
sudo make install

# ---------------------- PostgreSQL 재시작 ---------------------- #
sudo systemctl restart postgresql
```

### 4.2 Extension 활성화

**방법 1: postgres 관리자로 활성화 (권장)**

```bash
# ---------------------- postgres 사용자로 접속 ---------------------- #
sudo -u postgres psql

# ---------------------- vector extension 생성 ---------------------- #
CREATE EXTENSION vector;

# ---------------------- Extension 확인 ---------------------- #
\dx

# ---------------------- 출력 예시 ---------------------- #
#                  List of installed extensions
#   Name   | Version |   Schema   |         Description
# ---------+---------+------------+------------------------------
#  plpgsql | 1.0     | pg_catalog | PL/pgSQL procedural language
#  vector  | 0.5.0   | public     | vector data type and ivfflat...

# ---------------------- 종료 ---------------------- #
\q
```

**방법 2: langchain 사용자로 활성화**

```bash
# ---------------------- langchain 사용자로 접속 ---------------------- #
psql -U langchain -d postgres -h localhost

# 비밀번호 입력 프롬프트:
# Password for user langchain: dusrufdmlalswhr

# ---------------------- vector extension 생성 ---------------------- #
CREATE EXTENSION vector;

# ---------------------- Extension 확인 ---------------------- #
\dx

# ---------------------- 종료 ---------------------- #
\q
```

**참고**: `-h localhost`를 추가하면 TCP/IP 연결을 사용하여 비밀번호 인증이 정상 작동합니다.

---

## 5. 환경 변수 설정

### 5.1 .env 파일 확인

프로젝트 루트의 `.env` 파일에 데이터베이스 연결 정보가 설정되어 있습니다:

```bash
# ==================== PostgreSQL 설정 ==================== #
POSTGRES_USER=langchain
POSTGRES_PASSWORD=dusrufdmlalswhr
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=papers
```

### 5.2 실제 값으로 변경

```bash
# .env 파일 편집
vi .env

# 예시 (실제 값으로 변경)
POSTGRES_USER=langchain
POSTGRES_PASSWORD=dusrufdmlalswhr
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=papers
```

### 5.3 환경 변수 확인

프로젝트의 Python 애플리케이션이 `.env` 파일을 자동으로 로드하므로, 별도의 설정은 필요 없습니다. 프로젝트 실행 시 `src/utils/config_loader.py`가 환경 변수를 로드합니다.

---

## 6. 데이터베이스 생성

### 6.1 papers 데이터베이스 생성

```bash
# ---------------------- PostgreSQL 접속 ---------------------- #
psql -U langchain -d postgres -h localhost

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# ---------------------- papers 데이터베이스 생성 ---------------------- #
CREATE DATABASE papers;

# ---------------------- 데이터베이스 확인 ---------------------- #
\l

# ---------------------- 출력 예시 ---------------------- #
#      Name       |  Owner   | Encoding | Collate | Ctype
# ----------------+----------+----------+---------+---------
#  papers         | langchain | UTF8     | en_US.UTF-8 | en_US.UTF-8
#  postgres       | postgres | UTF8     | en_US.UTF-8 | en_US.UTF-8

# ---------------------- papers DB로 전환 ---------------------- #
\c papers

# ---------------------- vector extension 활성화 ---------------------- #
CREATE EXTENSION vector;

# ---------------------- Extension 확인 ---------------------- #
\dx

# ---------------------- 종료 ---------------------- #
\q
```

### 6.2 자동화 스크립트 실행

프로젝트에 이미 데이터베이스 초기화 스크립트가 포함되어 있습니다.

```bash
# ---------------------- 데이터베이스 초기화 스크립트 실행 ---------------------- #
python tests/unit/init_database.py
```

이 스크립트는 다음 작업을 자동으로 수행합니다:
- papers 데이터베이스 생성 (이미 존재하면 건너뛰기)
- pgvector extension 활성화

---

## 7. 스키마 생성

### 7.1 스키마 생성 실행

프로젝트에 이미 준비된 스키마 파일을 실행하여 테이블을 생성합니다.

```bash
# ---------------------- SQL 스크립트 실행 ---------------------- #
psql -U langchain -d papers -h localhost -f database/schema.sql

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# ---------------------- 출력 예시 ---------------------- #
# CREATE EXTENSION
# CREATE TABLE
# CREATE INDEX
# CREATE INDEX
# ...
```

**참고**: `database/schema.sql` 파일은 프로젝트에 이미 포함되어 있으며, papers, glossary, query_logs 테이블과 필요한 인덱스를 생성합니다.

### 7.2 테이블 생성 확인

```bash
# ---------------------- PostgreSQL 접속 ---------------------- #
psql -U langchain -d papers -h localhost

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# ---------------------- 테이블 목록 확인 ---------------------- #
\dt

# ---------------------- 출력 예시 ---------------------- #
#          List of relations
#  Schema |    Name     | Type  |     Owner
# --------+-------------+-------+----------------
#  public | glossary    | table | langchain
#  public | papers      | table | langchain
#  public | query_logs  | table | langchain

# ---------------------- papers 테이블 구조 확인 ---------------------- #
\d papers

# ---------------------- 종료 ---------------------- #
\q
```

---

## 8. 연결 및 테스트

### 8.1 데이터베이스 연결 구조

프로젝트는 다음과 같은 구조로 데이터베이스에 연결됩니다:

```
.env (환경 변수)
  ↓
configs/db_config.yaml (설정 파일, ${VAR} 형태로 환경 변수 참조)
  ↓
src/utils/config_loader.py (YAML 로드 및 환경 변수 치환)
  ↓
src/database/db.py (Connection Pool)
```

**설명**:
- `src/database/db.py`: PostgreSQL Connection Pool 구현 (최소 1개, 최대 10개 연결)
- `src/database/vector_store.py`: Langchain PGVector 통합 (벡터 검색)
- `src/database/embeddings.py`: OpenAI Embeddings 설정

### 8.2 연결 테스트

데이터베이스 연결을 테스트하려면 다음 명령어를 실행합니다:

```bash
# ---------------------- 데이터베이스 연결 테스트 ---------------------- #
python -m tests.unit.test_db_connection
```

**테스트 항목**:
- PostgreSQL 버전 확인
- papers 테이블 레코드 수 확인
- Connection Pool 정상 작동 확인

---

## 9. 백업 및 복구

### 9.1 전체 데이터베이스 백업

```bash
# ---------------------- 전체 DB 백업 ---------------------- #
pg_dump -U langchain -h localhost -d papers -F c -f backup_papers_$(date +%Y%m%d_%H%M%S).dump

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# -F c: Custom 포맷 (압축 및 병렬 복구 지원)
# -f: 출력 파일명
```

### 9.2 특정 테이블만 백업

```bash
# ---------------------- papers 테이블만 백업 ---------------------- #
pg_dump -U langchain -h localhost -d papers -t papers -F c -f papers_backup.dump

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# ---------------------- glossary 테이블만 백업 ---------------------- #
pg_dump -U langchain -h localhost -d papers -t glossary -F c -f glossary_backup.dump

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr
```

### 9.3 데이터베이스 복원

```bash
# ---------------------- 새 데이터베이스 생성 ---------------------- #
createdb -U langchain -h localhost papers_restored

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# ---------------------- 백업 파일 복원 ---------------------- #
pg_restore -U langchain -h localhost -d papers_restored backup_papers_20251101_120000.dump

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr

# ---------------------- 복원 확인 ---------------------- #
psql -U langchain -d papers_restored -h localhost -c "SELECT COUNT(*) FROM papers"

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr
```

---

## 10. 트러블슈팅

### 10.1 PostgreSQL 연결 오류

**문제:**
```
psycopg2.OperationalError: could not connect to server
```

**해결:**
```bash
# PostgreSQL 실행 확인
sudo systemctl status postgresql

# PostgreSQL 시작
sudo systemctl start postgresql

# 연결 테스트
psql -U langchain -d papers -h localhost
```

### 10.2 pgvector Extension 오류

**문제:**
```
ERROR: extension "vector" is not available
```

**해결:**
```bash
# pgvector 재설치
cd /tmp
git clone https://github.com/pgvector/pgvector.git
cd pgvector
make clean
make
sudo make install

# PostgreSQL 재시작
sudo systemctl restart postgresql

# Extension 생성
psql -U langchain -d papers -h localhost -c "CREATE EXTENSION vector;"

# ~/.pgpass 미설정 시 비밀번호 입력: dusrufdmlalswhr
```

### 10.3 권한 오류

**문제:**
```
ERROR: permission denied for table papers
```

**해결:**
```bash
# PostgreSQL 접속 (postgres 관리자)
sudo -u postgres psql -d papers

# 권한 부여
GRANT ALL PRIVILEGES ON ALL TABLES IN SCHEMA public TO langchain;
GRANT ALL PRIVILEGES ON ALL SEQUENCES IN SCHEMA public TO langchain;

# 종료
\q
```

### 10.4 Langchain PGVector 연결 오류

**문제:**
```
ImportError: cannot import name 'PGVector' from 'langchain_postgres'
```

**해결:**
```bash
# langchain-postgres 재설치
pip uninstall langchain-postgres
pip install langchain-postgres==0.0.1

# 또는 최신 버전 설치
pip install langchain-postgres --upgrade
```

---

## 마무리

이제 PostgreSQL + pgvector 데이터베이스를 완벽하게 설정하고 사용할 수 있습니다!

### 다음 단계

프로젝트의 다음 단계는 Streamlit 애플리케이션을 실행하는 것입니다:

```bash
# ---------------------- Streamlit 애플리케이션 실행 ---------------------- #
streamlit run streamlit_app.py
```

애플리케이션 실행 시 다음 작업이 자동으로 수행됩니다:
- 데이터베이스 연결 (Connection Pool)
- pgvector를 통한 벡터 검색
- 논문 메타데이터 관리
- 사용자 질의 로깅

### 참고 문서

- PostgreSQL 공식 문서: https://www.postgresql.org/docs/
- pgvector GitHub: https://github.com/pgvector/pgvector
- Langchain PGVector: https://python.langchain.com/docs/integrations/vectorstores/pgvector
