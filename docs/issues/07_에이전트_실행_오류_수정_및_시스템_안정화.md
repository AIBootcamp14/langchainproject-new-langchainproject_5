## ì œëª© : ì—ì´ì „íŠ¸ ì‹¤í–‰ ì˜¤ë¥˜ ìˆ˜ì • ë° ì‹œìŠ¤í…œ ì•ˆì •í™”

---

## ğŸ“‹ ì‘ì—… ê°œìš”
**ì‘ì—… ì£¼ì œ:** Agent ì‹¤í–‰ ì‹œ ë°œìƒí•˜ëŠ” ì£¼ìš” ë²„ê·¸ ìˆ˜ì • ë° ì‹œìŠ¤í…œ ì•ˆì •í™”
**ì‘ì„±ì:** Claude Code
**ë‹´ë‹¹ì:** @Claude
**ë§ˆê°ì¼:** 11/05 24:00

## ğŸ“… ê¸°ê°„
- ì‹œì‘ì¼: 2025-11-05
- ì¢…ë£Œì¼: 2025-11-05

---

## ğŸ“Œ ì´ìŠˆ ëª©ì 

ì‹¤í—˜ ë¡œê·¸ ë¶„ì„ ê²°ê³¼, Agent ì‹¤í–‰ ì‹œ ë‹¤ìŒê³¼ ê°™ì€ ì£¼ìš” ì˜¤ë¥˜ë“¤ì´ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤:
1. ë¼ìš°íŒ… í”„ë¡¬í”„íŠ¸ì˜ JSON ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„ ì˜¤ë¥˜ë¡œ ì¸í•œ ì‹¤í–‰ ì‹¤íŒ¨
2. General ë„êµ¬ì˜ ì˜ëª»ëœ ì‹¤íŒ¨ ê°ì§€ë¡œ ì¸í•œ ë¬´í•œ Fallback ë£¨í”„
3. ê³¼ë„í•˜ê²Œ ë„“ì€ ì‹¤íŒ¨ íŒ¨í„´ìœ¼ë¡œ ì¸í•œ ì •ìƒ ë‹µë³€ ì˜¤ë¥˜ íŒì •
4. ë‹¤ì¤‘ ìš”ì²­ íŒŒì´í”„ë¼ì¸ì´ ì²« ë²ˆì§¸ ë„êµ¬ ì‹¤í–‰ í›„ ì¤‘ë‹¨ë˜ëŠ” ë¬¸ì œ

ì´ëŸ¬í•œ ë¬¸ì œë“¤ì„ ë¶„ì„í•˜ê³  ìˆ˜ì •í•˜ì—¬ ì‹œìŠ¤í…œì˜ ì•ˆì •ì„±ì„ í–¥ìƒì‹œí‚µë‹ˆë‹¤.

**í•µì‹¬ ëª©í‘œ:**
- ë¼ìš°íŒ… í”„ë¡¬í”„íŠ¸ í…œí”Œë¦¿ JSON í˜•ì‹ ì˜¤ë¥˜ ìˆ˜ì •
- General ë„êµ¬ì˜ í•­ìƒ ì„±ê³µ ì²˜ë¦¬ ë¡œì§ êµ¬í˜„
- ì‹¤íŒ¨ ê°ì§€ íŒ¨í„´ êµ¬ì²´í™” ë° ì •í™•ë„ í–¥ìƒ
- ë‹¤ì¤‘ ìš”ì²­ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œì§ ê°œì„ 

---

## ğŸš¨ ë°œê²¬ëœ ë¬¸ì œì 

### ë¬¸ì œ 1: JSON ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„ ì˜¤ë¥˜

```
ì—ëŸ¬ ë¡œê·¸:
2025-11-05 10:34:55 | UI ì—ëŸ¬: '\n  "tools"'
2025-11-05 10:35:39 | UI ì—ëŸ¬: '\n  "tools"'

ì¦ìƒ:
ì‚¬ìš©ì ì§ˆë¬¸: "ì €ì¥ í•´ì¤˜"
    â†“
Router ë…¸ë“œ ì‹¤í–‰
    â†“
routing_prompt.format(question=..., difficulty=...)
    â†“
KeyError: '\n  "tools"' âŒ
```

**ì›ì¸:**
```python
# prompts/routing_prompts.json (ìˆ˜ì • ì „)
"prompt_template": "...\n{{\n  \"tools\": [\n    {\n      \"name\": \"ë„êµ¬ëª…\"\n    }\n  ]\n}}"
```
- Pythonì˜ `str.format()` ë©”ì„œë“œê°€ JSON ì˜ˆì‹œì˜ ì¤‘ê´„í˜¸ `{`, `}`ë¥¼ format í”Œë ˆì´ìŠ¤í™€ë”ë¡œ ì¸ì‹
- `{tools}`ë¥¼ format ë³€ìˆ˜ë¡œ í•´ì„í•˜ì—¬ KeyError ë°œìƒ

**ì˜í–¥ë°›ì€ ì§ˆë¬¸:**
- "ì €ì¥ í•´ì¤˜"
- "2024ë…„ ì´í›„ Reinforcement Learning ê´€ë ¨ ë…¼ë¬¸ ì¤‘ ìƒìœ„ ì¸ìš© 5ê°œë§Œ ê³¨ë¼ì„œ ë³´ì—¬ì¤˜"
- ê¸°íƒ€ ëª¨ë“  ì‚¬ìš©ì ì§ˆë¬¸ (ë¼ìš°íŒ… ë‹¨ê³„ì—ì„œ ì‹¤íŒ¨)

### ë¬¸ì œ 2: General ë„êµ¬ ì˜ëª»ëœ ì‹¤íŒ¨ ê°ì§€

```
ì—ëŸ¬ ë¡œê·¸:
2025-11-05 10:36:32 | ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨ ê°ì§€: general
2025-11-05 10:36:32 | ì‹¤íŒ¨ ì‚¬ìœ : íŒ¨í„´ ê°ì§€: ì—†ìŠµë‹ˆë‹¤

ì¦ìƒ:
General ë„êµ¬ê°€ ì •ìƒì ìœ¼ë¡œ ë‹µë³€ì„ ìƒì„±í–ˆìŒì—ë„ ë¶ˆêµ¬í•˜ê³ 
ë‹µë³€ ë‚´ìš©ì— "~í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤", "~ê°€ ì—†ìŠµë‹ˆë‹¤" ë“±ì˜ í‘œí˜„ì´ í¬í•¨ë˜ë©´
ì‹¤íŒ¨ë¡œ ê°ì§€ë˜ì–´ Fallback Routerë¡œ ì „í™˜ë¨
    â†“
ë¬´í•œ Fallback ë£¨í”„ ë°œìƒ ê°€ëŠ¥
```

**ì›ì¸:**
```python
# src/agent/tool_wrapper.py (ìˆ˜ì • ì „)
# General ë„êµ¬ë„ ë‹¤ë¥¸ ë„êµ¬ì™€ ë™ì¼í•˜ê²Œ ì‹¤íŒ¨ íŒ¨í„´ ê²€ì‚¬
is_failed, failure_reason = is_tool_failed(final_answer)
```
- Generalì€ ìµœì¢… Fallback ë„êµ¬ë¡œ, í•­ìƒ ì„±ê³µìœ¼ë¡œ ì²˜ë¦¬í•´ì•¼ í•¨
- í•˜ì§€ë§Œ ì¼ë°˜ ë„êµ¬ì™€ ë™ì¼í•˜ê²Œ ì‹¤íŒ¨ íŒ¨í„´ ê²€ì‚¬ë¥¼ ìˆ˜í–‰í•˜ì—¬ ì˜¤íŒ ë°œìƒ

### ë¬¸ì œ 3: ê³¼ë„í•˜ê²Œ ë„“ì€ ì‹¤íŒ¨ íŒ¨í„´

```python
# src/agent/failure_detector.py (ìˆ˜ì • ì „)
FAILURE_PATTERNS = [
    "ì—†ìŠµë‹ˆë‹¤",      # â† ë„ˆë¬´ ë„“ìŒ! "~í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" ë“±ë„ í¬í•¨
    "ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",  # â† ë„ˆë¬´ ë„“ìŒ! ì •ìƒ ë‹µë³€ì—ë„ í¬í•¨ë  ìˆ˜ ìˆìŒ
    ...
]
```

**ë¬¸ì œì :**
- "ê´€ë ¨ ì—°êµ¬ëŠ” ì—†ìŠµë‹ˆë‹¤ë§Œ, ì¼ë°˜ì ìœ¼ë¡œ..." â†’ ì‹¤íŒ¨ë¡œ íŒì • âŒ
- "ì„±ê³µí•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" â†’ ì‹¤íŒ¨ë¡œ íŒì • âŒ (ì •ìƒ ë‹µë³€ì¸ë° ì˜¤íŒ)
- "í˜„ì¬ëŠ” ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤ë§Œ, ë‹¤ìŒê³¼ ê°™ì€ í•´ê²°ì±…ì´..." â†’ ì‹¤íŒ¨ë¡œ íŒì • âŒ

### ë¬¸ì œ 4: ë‹¤ì¤‘ ìš”ì²­ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨

```
ì—ëŸ¬ ë¡œê·¸:
2025-11-05 10:43:22 | ë‹¤ì¤‘ ìš”ì²­ ê°ì§€: ('ì°¾', 'ìš”ì•½') â†’ ['search_paper', 'summarize']
2025-11-05 10:43:22 | ìˆœì°¨ ì‹¤í–‰ ë„êµ¬: search_paper â†’ summarize
2025-11-05 10:47:28 | ë„êµ¬ ì‹¤í–‰ ì„±ê³µ: search_paper
    â†“
(summarize ì‹¤í–‰ ë¡œê·¸ ì—†ìŒ - íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ë¨)

ì¦ìƒ:
"ë…¼ë¬¸ì„ ì°¾ì•„ì„œ ìš”ì•½í•´ì¤˜" ì§ˆë¬¸ ì‹œ
    â†“
search_paper ì‹¤í–‰ ì„±ê³µ
    â†“
íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ âŒ
    â†“
summarize ì‹¤í–‰ ì•ˆ ë¨
```

**ì›ì¸:**
```python
# src/agent/graph.py - check_pipeline_or_fallback (ìˆ˜ì • ì „)
def check_pipeline_or_fallback(state: AgentState) -> str:
    tool_pipeline = state.get("tool_pipeline", [])
    pipeline_index = state.get("pipeline_index", 0)

    # ë„êµ¬ ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€ì™€ ê´€ê³„ì—†ì´ íŒŒì´í”„ë¼ì¸ë§Œ í™•ì¸
    if tool_pipeline and pipeline_index < len(tool_pipeline):
        return should_continue_pipeline(state)

    return should_fallback(state)
```

**ë¬¸ì œì :**
- ë„êµ¬ ì‹¤í–‰ ê²°ê³¼(ì„±ê³µ/ì‹¤íŒ¨)ë¥¼ í™•ì¸í•˜ì§€ ì•Šê³  íŒŒì´í”„ë¼ì¸ ì¡´ì¬ë§Œ í™•ì¸
- ë…¼ë¦¬ì ìœ¼ë¡œ íŒŒì´í”„ë¼ì¸ì´ ê³„ì†ë˜ì–´ì•¼ í•˜ì§€ë§Œ, ì‹¤ì œë¡œëŠ” `should_fallback`ì´ í˜¸ì¶œë¨
- `should_fallback`ì€ `tool_status == "success"`ì¼ ë•Œ `"end"`ë¥¼ ë°˜í™˜í•˜ì—¬ íŒŒì´í”„ë¼ì¸ ì¢…ë£Œ

---

## âœ… ì‘ì—… í•­ëª© ì²´í¬ë¦¬ìŠ¤íŠ¸

### Phase 1: ë¼ìš°íŒ… í”„ë¡¬í”„íŠ¸ JSON ì˜¤ë¥˜ ìˆ˜ì •

- [x] `prompts/routing_prompts.json` JSON ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„
  - [x] ëª¨ë“  `{`ë¥¼ `{{`ë¡œ ë³€ê²½
  - [x] ëª¨ë“  `}`ë¥¼ `}}`ë¡œ ë³€ê²½
  - [x] format í”Œë ˆì´ìŠ¤í™€ë” `{question}`, `{difficulty}`ëŠ” ìœ ì§€
- [x] ìˆ˜ì • í›„ í…ŒìŠ¤íŠ¸ (ë‹¤ì–‘í•œ ì§ˆë¬¸ìœ¼ë¡œ ë¼ìš°íŒ… ì •ìƒ ì‘ë™ í™•ì¸)

**ì»¤ë°‹:** `7836477` - fix: routing_prompts.json JSON ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„

### Phase 2: General ë„êµ¬ í•­ìƒ ì„±ê³µ ì²˜ë¦¬ ë¡œì§ êµ¬í˜„

- [x] `src/agent/tool_wrapper.py` ìˆ˜ì •
  - [x] General ë„êµ¬ ì‹¤í–‰ ì‹œ ì‹¤íŒ¨ ê°ì§€ íŒ¨í„´ ì²´í¬ ê±´ë„ˆë›°ê¸°
  - [x] `tool_status = "success"` ê°•ì œ ì„¤ì •
  - [x] `failure_reason = ""` ì´ˆê¸°í™”
  - [x] ë¡œê¹…: "ë„êµ¬ ì‹¤í–‰ ì„±ê³µ: general (fallback ë„êµ¬)"
- [x] ë¬´í•œ Fallback ë£¨í”„ ë°©ì§€ ê²€ì¦

**ì»¤ë°‹:** `cb3d3fb` - fix: general ë„êµ¬ í•­ìƒ ì„±ê³µ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •

### Phase 3: ì‹¤íŒ¨ íŒ¨í„´ êµ¬ì²´í™” ë° ì •í™•ë„ í–¥ìƒ

- [x] `src/agent/failure_detector.py` ì‹¤íŒ¨ íŒ¨í„´ ìˆ˜ì •
  - [x] ë„“ì€ íŒ¨í„´ ì œê±°
    - [x] "ì—†ìŠµë‹ˆë‹¤" â†’ ì‚­ì œ
    - [x] "ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤" â†’ ì‚­ì œ
  - [x] êµ¬ì²´ì  íŒ¨í„´ ìœ ì§€
    - [x] "ê´€ë ¨ ìš©ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    - [x] "ê´€ë ¨ ë…¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
    - [x] "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤"
    - [x] "SQL ì¿¼ë¦¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤"
    - [x] ê¸°íƒ€ êµ¬ì²´ì  ì˜¤ë¥˜ ë©”ì‹œì§€ë“¤
- [x] ì •ê·œì‹ íŒ¨í„´ ìœ ì§€ (ìœ ì—°í•œ ë§¤ì¹­ìš©)
- [x] False Positive ê°ì†Œ í™•ì¸

**ì»¤ë°‹:** `83f2002` - fix: ì‹¤íŒ¨ ê°ì§€ íŒ¨í„´ êµ¬ì²´í™”í•˜ì—¬ ì •í™•ë„ í–¥ìƒ

### Phase 4: ë‹¤ì¤‘ ìš”ì²­ íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œì§ ê°œì„ 

- [x] `src/agent/graph.py` - `check_pipeline_or_fallback` í•¨ìˆ˜ ìˆ˜ì •
  - [x] ë„êµ¬ ì‹¤í–‰ ê²°ê³¼(`tool_status`) ë¨¼ì € í™•ì¸
  - [x] ì‹¤íŒ¨ ì‹œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ í›„ Fallback ì²´í¬
  - [x] ì„±ê³µ ì‹œì—ë§Œ íŒŒì´í”„ë¼ì¸ ê³„ì† ì§„í–‰
  - [x] íŒŒì´í”„ë¼ì¸ ì¢…ë£Œ ì‹œ ì •ìƒ ì¢…ë£Œ ë°˜í™˜
- [x] íŒŒì´í”„ë¼ì¸ ìƒíƒœ ì¶”ì  ë¡œì§ ê²€ì¦
  - [x] `pipeline_index` ì •ìƒ ì¦ê°€ í™•ì¸
  - [x] ëª¨ë“  ë„êµ¬ ìˆœì°¨ ì‹¤í–‰ í™•ì¸

**ì»¤ë°‹:** `1ae329a` - fix: íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œì§ ê°œì„ 

---

## ğŸ”§ êµ¬í˜„ ì„¸ë¶€ì‚¬í•­

### 1. JSON ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„ ìˆ˜ì •

**íŒŒì¼:** `prompts/routing_prompts.json`

**ìˆ˜ì • ì „:**
```json
{
  "prompt_template": "...\nJSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”:\n{\n  \"tools\": [\n    {\n      \"name\": \"ë„êµ¬ëª…\"\n    }\n  ]\n}"
}
```

**ìˆ˜ì • í›„:**
```json
{
  "prompt_template": "...\nJSON í˜•ì‹ìœ¼ë¡œ ë°˜í™˜í•˜ì„¸ìš”:\n{{\n  \"tools\": [\n    {{\n      \"name\": \"ë„êµ¬ëª…\"\n    }}\n  ]\n}}"
}
```

**íš¨ê³¼:**
- Python `str.format()`ì´ `{{`, `}}`ë¥¼ ë¦¬í„°ëŸ´ ì¤‘ê´„í˜¸ë¡œ ì¸ì‹
- `{question}`, `{difficulty}` í”Œë ˆì´ìŠ¤í™€ë”ëŠ” ì •ìƒ ì‘ë™
- ëª¨ë“  ì§ˆë¬¸ì— ëŒ€í•´ ë¼ìš°íŒ… ì •ìƒ ìˆ˜í–‰

### 2. General ë„êµ¬ í•­ìƒ ì„±ê³µ ì²˜ë¦¬

**íŒŒì¼:** `src/agent/tool_wrapper.py` (56-61í–‰)

**ì¶”ê°€ ì½”ë“œ:**
```python
# general ë„êµ¬ëŠ” fallbackì´ë¯€ë¡œ í•­ìƒ ì„±ê³µ ì²˜ë¦¬
if tool_name == "general":
    state["tool_status"] = "success"
    state["failure_reason"] = ""

    if exp_manager:
        exp_manager.logger.write(f"ë„êµ¬ ì‹¤í–‰ ì„±ê³µ: {tool_name} (fallback ë„êµ¬)")
else:
    # ì‹¤íŒ¨ íŒ¨í„´ ê°ì§€ (general ì œì™¸)
    is_failed, failure_reason = is_tool_failed(final_answer)
    ...
```

**íš¨ê³¼:**
- General ë„êµ¬ëŠ” ì‹¤íŒ¨ íŒ¨í„´ ê²€ì‚¬ ê±´ë„ˆë›°ê¸°
- ìµœì¢… Fallbackìœ¼ë¡œ í•­ìƒ ì„±ê³µ ì²˜ë¦¬
- ë¬´í•œ Fallback ë£¨í”„ ë°©ì§€

### 3. ì‹¤íŒ¨ íŒ¨í„´ êµ¬ì²´í™”

**íŒŒì¼:** `src/agent/failure_detector.py` (23-35í–‰)

**ìˆ˜ì • ì „:**
```python
FAILURE_PATTERNS = [
    "ì—†ìŠµë‹ˆë‹¤",              # â† ì‚­ì œë¨
    "ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",          # â† ì‚­ì œë¨
    "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤",
    ...
]
```

**ìˆ˜ì • í›„:**
```python
FAILURE_PATTERNS = [
    "ê´€ë ¨ ìš©ì–´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
    "ê´€ë ¨ ë…¼ë¬¸ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
    "ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤",
    "íŒŒì¼ ê²½ë¡œë¥¼ ì§€ì •í•´ì£¼ì„¸ìš”",
    "SQL ì¿¼ë¦¬ ìƒì„±ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",
    "ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤",
    "ê²€ìƒ‰ëœ ë…¼ë¬¸ì´ ì—†ìŠµë‹ˆë‹¤",
    "ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
    "ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤",
    "ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ì°¾ì§€ ëª»í–ˆìŠµë‹ˆë‹¤",
    "ê²€ìƒ‰ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤",
]
```

**íš¨ê³¼:**
- False Positive ëŒ€í­ ê°ì†Œ
- ì •ìƒ ë‹µë³€ì˜ "~í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤" í‘œí˜„ì´ ì‹¤íŒ¨ë¡œ íŒì •ë˜ì§€ ì•ŠìŒ
- ì‹¤ì œ ë„êµ¬ ì‹¤íŒ¨ë§Œ ì •í™•í•˜ê²Œ ê°ì§€

### 4. íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œì§ ê°œì„ 

**íŒŒì¼:** `src/agent/graph.py` (277-295í–‰)

**ìˆ˜ì • ì „:**
```python
def check_pipeline_or_fallback(state: AgentState) -> str:
    tool_pipeline = state.get("tool_pipeline", [])
    pipeline_index = state.get("pipeline_index", 0)

    if tool_pipeline and pipeline_index < len(tool_pipeline):
        return should_continue_pipeline(state)

    return should_fallback(state)
```

**ìˆ˜ì • í›„:**
```python
def check_pipeline_or_fallback(state: AgentState) -> str:
    # 1ë‹¨ê³„: ë„êµ¬ ì‹¤í–‰ ê²°ê³¼ í™•ì¸
    tool_status = state.get("tool_status", "success")

    # 2ë‹¨ê³„: ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨ ì‹œ Fallback ì²´í¬ (íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨)
    if tool_status != "success":
        return should_fallback(state)

    # 3ë‹¨ê³„: ë„êµ¬ ì„±ê³µ ì‹œ Pipeline ê³„ì† ì—¬ë¶€ í™•ì¸
    tool_pipeline = state.get("tool_pipeline", [])
    pipeline_index = state.get("pipeline_index", 0)

    # 4ë‹¨ê³„: Pipelineì´ ìˆê³  ë‹¤ìŒ ë„êµ¬ê°€ ìˆìœ¼ë©´ ê³„ì† ì‹¤í–‰
    if tool_pipeline and pipeline_index < len(tool_pipeline):
        return should_continue_pipeline(state)

    # 5ë‹¨ê³„: Pipelineì´ ëë‚¬ìœ¼ë©´ ì •ìƒ ì¢…ë£Œ
    return "end"
```

**íš¨ê³¼:**
- ë„êµ¬ ì„±ê³µ ì‹œì—ë§Œ íŒŒì´í”„ë¼ì¸ ê³„ì† ì§„í–‰
- ë„êµ¬ ì‹¤íŒ¨ ì‹œ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ í›„ Fallback ì²´í¬
- "ë…¼ë¬¸ ì°¾ì•„ì„œ ìš”ì•½í•´ì¤˜" ê°™ì€ ë‹¤ì¤‘ ìš”ì²­ ì •ìƒ ì²˜ë¦¬

---

## ğŸ“Š ê²€ì¦ ê²°ê³¼

### ìˆ˜ì • ì „ ë¬¸ì œ ì¬í˜„

**ì‹¤í—˜ ë¡œê·¸:** `experiments/20251105/20251105_102915_session_004/chatbot.log`

1. **JSON ì˜¤ë¥˜:**
   - ì§ˆë¬¸: "ì €ì¥ í•´ì¤˜", "2024ë…„ ì´í›„ Reinforcement Learning..." ë“±
   - ê²°ê³¼: KeyError: '\n  "tools"' ë°œìƒ

2. **General ë„êµ¬ ì˜¤íŒ:**
   - ë¡œê·¸: "ë„êµ¬ ì‹¤í–‰ ì‹¤íŒ¨ ê°ì§€: general" (ì‹¤ì œë¡œëŠ” ì •ìƒ ë‹µë³€)
   - ì‹¤íŒ¨ ì‚¬ìœ : "íŒ¨í„´ ê°ì§€: ì—†ìŠµë‹ˆë‹¤"

3. **íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨:**
   - ì§ˆë¬¸: "Multimodal AI ê´€ë ¨ ë…¼ë¬¸ì„ ì°¾ì•„ì„œ ì£¼ìš” ì‘ìš© ì‚¬ë¡€ë¥¼ ì •ë¦¬í•´ì¤˜"
   - ë¡œê·¸: "ë‹¤ì¤‘ ìš”ì²­ ê°ì§€: ('ì°¾', 'ì •ë¦¬') â†’ ['search_paper', 'summarize', 'general']"
   - search_paper ì„±ê³µ í›„ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ (summarize ì‹¤í–‰ ì•ˆ ë¨)

### ìˆ˜ì • í›„ ì˜ˆìƒ ë™ì‘

1. **JSON ì˜¤ë¥˜ í•´ê²°:**
   - ëª¨ë“  ì§ˆë¬¸ì— ëŒ€í•´ ë¼ìš°íŒ… ì •ìƒ ì‘ë™
   - KeyError ë°œìƒí•˜ì§€ ì•ŠìŒ

2. **General ë„êµ¬ í•­ìƒ ì„±ê³µ:**
   - General ë„êµ¬ ì‹¤í–‰ ì‹œ í•­ìƒ `tool_status = "success"`
   - Fallback ë£¨í”„ ë°œìƒí•˜ì§€ ì•ŠìŒ

3. **ì‹¤íŒ¨ íŒ¨í„´ ì •í™•ë„ í–¥ìƒ:**
   - ì •ìƒ ë‹µë³€ì´ ì‹¤íŒ¨ë¡œ íŒì •ë˜ì§€ ì•ŠìŒ
   - ì‹¤ì œ ë„êµ¬ ì‹¤íŒ¨ë§Œ ì •í™•í•˜ê²Œ ê°ì§€

4. **íŒŒì´í”„ë¼ì¸ ì •ìƒ ì‹¤í–‰:**
   - search_paper â†’ summarize â†’ general ìˆœì°¨ ì‹¤í–‰
   - ê° ë„êµ¬ ì„±ê³µ ì‹œ ë‹¤ìŒ ë„êµ¬ë¡œ ìë™ ì „í™˜
   - íƒ€ì„ë¼ì¸ì— ëª¨ë“  ë„êµ¬ ì‹¤í–‰ ê¸°ë¡ë¨

---

## ğŸ¯ ê²°ë¡ 

**í•´ê²°ëœ ì´ìŠˆ:**
- âœ… ë¼ìš°íŒ… í”„ë¡¬í”„íŠ¸ JSON ì˜¤ë¥˜ë¡œ ì¸í•œ ëª¨ë“  ì§ˆë¬¸ ì‹¤íŒ¨ ë¬¸ì œ
- âœ… General ë„êµ¬ ì˜¤íŒìœ¼ë¡œ ì¸í•œ ë¬´í•œ Fallback ë£¨í”„ ë¬¸ì œ
- âœ… ê³¼ë„í•˜ê²Œ ë„“ì€ ì‹¤íŒ¨ íŒ¨í„´ìœ¼ë¡œ ì¸í•œ False Positive ë¬¸ì œ
- âœ… ë‹¤ì¤‘ ìš”ì²­ íŒŒì´í”„ë¼ì¸ ì¤‘ë‹¨ ë¬¸ì œ

**ì‹œìŠ¤í…œ ì•ˆì •ì„± í–¥ìƒ:**
- ëª¨ë“  ì§ˆë¬¸ ìœ í˜•ì— ëŒ€í•´ ì •ìƒì ì¸ ë¼ìš°íŒ… ê°€ëŠ¥
- Fallback ë©”ì»¤ë‹ˆì¦˜ì˜ ì •í™•ë„ ë° ì•ˆì •ì„± í–¥ìƒ
- ë‹¤ì¤‘ ìš”ì²­ ì²˜ë¦¬ ê¸°ëŠ¥ ì •ìƒ ì‘ë™
- ë„êµ¬ ì‹¤í–‰ ìƒíƒœ ì¶”ì  ë° ë¡œê¹… ê°œì„ 

**í–¥í›„ ê°œì„  ì‚¬í•­:**
- ì‹¤ì œ ì‚¬ìš©ì í…ŒìŠ¤íŠ¸ë¥¼ í†µí•œ ì¶”ê°€ ë²„ê·¸ ë°œê²¬ ë° ìˆ˜ì •
- ì‹¤íŒ¨ íŒ¨í„´ì˜ ì§€ì†ì ì¸ ëª¨ë‹ˆí„°ë§ ë° ì—…ë°ì´íŠ¸
- íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œì§ì˜ ì¶”ê°€ ìµœì í™”
- ì—ëŸ¬ í•¸ë“¤ë§ ë° ë³µêµ¬ ë©”ì»¤ë‹ˆì¦˜ ê°•í™”

---

## ğŸ“š ì°¸ê³  ìë£Œ

**ìˆ˜ì •ëœ íŒŒì¼:**
- `prompts/routing_prompts.json`
- `src/agent/tool_wrapper.py`
- `src/agent/failure_detector.py`
- `src/agent/graph.py`

**ì»¤ë°‹ ì´ë ¥:**
- `7836477` - fix: routing_prompts.json JSON ì¤‘ê´„í˜¸ ì´ìŠ¤ì¼€ì´í”„
- `cb3d3fb` - fix: general ë„êµ¬ í•­ìƒ ì„±ê³µ ì²˜ë¦¬í•˜ë„ë¡ ìˆ˜ì •
- `83f2002` - fix: ì‹¤íŒ¨ ê°ì§€ íŒ¨í„´ êµ¬ì²´í™”í•˜ì—¬ ì •í™•ë„ í–¥ìƒ
- `1ae329a` - fix: íŒŒì´í”„ë¼ì¸ ì‹¤í–‰ ë¡œì§ ê°œì„ 

**ì‹¤í—˜ ë¡œê·¸:**
- `experiments/20251105/20251105_102915_session_004/chatbot.log`
