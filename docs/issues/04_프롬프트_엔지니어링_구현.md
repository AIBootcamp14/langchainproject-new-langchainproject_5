## 제목: 프롬프트 엔지니어링 구현

---

## 📋 작업 개요
**작업 주제:** AI Agent 도구 라우팅 및 프롬프트 엔지니어링
**담당자:** @임예슬
**마감일:** 11/04 24:00

## 📅 기간
- 시작일: 2025-11-03
- 종료일: 2025-11-04

---

## 📌 이슈 목적

**프롬프트 엔지니어링에만 집중**

### 구현 완료된 기능 (다른 담당자)
- ✅ **Streamlit UI** - 최현화 ([담당역할_01-3_최현화_Streamlit_UI_구현.md](../roles/담당역할_01-3_최현화_Streamlit_UI_구현.md))
- ✅ **웹 검색 도구** - 최현화
- ✅ **파일 다운로드 기능** - 최현화
- ✅ **LangGraph 노드** - 최현화 & 임예슬 ([담당역할_06_통합_LangGraph_스트리밍.md](../roles/담당역할_06_통합_LangGraph_스트리밍.md))

### 임예슬 담당 - 프롬프트 엔지니어링
- ⭐ **AI Agent 도구 라우팅 프롬프트** (최우선순위)
- 도구별 프롬프트 (6개 도구)
- 평가 프롬프트 (LLM-as-a-Judge)
- 질문 생성 프롬프트
- Golden Dataset 구축
- JSON 프롬프트 파일 작성 완료 ✅

### 최현화 담당 - 프롬프트 로더 적용
- ✅ **Prompt Loader 초기 구현 완료** (`src/prompts/loader.py`)
- ⭐ **기존 코드에 Prompt JSON 파일 적용** (우선순위 높음)
  - router_node에 JSON 프롬프트 적용
  - 6개 도구 노드에 JSON 프롬프트 적용
  - 하드코딩된 프롬프트 제거

---

## ✅ 작업 항목 체크리스트

### Phase 1: AI Agent 도구 라우팅 프롬프트 (1일) ⭐ 최우선순위

**파일 경로**: `prompts/routing_prompts.json`, `src/agent/nodes.py`

**작업 내용:**
- [ ] 라우팅 프롬프트 개선
  - [ ] 6개 도구별 상세 시나리오 작성
    * general, search_paper, web_search, glossary, summarize, save_file
  - [ ] 각 도구별 키워드 리스트 정의
  - [ ] 중요 규칙 명확화 (비교 질문 → general 등)

- [ ] Few-shot 예시 추가
  - [ ] 각 도구별 2-3개 예시 작성 (총 10개 이상)
  - [ ] 헷갈리는 케이스 포함 (비교 질문, 단일 용어 정의 등)

- [ ] router_node 수정
  - [ ] JSON 프롬프트 로드 로직 추가
  - [ ] `from src.prompts import get_routing_prompt`
  - [ ] 하드코딩된 프롬프트 제거

- [ ] 재라우팅 및 Fallback 처리
  - [ ] 유효하지 않은 도구 선택 시 재시도
  - [ ] 최대 2회 재시도 후 general 도구 사용

**참고**: [담당역할_04](../roles/담당역할_04_임예슬_프롬프트_엔지니어링.md) 64-150줄

---

### Phase 2: 도구별 프롬프트 구현 (1일)

**파일 경로**: `prompts/tool_prompts.json`, 각 도구 파일

**작업 내용:**
- [ ] 일반 답변 프롬프트 (`src/tools/general_answer.py`)
  - [ ] Easy/Hard 모드 시스템 프롬프트 JSON으로 이동
  - [ ] 로더 함수 사용 (`get_tool_prompt("general_answer", difficulty)`)
  - [ ] 하드코딩 제거

- [ ] 웹 검색 프롬프트 (`src/tools/web_search.py`)
  - [ ] Easy/Hard 모드 시스템 프롬프트 JSON으로 이동
  - [ ] 사용자 프롬프트 템플릿 정의
  - [ ] 로더 함수 사용

- [ ] 논문 요약 프롬프트 (`src/tools/summarize.py`)
  - [ ] 제목 추출 프롬프트 JSON으로 이동
  - [ ] Easy/Hard 모드 요약 프롬프트 정의
  - [ ] 로더 함수 사용

- [ ] 용어집 프롬프트 (`src/tools/glossary.py`)
  - [ ] Easy/Hard 모드 시스템 프롬프트 정의
  - [ ] 로더 함수 사용

- [ ] 논문 검색 프롬프트 (`src/tools/search_paper.py`)
  - [ ] Easy/Hard 모드 시스템 프롬프트 정의
  - [ ] 로더 함수 사용

**참고**: [담당역할_04](../roles/담당역할_04_임예슬_프롬프트_엔지니어링.md) 224-380줄

---

### Phase 3: 평가 프롬프트 구현 (1일, 선택 사항)

**파일 경로**: `prompts/evaluation_prompts.json`, `src/evaluation/evaluator.py`

**작업 내용:**
- [ ] 평가 프롬프트 정의
  - [ ] 평가 기준: 정확도, 관련성, 난이도 적합성, 출처 명시
  - [ ] JSON 형식 출력 요청

- [ ] AnswerEvaluator 클래스 구현
  - [ ] ChatOpenAI 초기화 (model: gpt-4, temperature: 0)
  - [ ] evaluate() 메서드 구현
  - [ ] JSON 파싱 및 결과 반환

- [ ] 평가 결과 저장
  - [ ] PostgreSQL evaluation_results 테이블 생성
  - [ ] 평가 결과 INSERT

**참고**: [담당역할_04](../roles/담당역할_04_임예슬_프롬프트_엔지니어링.md) 383-470줄

---

### Phase 4: Golden Dataset 구축 및 테스트 (1일)

**파일 경로**: `prompts/golden_dataset.json`, 테스트 스크립트

**작업 내용:**
- [ ] Golden Dataset 확장
  - [ ] 현재 15개 → 20개 이상 질문 추가
  - [ ] 모든 도구 커버 (각 도구별 최소 3개)
  - [ ] 난이도 균형 (Easy/Hard 각 50%)

- [ ] 라우팅 정확도 테스트 스크립트 작성
  - [ ] `scripts/test_routing_accuracy.py` 생성
  - [ ] Golden Dataset 로드
  - [ ] Agent 실행 및 정확도 측정
  - [ ] 결과 출력 (✅/❌, 정확도 %)

- [ ] 테스트 실행 및 개선
  - [ ] 라우팅 정확도 80% 이상 목표
  - [ ] 실패한 케이스 분석 및 프롬프트 개선

**참고**: [담당역할_04](../roles/담당역할_04_임예슬_프롬프트_엔지니어링.md) 473-535줄

---

## 📦 프롬프트 파일 구조

```
prompts/                           # 프롬프트 데이터 (프로젝트 최상위)
├── routing_prompts.json          # 라우팅 프롬프트 + Few-shot 예시
├── tool_prompts.json              # 6개 도구별 프롬프트
├── evaluation_prompts.json        # 평가 프롬프트
├── question_generation_prompts.json  # 질문 생성 프롬프트
└── golden_dataset.json            # Golden Dataset (테스트용 질문)

src/prompts/                       # 프롬프트 로더 코드
├── __init__.py                    # 모듈 초기화 및 Export
├── loader.py                      # JSON 파일 로더 유틸리티
└── README.md                      # 사용 가이드
```

**설계 원칙**: 데이터(`prompts/`)와 코드(`src/prompts/`) 분리

---

## 🔧 사용 예시

### 라우팅 프롬프트 사용

```python
# src/agent/nodes.py

from src.prompts import get_routing_prompt

def router_node(state: AgentState, exp_manager=None):
    """라우터 노드"""
    question = state["question"]

    # JSON 프롬프트 로드
    routing_prompt_template = get_routing_prompt()
    routing_prompt = routing_prompt_template.format(question=question)

    # LLM 호출
    tool_choice = llm.invoke(routing_prompt).content.strip()
    state["tool_choice"] = tool_choice
    return state
```

### 도구별 프롬프트 사용

```python
# src/tools/general_answer.py

from src.prompts import get_tool_prompt

def general_answer_node(state: AgentState, exp_manager=None):
    """일반 답변 노드"""
    difficulty = state.get("difficulty", "easy")

    # JSON 프롬프트 로드
    system_prompt = get_tool_prompt("general_answer", difficulty)

    # LLM 호출
    messages = [
        SystemMessage(content=system_prompt),
        HumanMessage(content=state["question"])
    ]
    response = llm.invoke(messages)
    state["final_answer"] = response.content
    return state
```

---

## ⚡️ 우선순위

### High Priority (필수)
1. **AI Agent 도구 라우팅 프롬프트** (⭐⭐⭐) - 1일
   - 가장 중요! Agent 성능의 핵심
2. **도구별 프롬프트 JSON화** (⭐⭐) - 1일

### Medium Priority (권장)
3. **Golden Dataset 확장 및 테스트** (⭐⭐) - 1일
4. **평가 프롬프트 구현** (⭐) - 1일

---

## 📚 참고 자료

### 필수 참고 문서
- [담당역할_04_임예슬_프롬프트_엔지니어링.md](../roles/담당역할_04_임예슬_프롬프트_엔지니어링.md) ⭐ - 전체 구현 가이드
- [src/prompts/README.md](../../src/prompts/README.md) - 프롬프트 로더 사용 가이드
- [멘토링 문서](../minutes/20251030/20251030_멘토링.md) - 프롬프트 인사이트 (lines 417-553)
- [15_프롬프트_엔지니어링.md](../PRD/15_프롬프트_엔지니어링.md) - 프롬프트 전략

### 외부 링크
- [Langchain Prompts](https://python.langchain.com/docs/modules/model_io/prompts/)
- [Few-Shot Prompting](https://python.langchain.com/docs/modules/model_io/prompts/few_shot_examples)
- [Prompt Engineering Guide](https://www.promptingguide.ai/)

---

## 💻 Feature 브랜치

**권장 브랜치**: `feature/prompt`

팀원이 `feature/prompt` 브랜치를 생성했다면, **해당 브랜치에서 모든 프롬프트 작업을 진행해도 무방**합니다.

```bash
# feature/prompt 브랜치로 전환
git checkout feature/prompt

# 작업 진행
# ...

# 커밋 및 푸시
git add .
git commit -m "feat: 라우팅 프롬프트 개선"
git push origin feature/prompt
```

**중요**: Git 초보인 경우 `feature/prompt` 하나만 사용하는 것을 강력히 권장합니다!

---

## 🔖 추천 라벨

`feature` `prompt` `ai-agent` `high-priority`

---

## ⚠️ 중요 사항

1. **AI Agent 도구 라우팅이 최우선**
   - Agent 성능의 핵심은 라우팅 정확도
   - Few-shot 예시 필수
   - 테스트를 통한 검증 필요

2. **JSON 형식 사용**
   - 프롬프트 관리 및 버전 관리 용이
   - 데이터(`prompts/`)와 코드(`src/prompts/`) 분리

3. **ExperimentManager 사용**
   - 모든 프롬프트 저장 및 로깅
   - 실험 추적 관리

4. **Golden Dataset으로 검증**
   - 라우팅 정확도 80% 이상 목표
   - 실패 케이스 분석 및 개선

5. **멘토 인사이트 반영**
   - 도구 설명 상세화
   - Few-shot 예시 적극 활용
   - 시나리오 템플릿 정의
   - 구조화된 출력 (JSON)

---
