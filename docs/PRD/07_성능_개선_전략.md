# 07. 성능 개선 전략

## 문서 정보
- **작성일**: 2025-10-30
- **프로젝트명**: 논문 리뷰 챗봇 (AI Agent + RAG)
- **팀명**: 연결의 민족

---

## 1. 캐싱 전략

### 1.1 캐싱 전략 흐름

```mermaid
graph TB
    subgraph Request["🔸 요청 처리"]
        direction LR
        A[사용자 요청<br/>질문 입력] --> B{캐시<br/>존재?}
        B -->|Yes| C[캐시된 답변<br/>즉시 반환]
        B -->|No| D[새로운 처리<br/>LLM/DB 호출]
    end

    subgraph Process["🔹 처리 & 캐싱"]
        direction LR
        D --> E[LLM/DB 처리<br/>시간 소요]
        E --> F[결과 캐시<br/>저장]
        F --> G[사용자에게<br/>답변 반환]
    end

    subgraph Benefit["🔺 성능 향상"]
        direction LR
        H[응답 시간 단축<br/>50~90%] --> I[API 비용 절감]
        I --> J[사용자 경험 개선]
    end

    Request --> Process
    Process --> Benefit
    C --> Benefit

    %% Subgraph 스타일
    style Request fill:#e1f5ff,stroke:#01579b,stroke-width:3px,color:#000
    style Process fill:#f3e5f5,stroke:#4a148c,stroke-width:3px,color:#000
    style Benefit fill:#e8f5e9,stroke:#1b5e20,stroke-width:3px,color:#000

    %% 노드 스타일
    style A fill:#90caf9,stroke:#1976d2,color:#000
    style B fill:#ba68c8,stroke:#7b1fa2,color:#fff
    style C fill:#66bb6a,stroke:#2e7d32,color:#fff
    style D fill:#64b5f6,stroke:#1976d2,color:#000
    style E fill:#ce93d8,stroke:#7b1fa2,color:#000
    style F fill:#ba68c8,stroke:#7b1fa2,color:#fff
    style G fill:#ab47bc,stroke:#4a148c,color:#fff
    style H fill:#a5d6a7,stroke:#388e3c,color:#000
    style I fill:#81c784,stroke:#2e7d32,color:#000
    style J fill:#66bb6a,stroke:#2e7d32,color:#fff
```

### 1.2 LLM 응답 캐싱

```python
from functools import lru_cache

@lru_cache(maxsize=100)
def cached_llm_call(prompt_hash):
    """LLM 응답 캐싱 (동일 질문에 대한 중복 호출 방지)"""
    return llm.invoke(prompt)
```

### 1.2 Vector DB 검색 캐싱

```python
@lru_cache(maxsize=50)
def cached_similarity_search(query_hash, k):
    """검색 결과 캐싱"""
    return vectorstore.similarity_search(query, k=k)
```

---

## 2. 비동기 처리

### 2.1 비동기 Agent 실행

```python
import asyncio

async def async_agent_invoke(question, difficulty):
    """비동기 Agent 실행"""
    result = await agent_executor.ainvoke({
        "question": question,
        "difficulty": difficulty
    })
    return result
```

### 2.2 배치 임베딩

```python
# 배치로 임베딩 생성 (한 번에 여러 문서 처리)
embeddings.embed_documents(texts, batch_size=100)
```

---

## 3. 데이터베이스 최적화

### 3.1 인덱스 활용

```sql
-- 자주 조회하는 컬럼에 인덱스 생성
CREATE INDEX idx_papers_title ON papers USING GIN (to_tsvector('english', title));
CREATE INDEX idx_papers_category ON papers(category);
```

### 3.2 Connection Pooling

```python
from psycopg2 import pool

connection_pool = pool.SimpleConnectionPool(
    minconn=1,
    maxconn=10,
    **db_config
)
```

---

## 4. 참고 자료

- Langchain Performance: https://python.langchain.com/docs/guides/performance
- PostgreSQL Tuning: https://www.postgresql.org/docs/current/performance-tips.html
