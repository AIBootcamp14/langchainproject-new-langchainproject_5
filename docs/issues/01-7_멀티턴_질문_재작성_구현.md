# ë©€í‹°í„´ ì§ˆë¬¸ ì¬ì‘ì„± ê¸°ëŠ¥ êµ¬í˜„

## ğŸ“‹ ë¬¸ì„œ ì •ë³´
- **ì‘ì„±ì¼**: 2025-11-05
- **ì‘ì„±ì**: ìµœí˜„í™”[íŒ€ì¥]
- **ì´ìŠˆ ìœ í˜•**: ê¸°ëŠ¥ êµ¬í˜„
- **ìš°ì„ ìˆœìœ„**: â­â­â­â­ (í•„ìˆ˜ - ë©€í‹°í„´ ëŒ€í™” í•µì‹¬ ê¸°ëŠ¥)
- **ìƒíƒœ**: âœ… ì™„ë£Œ

---

## ğŸ¯ ì´ìŠˆ ê°œìš”

### ë¬¸ì œ ìƒí™©
LLMì´ ì´ì „ ëŒ€í™” ë§¥ë½ì„ íŒŒì•…í•˜ì—¬ `query` í•„ë“œë¥¼ ìƒì„±í•˜ì§€ë§Œ, **ì´ ì •ë³´ê°€ ë„êµ¬ì—ê²Œ ì „ë‹¬ë˜ì§€ ì•Šì•„ ë²„ë ¤ì§€ëŠ” ë¬¸ì œ** ë°œìƒ.

**ì˜ˆì‹œ**:
```
[1] ì‚¬ìš©ì: "Vision Transformerê°€ ë­ì•¼?"
    â†’ glossary ì‹¤í–‰ â†’ "Vision TransformerëŠ”..."

[2] ì‚¬ìš©ì: "ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜"
    â†’ LLM ë¶„ì„: {"query": "Vision Transformer survey paper"} âœ…
    â†’ ë¬¸ì œ: query ì •ë³´ê°€ ë„êµ¬ì—ê²Œ ì „ë‹¬ ì•ˆ ë¨ âŒ
    â†’ search_paper("ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜") - ëª¨í˜¸í•œ ê²€ìƒ‰ âŒ
```

### ê·¼ë³¸ ì›ì¸
1. **Query í•„ë“œ ë¯¸ì‚¬ìš©**: LLM ì‘ë‹µì˜ `query` ì •ë³´ê°€ stateì— ì €ì¥ë˜ì§€ ì•ŠìŒ
2. **ë„êµ¬ ì „ë‹¬ êµ¬ì¡°**: ë„êµ¬ ë…¸ë“œê°€ í•­ìƒ ì›ë³¸ `state["question"]`ë§Œ ì‚¬ìš©
3. **JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ ì •ë³´ ì†ì‹¤**: íŒŒì‹± ì‹¤íŒ¨í•˜ë©´ query ì •ë³´ ì™„ì „íˆ ë²„ë ¤ì§

---

## ğŸ“ í•´ê²° ë°©ì•ˆ

### ë°©ì•ˆ 1: Query í•„ë“œ í™œìš© (âœ… ì±„íƒ)
LLMì´ ìƒì„±í•œ `query` í•„ë“œë¥¼ stateì— ì €ì¥í•˜ê³  ë„êµ¬ì—ì„œ ìš°ì„  ì‚¬ìš©

**ì¥ì **:
- ê¸°ì¡´ LLM ì‘ë‹µ ì¬ì‚¬ìš©
- ìµœì†Œ ì½”ë“œ ë³€ê²½
- ì¶”ê°€ LLM í˜¸ì¶œ ì—†ìŒ

### ë°©ì•ˆ 3: Multi-Query Retrieval í™œì„±í™” (âœ… ì±„íƒ)
ê²€ìƒ‰ ë„êµ¬ì—ì„œ LLMì´ ìë™ìœ¼ë¡œ ì—¬ëŸ¬ ì¿¼ë¦¬ ìƒì„±

**ì¥ì **:
- ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ
- Fallbackìœ¼ë¡œ ì¶”ê°€ ë³´ê°•

**â†’ ë°©ì•ˆ 1 + ë°©ì•ˆ 3 ì¡°í•© ì±„íƒ**

---

## ğŸ”§ êµ¬í˜„ ìƒì„¸

### 1. Stateì— refined_query í•„ë“œ ì¶”ê°€

**íŒŒì¼**: `src/agent/state.py`

**ìˆ˜ì • ì „**:
```python
class AgentState(TypedDict, total=False):
    question: str                               # ì‚¬ìš©ì ì§ˆë¬¸
    difficulty: str                             # ë‚œì´ë„ (easy/hard)
```

**ìˆ˜ì • í›„**:
```python
class AgentState(TypedDict, total=False):
    question: str                               # ì‚¬ìš©ì ì§ˆë¬¸
    refined_query: str                          # ë§¥ë½ì„ ê³ ë ¤í•˜ì—¬ ì¬ì‘ì„±ëœ ì§ˆë¬¸ (Multi-turn ì§€ì›)
    difficulty: str                             # ë‚œì´ë„ (easy/hard)
```

---

### 2. router_nodeì—ì„œ query í•„ë“œ ì¶”ì¶œ ë° ì €ì¥

**íŒŒì¼**: `src/agent/nodes.py`

#### 2.1. JSON íŒŒì‹± ì„±ê³µ ì‹œ (Line 174-186)

**ìˆ˜ì • ì „**:
```python
# {"tools": [{"name": "xxx"}]} í˜•ì‹
if "tools" in parsed and len(parsed["tools"]) > 0:
    tool_name = parsed["tools"][0].get("name", "general")
    # âŒ query í•„ë“œëŠ” ë¬´ì‹œë¨

    if ("search_paper" in tool_name.lower() or ...):
        tool_choice = "search_paper"
```

**ìˆ˜ì • í›„**:
```python
# {"tools": [{"name": "xxx", "query": "..."}]} í˜•ì‹
if "tools" in parsed and len(parsed["tools"]) > 0:
    tool_info = parsed["tools"][0]
    tool_name = tool_info.get("name", "general")

    # âœ… query í•„ë“œ ì¶”ì¶œ (Multi-turn ì§€ì›)
    if "query" in tool_info and tool_info["query"]:
        refined_query = tool_info["query"].strip()
        if refined_query:
            state["refined_query"] = refined_query
            if exp_manager:
                exp_manager.logger.write(f"ì¬ì‘ì„±ëœ ì§ˆë¬¸: {refined_query}")

    # ë„êµ¬ëª… ì¶”ì¶œ
    if ("search_paper" in tool_name.lower() or ...):
        tool_choice = "search_paper"
```

#### 2.2. JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œì—ë„ query ì¶”ì¶œ (Line 217-230)

**ì¶”ê°€ ì½”ë“œ**:
```python
except (json.JSONDecodeError, KeyError, IndexError) as e:
    # JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ í‚¤ì›Œë“œ ê¸°ë°˜ í´ë°± ë§¤ì¹­
    if exp_manager:
        exp_manager.logger.write(f"JSON íŒŒì‹± ì‹¤íŒ¨: {str(e)}", print_error=True)

    # âœ… íŒŒì‹± ì‹¤íŒ¨í•´ë„ query í•„ë“œ ì¶”ì¶œ ì‹œë„ (regex ì‚¬ìš©)
    import re
    query_match = re.search(r'"query"\s*:\s*"([^"]+)"', cleaned_response)
    if query_match:
        refined_query = query_match.group(1).strip()
        if refined_query:
            state["refined_query"] = refined_query
            if exp_manager:
                exp_manager.logger.write(f"ì¬ì‘ì„±ëœ ì§ˆë¬¸ (regex ì¶”ì¶œ): {refined_query}")

    # ì‚¬ìš©ì ì§ˆë¬¸ê³¼ LLM ì‘ë‹µ ëª¨ë‘ ì²´í¬ (í‚¤ì›Œë“œ í´ë°±)
    # ...
```

**í•µì‹¬**: JSON íŒŒì‹±ì´ ì‹¤íŒ¨í•´ë„ regexë¡œ query í•„ë“œë¥¼ ì¶”ì¶œí•˜ì—¬ ì •ë³´ ì†ì‹¤ ë°©ì§€

---

### 3. ë„êµ¬ ë…¸ë“œì—ì„œ refined_query ìš°ì„  ì‚¬ìš©

#### 3.1. search_paper_node ìˆ˜ì •

**íŒŒì¼**: `src/tools/search_paper.py`

**ìˆ˜ì • ì „** (Line 249):
```python
question = state["question"]  # ì›ë³¸ ì§ˆë¬¸ë§Œ ì‚¬ìš©
```

**ìˆ˜ì • í›„** (Line 249-261):
```python
# âœ… refined_query ìš°ì„  ì‚¬ìš© (Multi-turn ì§€ì›)
question = state.get("refined_query", state["question"])  # ì¬ì‘ì„±ëœ ì§ˆë¬¸ ìš°ì„ , ì—†ìœ¼ë©´ ì›ë³¸
difficulty = state.get("difficulty", "easy")

# ë¡œê¹…
if tool_logger:
    if "refined_query" in state:
        tool_logger.write(f"RAG ê²€ìƒ‰ ë…¸ë“œ ì‹¤í–‰: {question} (ì¬ì‘ì„±ëœ ì§ˆë¬¸)")
    else:
        tool_logger.write(f"RAG ê²€ìƒ‰ ë…¸ë“œ ì‹¤í–‰: {question}")
```

#### 3.2. Multi-Query Retrieval í™œì„±í™” (Line 273)

**ìˆ˜ì • ì „**:
```python
raw_results = search_paper_database.invoke({
    "query": question,
    "use_multi_query": False,  # âŒ MultiQuery ë¯¸ì‚¬ìš©
    # ...
})
```

**ìˆ˜ì • í›„**:
```python
raw_results = search_paper_database.invoke({
    "query": question,
    "use_multi_query": True,  # âœ… MultiQuery í™œì„±í™” (ê²€ìƒ‰ ê°•í™”)
    # ...
})
```

**íš¨ê³¼**: LLMì´ ìë™ìœ¼ë¡œ ì—¬ëŸ¬ ê²€ìƒ‰ ì¿¼ë¦¬ë¥¼ ìƒì„±í•˜ì—¬ ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ

---

#### 3.3. glossary_node ìˆ˜ì •

**íŒŒì¼**: `src/tools/glossary.py`

**ìˆ˜ì • ë‚´ìš©**: `search_paper_node`ì™€ ë™ì¼í•˜ê²Œ ìˆ˜ì • (Line 440-452)

```python
# âœ… refined_query ìš°ì„  ì‚¬ìš© (Multi-turn ì§€ì›)
question = state.get("refined_query", state["question"])

if tool_logger:
    if "refined_query" in state:
        tool_logger.write(f"ìš©ì–´ì§‘ ë…¸ë“œ ì‹¤í–‰: {question} (ì¬ì‘ì„±ëœ ì§ˆë¬¸)")
    else:
        tool_logger.write(f"ìš©ì–´ì§‘ ë…¸ë“œ ì‹¤í–‰: {question}")
```

---

## âœ… ê°œì„  íš¨ê³¼

### 1. ë©€í‹°í„´ ì§ˆë¬¸ ì¬ì‘ì„± ì •ìƒ ì‘ë™

**ì´ì „**:
```
ì‚¬ìš©ì: "ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜"
â†’ LLM ë¶„ì„: {"query": "Vision Transformer survey paper"}
â†’ query ì •ë³´ ë²„ë ¤ì§ âŒ
â†’ search_paper("ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜") - ëª¨í˜¸í•œ ê²€ìƒ‰
â†’ ê²€ìƒ‰ ì‹¤íŒ¨
```

**ê°œì„  í›„**:
```
ì‚¬ìš©ì: "ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜"
â†’ LLM ë¶„ì„: {"query": "Vision Transformer survey paper"}
â†’ state["refined_query"] = "Vision Transformer survey paper" âœ…
â†’ search_paper("Vision Transformer survey paper") - ëª…í™•í•œ ê²€ìƒ‰
â†’ ì •í™•í•œ ë…¼ë¬¸ ê²€ìƒ‰ ì„±ê³µ
```

### 2. JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œì—ë„ ì •ë³´ ë³´ì¡´

**ì´ì „**:
```
JSON íŒŒì‹± ì‹¤íŒ¨ (Extra data ì—ëŸ¬)
â†’ query ì •ë³´ ì™„ì „íˆ ì†ì‹¤ âŒ
â†’ í‚¤ì›Œë“œ í´ë°±ìœ¼ë¡œ ë„êµ¬ ì„ íƒ
â†’ ì›ë³¸ ì§ˆë¬¸ìœ¼ë¡œ ê²€ìƒ‰
```

**ê°œì„  í›„**:
```
JSON íŒŒì‹± ì‹¤íŒ¨ (Extra data ì—ëŸ¬)
â†’ regexë¡œ query í•„ë“œ ì¶”ì¶œ âœ…
â†’ state["refined_query"] ì €ì¥ âœ…
â†’ ì¬ì‘ì„±ëœ ì§ˆë¬¸ìœ¼ë¡œ ê²€ìƒ‰
```

### 3. Multi-Query ê²€ìƒ‰ ê°•í™”

**ì´ì „**:
```
query = "ê´€ë ¨ ë…¼ë¬¸"
â†’ ë‹¨ì¼ ì¿¼ë¦¬ë¡œ ê²€ìƒ‰
â†’ ê²€ìƒ‰ ê²°ê³¼ ë¶€ì¡±
```

**ê°œì„  í›„**:
```
query = "Vision Transformer survey"
â†’ LLMì´ ìë™ìœ¼ë¡œ ì—¬ëŸ¬ ì¿¼ë¦¬ ìƒì„±:
  - "Vision Transformer architecture"
  - "ViT image classification"
  - "Transformer computer vision"
â†’ ë‹¤ì–‘í•œ ì¿¼ë¦¬ë¡œ ê²€ìƒ‰
â†’ ê²€ìƒ‰ ê²°ê³¼ í’ë¶€
```

---

## ğŸ§ª í…ŒìŠ¤íŠ¸ ê²°ê³¼

### í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸: `scripts/tests/test_question_rewriting.py`

```
================================================================================
ë©€í‹°í„´ ì§ˆë¬¸ ì¬ì‘ì„± í…ŒìŠ¤íŠ¸
================================================================================

[í…ŒìŠ¤íŠ¸] 'ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜' â†’ LLM query í•„ë“œ ì¶”ì¶œ
--------------------------------------------------------------------------------

ì›ë³¸ ì§ˆë¬¸: ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜
ì¬ì‘ì„±ëœ ì§ˆë¬¸: Vision Transformer ViT computer vision transformer image patches self-attention survey
ì„ íƒëœ ë„êµ¬: search_paper
ë¼ìš°íŒ… ë°©ë²•: keyword_fallback

âœ… í…ŒìŠ¤íŠ¸ í†µê³¼: refined_query í•„ë“œê°€ stateì— ì €ì¥ë¨
   â†’ LLMì´ íŒŒì•…í•œ ë§¥ë½: 'Vision Transformer ViT...'
   â†’ ë§¥ë½ ì •ë³´ ì •í™•íˆ íŒŒì•…ë¨ âœ…

[ë„êµ¬ ë…¸ë“œ ì‹œë®¬ë ˆì´ì…˜] search_paper_nodeê°€ ë°›ì„ ì§ˆë¬¸
--------------------------------------------------------------------------------
ë„êµ¬ê°€ ë°›ëŠ” ì§ˆë¬¸: Vision Transformer ViT computer vision transformer...
âœ… ë„êµ¬ê°€ ì¬ì‘ì„±ëœ ì§ˆë¬¸(ëª…í™•)ì„ ë°›ìŒ â†’ ì •í™•í•œ ê²€ìƒ‰ ê°€ëŠ¥

[í…ŒìŠ¤íŠ¸ 3] Multi-Query Retrieval í™œì„±í™” í™•ì¸
--------------------------------------------------------------------------------
âœ… use_multi_query: Trueë¡œ ì„¤ì •ë¨
   â†’ LLMì´ ìë™ìœ¼ë¡œ ì—¬ëŸ¬ ê²€ìƒ‰ ì¿¼ë¦¬ ìƒì„±í•˜ì—¬ ê²€ìƒ‰ ê°•í™”
```

---

## ğŸ“ ìˆ˜ì •ëœ íŒŒì¼ ëª©ë¡

| íŒŒì¼ ê²½ë¡œ | ìˆ˜ì • ë‚´ìš© | ë³€ê²½ ë¼ì¸ |
|-----------|----------|-----------|
| `src/agent/state.py` | `refined_query` í•„ë“œ ì¶”ê°€ | 24, 52 |
| `src/agent/nodes.py` | JSON íŒŒì‹± ì‹œ query í•„ë“œ ì¶”ì¶œ ë° ì €ì¥ | 174-186 |
| `src/agent/nodes.py` | JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ regexë¡œ query ì¶”ì¶œ | 217-230 |
| `src/tools/search_paper.py` | refined_query ìš°ì„  ì‚¬ìš© | 249-261 |
| `src/tools/search_paper.py` | use_multi_query Trueë¡œ ë³€ê²½ | 273 |
| `src/tools/glossary.py` | refined_query ìš°ì„  ì‚¬ìš© | 440-452 |
| `scripts/tests/test_question_rewriting.py` | ì§ˆë¬¸ ì¬ì‘ì„± í…ŒìŠ¤íŠ¸ ìŠ¤í¬ë¦½íŠ¸ ì‘ì„± (ì‹ ê·œ) | ì „ì²´ |

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **[ë©€í‹°í„´_ë§¥ë½ì°¸ì¡°_ë¼ìš°íŒ…_ê°œì„ .md](./ë©€í‹°í„´_ë§¥ë½ì°¸ì¡°_ë¼ìš°íŒ…_ê°œì„ .md)** - Multi-turn ë§¥ë½ ì°¸ì¡° ê°ì§€ êµ¬í˜„
- **[06_ë¼ìš°í„°_ì‹œìŠ¤í…œ.md](../modularization/06_ë¼ìš°í„°_ì‹œìŠ¤í…œ.md)** - ë¼ìš°í„° ë…¸ë“œ ì„¤ëª…
- **[09_ë„êµ¬_ì‹œìŠ¤í…œ.md](../modularization/09_ë„êµ¬_ì‹œìŠ¤í…œ.md)** - ë„êµ¬ ë…¸ë“œ ì„¤ëª…

---

## ğŸ“ ìš”ì•½

### ë¬¸ì œ
- LLMì´ ë§¥ë½ íŒŒì•…í•˜ì—¬ query í•„ë“œ ìƒì„±í–ˆì§€ë§Œ ë„êµ¬ì—ê²Œ ì „ë‹¬ ì•ˆ ë¨
- JSON íŒŒì‹± ì‹¤íŒ¨ ì‹œ query ì •ë³´ ì™„ì „íˆ ì†ì‹¤

### í•´ê²°
1. **refined_query í•„ë“œ ì¶”ê°€**: Stateì— ì¬ì‘ì„±ëœ ì§ˆë¬¸ ì €ì¥
2. **Query í•„ë“œ ì¶”ì¶œ**: JSON íŒŒì‹± ì„±ê³µ/ì‹¤íŒ¨ ì‹œ ëª¨ë‘ query ì¶”ì¶œ
3. **Regex Fallback**: íŒŒì‹± ì‹¤íŒ¨ ì‹œì—ë„ regexë¡œ query ì¶”ì¶œ
4. **ë„êµ¬ ë…¸ë“œ ìˆ˜ì •**: refined_query ìš°ì„  ì‚¬ìš©
5. **Multi-Query í™œì„±í™”**: ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ

### íš¨ê³¼
- **ë©€í‹°í„´ ëŒ€í™” ì •ìƒ ì‘ë™** âœ…
- **ë§¥ë½ ì •ë³´ ì •í™•íˆ ì „ë‹¬** âœ…
- **ê²€ìƒ‰ í’ˆì§ˆ í–¥ìƒ** âœ…
- **ì •ë³´ ì†ì‹¤ ë°©ì§€** âœ…

ì´ì œ ì‚¬ìš©ìê°€ "ê´€ë ¨ ë…¼ë¬¸ ì°¾ì•„ì¤˜" ìš”ì²­ ì‹œ:
- LLMì´ "Vision Transformer survey paper"ë¡œ ì¬ì‘ì„±
- ì¬ì‘ì„±ëœ ì§ˆë¬¸ì´ search_paper ë„êµ¬ì—ê²Œ ì „ë‹¬
- ì •í™•í•œ ë…¼ë¬¸ ê²€ìƒ‰ ì„±ê³µ
