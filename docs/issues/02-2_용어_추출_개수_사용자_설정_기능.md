# Issue 02-2: 용어 추출 개수 사용자 설정 기능

## 이슈 정보
- **작성일**: 2025-11-04
- **우선순위**: ⭐⭐⭐ (높음)
- **카테고리**: Feature (기능 추가)
- **작업자**: 최현화[팀장]
- **예상 소요 시간**: 3시간

---

## 문제 현황

### 현재 구현 상태

**하드코딩된 용어 추출 개수:**
- `src/utils/glossary_extractor.py:70`에 "최대 5개 용어만 추출하세요" 하드코딩
- 사용자가 용어 추출 개수를 조정할 수 없음
- 모든 답변에 대해 일률적으로 최대 5개만 추출

**코드 위치:**
```python
# src/utils/glossary_extractor.py:70
extraction_prompt = f"""...
주의사항:
- AI/ML 관련 전문 용어만 추출하세요
- easy_explanation은 비유와 예시를 사용하여 쉽게 설명
- hard_explanation은 기술적 세부사항과 수식을 포함
- 일반적인 단어는 제외하세요
- 최대 5개 용어만 추출하세요  ← 하드코딩
- 용어가 없으면 빈 리스트를 반환하세요
"""
```

### 문제점

1. **유연성 부족**: 사용자가 상황에 따라 추출 개수를 조정할 수 없음
2. **제한적 DB 확장**: 5개 이상의 용어가 있어도 추출 안 됨
3. **사용자 제어 불가**: UI에서 설정 불가능

---

## 요구사항 상세

### 1. UI 추가 (Streamlit Sidebar)

**위치:** `ui/components/sidebar.py`

**요구사항:**
- 사이드바에 "용어 추출 설정" 섹션 추가
- 2가지 입력 방식 제공 (동기화 필수):
  1. **슬라이더**: 마우스 드래그로 최소-최대 범위 조정 (1~100개)
  2. **텍스트 입력**: 최소값/최대값 수동 입력

**동기화 조건:**
- 슬라이더 값 변경 시 → 텍스트 입력 자동 업데이트
- 텍스트 입력 값 변경 시 → 슬라이더 자동 업데이트
- 둘 중 어떤 값을 바꿔도 즉시 반영

**UI 레이아웃 예시:**
```
⚙️ 설정
  📚 답변 난이도 선택
    ...

  📖 용어 추출 설정
    용어 추출 개수 범위:

    슬라이더: [━━━━━━━●━━━━━━━●━━━━] (5 - 15)
              1                              100

    최소 개수: [5 ]  최대 개수: [15]

    ℹ️ 답변에서 추출할 AI/ML 용어 개수 범위를 설정합니다.
       IT 관련 용어만 추출되며, 품질 우선으로 저장됩니다.
```

---

### 2. 용어 추출 로직 개선

**위치:** `src/utils/glossary_extractor.py`

**변경 사항:**

**2.1. 함수 시그니처 변경**
```python
# 기존
def extract_terms_from_answer(answer: str, difficulty: str = "easy", logger=None) -> List[Dict[str, str]]:

# 변경
def extract_terms_from_answer(
    answer: str,
    difficulty: str = "easy",
    min_terms: int = 1,      # 추가
    max_terms: int = 5,      # 추가
    logger=None
) -> List[Dict[str, str]]:
```

**2.2. 프롬프트 동적 생성**
```python
extraction_prompt = f"""다음 답변에서 사용된 AI/ML 관련 전문 용어를 추출하고...

주의사항:
- AI/ML 관련 전문 용어만 추출하세요
- IT/컴퓨터 과학 관련 용어만 대상으로 합니다
- 일반적인 단어는 제외하세요
- 용어를 정확성/유사도 순으로 우선순위를 정하세요
- **최소 {min_terms}개 ~ 최대 {max_terms}개 용어를 추출하세요**
- IT 용어가 {min_terms}개 미만이면 실제 추출된 개수만 반환하세요
- 개수를 맞추기 위해 무작위 단어를 포함하지 마세요
- 용어가 없으면 빈 리스트를 반환하세요
"""
```

**2.3. 품질 검증 로직**
```python
def validate_extracted_terms(terms: List[Dict], min_terms: int, max_terms: int) -> List[Dict]:
    """
    추출된 용어의 품질 검증 및 필터링

    조건:
    - IT/ML 관련 용어만 포함
    - 정확성/유사도 높은 순으로 정렬
    - min_terms 미만이어도 무작위 단어 추가 금지
    - max_terms 초과 시 상위 max_terms개만 반환
    """
    # IT 키워드 리스트 (확장 가능)
    it_keywords = [
        "learning", "network", "neural", "algorithm", "data", "model",
        "training", "deep", "machine", "artificial", "intelligence",
        "transformer", "attention", "embedding", "vector", "tensor",
        "gradient", "optimization", "loss", "activation", "layer",
        ...
    ]

    # IT 용어 필터링 (키워드 포함 여부 체크)
    filtered_terms = []
    for term in terms:
        term_lower = term["term"].lower()
        if any(keyword in term_lower for keyword in it_keywords):
            filtered_terms.append(term)

    # 최대 개수 제한
    return filtered_terms[:max_terms]
```

---

### 3. UI-Backend 연동

**위치:** `ui/components/chat_interface.py`

**변경 사항:**

**3.1. 설정값 가져오기**
```python
# session_state에서 용어 추출 설정 읽기
min_terms = st.session_state.get("glossary_min_terms", 1)
max_terms = st.session_state.get("glossary_max_terms", 5)
```

**3.2. 용어 추출 호출 시 파라미터 전달**
```python
# 기존
saved_count = extract_and_save_terms(
    answer=answer,
    difficulty=difficulty,
    logger=exp_manager.logger
)

# 변경
saved_count = extract_and_save_terms(
    answer=answer,
    difficulty=difficulty,
    min_terms=min_terms,    # 추가
    max_terms=max_terms,    # 추가
    logger=exp_manager.logger
)
```

**3.3. 통합 함수 업데이트**
```python
# src/utils/glossary_extractor.py
def extract_and_save_terms(
    answer: str,
    difficulty: str = "easy",
    min_terms: int = 1,      # 추가
    max_terms: int = 5,      # 추가
    logger=None
) -> int:
    # 용어 추출
    terms = extract_terms_from_answer(answer, difficulty, min_terms, max_terms, logger)

    # 품질 검증
    validated_terms = validate_extracted_terms(terms, min_terms, max_terms)

    # 용어 저장
    saved_count = save_terms_to_glossary(validated_terms, logger)

    return saved_count
```

---

### 4. 중요 조건 및 검증 로직

**4.1. IT 용어 필터링**
```python
# 조건: AI/ML/IT 관련 용어만 저장
# 구현: 키워드 기반 필터링 + LLM의 카테고리 검증

def is_it_related_term(term: Dict) -> bool:
    """IT 관련 용어인지 검증"""
    term_name = term["term"].lower()
    category = term.get("category", "").lower()

    # IT 관련 키워드
    it_keywords = ["ai", "ml", "deep learning", "nlp", "cv", "computer", ...]

    # 카테고리 검증
    if any(keyword in category for keyword in it_keywords):
        return True

    # 용어명 검증
    if any(keyword in term_name for keyword in it_keywords):
        return True

    return False
```

**4.2. 개수 부족 시 처리**
```python
# 조건: 사용자가 5-15개로 설정했지만 IT 용어가 3개만 추출된 경우
# → 3개만 저장 (무작위 단어 추가 금지)

# 구현 예시:
사용자 설정: min_terms=5, max_terms=15
LLM 추출: 10개 용어 (일반 단어 포함)
IT 필터링 후: 3개 용어 (IT 관련만)
최종 저장: 3개 ← min_terms(5) 미만이지만 강제로 채우지 않음
```

**4.3. 우선순위 정렬**
```python
# 조건: 정확성/유사도 높은 순으로 우선순위
# 구현: LLM에게 우선순위 지시 + 카테고리 정확도 검증

extraction_prompt += """
용어를 다음 기준으로 우선순위를 정하세요:
1. 핵심 개념인 용어 우선 (예: Transformer, BERT)
2. 자주 사용된 용어 우선
3. 정의가 명확한 용어 우선
4. 일반 단어보다 전문 용어 우선

결과는 우선순위 높은 순서로 정렬하세요.
"""
```

---

## 구현 단계

### Phase 1: UI 추가 (sidebar.py)
1. 슬라이더 위젯 추가 (`st.slider`)
2. 텍스트 입력 위젯 추가 (`st.number_input`)
3. 양방향 동기화 로직 구현
4. session_state 저장

### Phase 2: Backend 로직 개선 (glossary_extractor.py)
1. 함수 시그니처 변경 (min_terms, max_terms 파라미터)
2. 프롬프트 동적 생성 로직
3. IT 용어 필터링 함수 추가
4. 품질 검증 로직 추가

### Phase 3: UI-Backend 연동 (chat_interface.py)
1. session_state에서 설정값 읽기
2. extract_and_save_terms 호출 시 파라미터 전달
3. 로그 메시지 업데이트

### Phase 4: 문서 업데이트
1. `docs/QnA/glossary_qna.md` Q2-3 답변 수정
2. 새로운 기능 설명 추가

---

## 예상 결과

### 기능 시연 시나리오

**시나리오 1: 기본 설정 (5-15개)**
```
사용자: "머신러닝이 뭐야?"
답변: "머신러닝은 데이터로부터 패턴을 학습하는 AI 기술입니다.
       Supervised Learning, Unsupervised Learning, Reinforcement Learning
       등이 있으며, Neural Network, Decision Tree 등의 알고리즘을 사용합니다."

추출 과정:
- LLM 추출: 8개 용어
- IT 필터링: 7개 (Machine Learning, AI, Supervised Learning, ...)
- 범위 체크: 5 ≤ 7 ≤ 15 → 7개 모두 저장
- 최종: 7개 저장
```

**시나리오 2: 용어 부족 (5-15개 설정, 3개만 추출)**
```
사용자: "GAN 설명해줘"
답변: "GAN은 Generator와 Discriminator로 구성됩니다."

추출 과정:
- LLM 추출: 3개 (GAN, Generator, Discriminator)
- IT 필터링: 3개 (모두 IT 용어)
- 범위 체크: 3 < 5(min) → **그대로 3개만 저장** (무작위 단어 추가 안 함)
- 최종: 3개 저장
```

**시나리오 3: 많은 용어 (10-30개 설정)**
```
사용자: "Transformer 구조 상세히 설명해줘"
답변: "Transformer는 Self-Attention, Multi-Head Attention, FFN, Layer Norm,
       Residual Connection, Positional Encoding, Encoder, Decoder, ..."

추출 과정:
- LLM 추출: 25개 용어
- IT 필터링: 20개 (IT 관련만)
- 범위 체크: 10 ≤ 20 ≤ 30 → 20개 모두 저장
- 최종: 20개 저장
```

---

## 테스트 케이스

### TC-1: 슬라이더 동기화
- 슬라이더로 5-15 선택 → 텍스트 입력 자동 업데이트
- 텍스트로 10-20 입력 → 슬라이더 자동 업데이트

### TC-2: 용어 추출 개수
- 설정: 1-5 / 추출: 3개 → 3개 저장
- 설정: 5-15 / 추출: 3개 → 3개 저장 (무작위 추가 안 함)
- 설정: 5-15 / 추출: 10개 → 10개 저장
- 설정: 5-15 / 추출: 20개 → 15개만 저장 (max 초과)

### TC-3: IT 용어 필터링
- 추출: ["Transformer", "사과", "바나나", "BERT"] → ["Transformer", "BERT"]만 저장

### TC-4: 우선순위 정렬
- LLM이 우선순위 높은 순으로 정렬
- 최대 개수 초과 시 상위 N개만 저장

---

## 참고 자료

### 관련 파일
- `src/utils/glossary_extractor.py` - 용어 추출 로직
- `ui/components/sidebar.py` - UI 설정
- `ui/components/chat_interface.py` - UI-Backend 연동
- `docs/QnA/glossary_qna.md` - 문서

### Streamlit 위젯
- `st.slider()` - 슬라이더
- `st.number_input()` - 숫자 입력
- `st.session_state` - 상태 관리

---

## 작업자 노트

### 주의사항
1. **무작위 단어 추가 금지**: min_terms 미달 시에도 강제로 채우지 않음
2. **IT 용어만 저장**: 일반 단어는 제외
3. **양방향 동기화 필수**: 슬라이더 ↔ 텍스트 입력 동기화
4. **품질 우선**: 개수보다 품질이 중요

### 확장 가능성
- IT 키워드 리스트 확장 (설정 파일로 분리)
- 카테고리별 필터링 (NLP, CV, RL 등)
- 용어 품질 점수 표시 (UI에 피드백)

---

**이슈 끝**
