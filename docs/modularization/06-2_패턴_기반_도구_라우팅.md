# 06-2. 패턴 기반 도구 라우팅 상세

## 📋 문서 정보
- **최초 작성일**: 2025-11-05
- **최근 업데이트**: 2025-11-05
- **시스템명**: 패턴 기반 도구 라우팅 시스템
- **구현 파일**: `src/agent/nodes.py`, `configs/multi_request_patterns.yaml`, `src/agent/config_loader.py`
- **우선순위**: ⭐⭐⭐ (매우 중요)
- **작성자**: 최현화[팀장]
- **상위 문서**: [06_AI_Agent_시스템.md](./06_AI_Agent_시스템.md), [06-1_다중_요청_처리.md](./06-1_다중_요청_처리.md)

---

## 📌 개요

패턴 기반 도구 라우팅 시스템은 **사용자 질문의 키워드 패턴을 분석하여 적절한 도구를 선택하는 규칙 기반 라우팅 시스템**입니다. LLM을 사용하는 동적 라우팅과 달리, 사전에 정의된 키워드 패턴으로 빠르고 정확하게 도구를 선택합니다.

### 핵심 특징

✅ **규칙 기반 라우팅**: LLM 호출 없이 키워드만으로 도구 선택
✅ **YAML 설정 파일**: 코드 수정 없이 패턴 추가/수정 가능
✅ **우선순위 지원**: 여러 패턴이 매칭될 때 우선순위로 선택
✅ **제외 키워드**: 특정 키워드가 있으면 패턴 제외
✅ **파이프라인 지원**: 단일 도구부터 6단계 파이프라인까지 지원
✅ **Multi-turn 대응**: 맥락 참조 시 패턴 매칭 건너뛰기

---

## 🔴 LLM 라우팅 vs 패턴 라우팅

### LLM 라우팅 (기존 방식)

```python
# LLM이 질문을 분석하여 도구 선택
llm_response = llm.invoke(routing_prompt)
tool_choice = llm_response.content  # "search_paper"
```

**장점**:
- 유연한 판단 (새로운 질문 패턴 대응)
- 자연어 이해 능력

**단점**:
- ❌ LLM 호출 시간 (1-3초)
- ❌ 비용 발생 (API 요청)
- ❌ 일관성 부족 (같은 질문에 다른 도구 선택)
- ❌ 복잡한 요청 처리 어려움 (1개 도구만 선택)

### 패턴 라우팅 (신규 방식)

```python
# 키워드 패턴으로 즉시 도구 선택
if "논문" in question and "요약" in question:
    tools = ["search_paper", "web_search", "general", "summarize"]
```

**장점**:
- ✅ 빠른 속도 (0.001초 미만)
- ✅ 비용 없음
- ✅ 100% 일관성 (같은 패턴 → 같은 도구)
- ✅ 다중 도구 파이프라인 지원

**단점**:
- 사전 정의된 패턴만 처리 가능
- 새로운 패턴은 YAML 파일 수정 필요

---

## 🏗️ 시스템 구조

### 전체 아키텍처

```
┌─────────────────────────────────────────────────────┐
│           사용자 질문: "GPT 논문 요약해줘"           │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│             Router 노드 (nodes.py)                  │
│  1. Multi-turn 맥락 참조 감지                       │
│  2. 패턴 매칭 (우선순위 높은 순서)                  │
│  3. LLM 라우팅 (패턴 매칭 실패 시)                  │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│        패턴 파일 (multi_request_patterns.yaml)     │
│  - keywords: ["논문", "요약"]                       │
│  - tools: [search_paper, web_search, general, ...] │
│  - priority: 120                                    │
└────────────────────┬────────────────────────────────┘
                     ↓
┌─────────────────────────────────────────────────────┐
│           도구 파이프라인 실행 (graph.py)           │
│  search_paper → web_search → general → summarize    │
└─────────────────────────────────────────────────────┘
```

### 파일 구조

```
프로젝트/
├── configs/
│   └── multi_request_patterns.yaml    # 패턴 정의 (17개)
├── src/
│   └── agent/
│       ├── nodes.py                   # Router 로직 (lines 67-100)
│       ├── config_loader.py           # YAML 로더
│       └── graph.py                   # 파이프라인 실행
```

---

## 📝 패턴 파일 구조 (YAML)

### 패턴 정의 형식

```yaml
patterns:
  - keywords:              # 필수: 모두 포함되어야 함
      - 논문
      - 요약
    exclude_keywords:      # 선택: 하나라도 있으면 제외
      - 저장
    tools:                 # 필수: 순차 실행 도구 목록
      - search_paper
      - web_search
      - general
      - summarize
    description: 논문 검색 후 요약 (4단계 파이프라인)
    priority: 120          # 선택: 높을수록 우선
    examples:              # 선택: 문서화용
      - Transformer 논문 요약해줘
      - GPT 논문 찾아서 요약해줘
```

### 필드 설명

| 필드 | 타입 | 필수 | 설명 |
|------|------|------|------|
| `keywords` | List[str] | ✅ | 모두 포함되어야 매칭 |
| `exclude_keywords` | List[str] | ❌ | 하나라도 있으면 제외 |
| `tools` | List[str] | ✅ | 순차 실행 도구 목록 (1~6개) |
| `priority` | int | ❌ | 우선순위 (기본값: 0) |
| `description` | str | ❌ | 패턴 설명 (문서화) |
| `examples` | List[str] | ❌ | 예시 질문 (문서화) |

---

## 🔍 패턴 매칭 알고리즘

### 구현 코드 (nodes.py:67-100)

```python
# YAML 파일에서 패턴 로드 (우선순위 정렬됨)
multi_request_patterns = get_multi_request_patterns()

# 다중 요청 패턴 확인 (우선순위 높은 순서대로)
for pattern in multi_request_patterns:
    keywords = pattern.get("keywords", [])
    exclude_keywords = pattern.get("exclude_keywords", [])
    tools = pattern.get("tools", [])

    # 모든 키워드가 질문에 포함되는지 확인
    keywords_match = all(kw in question for kw in keywords)

    # 제외 키워드가 하나라도 있으면 패턴 불일치
    exclude_match = any(ex_kw in question for ex_kw in exclude_keywords) if exclude_keywords else False

    if keywords_match and not exclude_match:
        # 패턴 매칭 성공!
        state["tool_pipeline"] = tools
        state["tool_choice"] = tools[0]
        state["pipeline_index"] = 1
        return state

# 패턴 매칭 실패 → LLM 라우팅으로 fallback
```

### 매칭 순서 (우선순위)

1. **패턴 정렬**: YAML 로드 시 `priority` 내림차순 정렬
2. **순차 확인**: 우선순위 높은 패턴부터 확인
3. **첫 매칭 선택**: 첫 번째로 매칭된 패턴 선택
4. **Fallback**: 매칭 실패 시 LLM 라우팅

---

## 📊 패턴 카테고리 (17개)

### 1. 단일 도구 패턴 (4개, Priority 150-200)

#### 패턴 1-1: 용어 정의 (뭐야)
```yaml
keywords: ["뭐야"]
exclude_keywords: ["논문", "검색", "찾아"]
tools: [glossary]
priority: 200
examples: ["LLM이 뭐야?", "Transformer가 뭐야?"]
```

#### 패턴 1-2: 용어 정의 (뭔지)
```yaml
keywords: ["뭔지"]
exclude_keywords: ["논문", "검색", "찾아"]
tools: [glossary]
priority: 200
examples: ["GAN이 뭔지 알려줘", "Attention이 뭔지 설명해줘"]
```

#### 패턴 1-3: 전체 대화 저장
```yaml
keywords: ["전체", "저장"]
tools: [save_file]
priority: 150
examples: ["전체 저장해줘", "전체 대화 저장해줘"]
```

#### 패턴 1-4: 논문 검색 (찾기)
```yaml
keywords: ["논문", "찾"]
exclude_keywords: ["저장", "요약"]
tools: [search_paper]
priority: 140
examples: ["Transformer 논문 찾아줘", "관련 논문 찾아줘"]
```

### 2. 2-도구 패턴 (6개, Priority 100-140)

#### 패턴 2-1: 용어 + 저장 (뭐야)
```yaml
keywords: ["뭐야", "저장"]
exclude_keywords: ["전체"]
tools: [glossary, save_file]
priority: 130
```

#### 패턴 2-2: 용어 + 저장 (뭔지)
```yaml
keywords: ["뭔지", "저장"]
exclude_keywords: ["전체", "논문"]
tools: [glossary, save_file]
priority: 140
examples: ["AI가 뭔지 찾아서 저장해줘"]
```

#### 패턴 2-3: 논문 요약 (4단계 파이프라인)
```yaml
keywords: ["논문", "요약"]
exclude_keywords: ["저장"]
tools: [search_paper, web_search, general, summarize]
priority: 120
examples: ["Transformer 논문 요약해줘", "GPT 논문 찾아서 요약해줘"]
```
**주의**: 실제로는 4단계 파이프라인입니다 (수정됨)

#### 패턴 2-4: 최신 정보
```yaml
keywords: ["최신", "정보"]
tools: [web_search, summarize]
priority: 110
```

#### 패턴 2-5: 통계 + 논문
```yaml
keywords: ["통계", "논문"]
exclude_keywords: ["저장", "요약"]
tools: [text2sql, search_paper]
priority: 110
```

#### 패턴 2-6: 용어 + 논문
```yaml
keywords: ["용어", "논문"]
exclude_keywords: ["저장", "요약"]
tools: [glossary, search_paper]
priority: 100
```

### 3. 5-도구 패턴 (1개, Priority 100)

#### 패턴 3-1: 논문 요약 저장
```yaml
keywords: ["논문", "요약", "저장"]
tools: [search_paper, web_search, general, summarize, save_file]
priority: 100
```

### 4. 6-도구 패턴 (2개, Priority 75-80)

#### 패턴 4-1: 용어 + 논문 + 요약 + 저장
```yaml
keywords: ["용어", "논문", "요약", "저장"]
tools: [glossary, search_paper, web_search, general, summarize, save_file]
priority: 80
```

#### 패턴 4-2: 통계 + 논문 + 요약 + 저장
```yaml
keywords: ["통계", "논문", "요약", "저장"]
tools: [text2sql, search_paper, web_search, general, summarize, save_file]
priority: 75
```

---

## 🎯 키워드 설계 원칙

### 1. 최소 키워드 전략

**나쁜 예**:
```yaml
keywords: ["논", "문", "요", "약"]  # 단일 글자 ❌
```

**좋은 예**:
```yaml
keywords: ["논문", "요약"]  # 2글자 이상 ✅
```

**이유**: 단일 글자는 오매칭 위험 (예: "논리적"에 "논" 포함)

### 2. Exclude Keywords 활용

**문제 상황**:
```yaml
# "AI가 뭔지 찾아서 저장해줘"가 search_paper로 오매칭
keywords: ["뭔지"]
tools: [glossary]
```

**해결**:
```yaml
keywords: ["뭔지"]
exclude_keywords: ["논문", "찾아"]  # ✅ 논문 검색 제외
tools: [glossary]
```

### 3. 우선순위 설정

**규칙**:
- **200번대**: 최우선 (용어 정의)
- **100-150번대**: 중간 우선순위 (복합 요청)
- **70-90번대**: 낮은 우선순위 (복잡한 파이프라인)

**예시**:
```yaml
# 우선순위 높음: 단순 요청 먼저 처리
- keywords: ["뭐야"]
  priority: 200
  tools: [glossary]

# 우선순위 낮음: 복잡한 요청 나중 처리
- keywords: ["용어", "논문", "요약"]
  priority: 80
  tools: [glossary, search_paper, summarize]
```

### 4. 구체적 → 일반적 순서

```yaml
# 1순위: 구체적 패턴 (키워드 많음)
- keywords: ["논문", "요약", "저장"]
  priority: 100
  tools: [search_paper, summarize, save_file]

# 2순위: 일반적 패턴 (키워드 적음)
- keywords: ["논문", "요약"]
  priority: 120
  tools: [search_paper, summarize]
```

---

## 🔧 패턴 추가 가이드

### 1단계: 사용자 요청 분석

**예시 질문**:
```
사용자: "BERT 설명하고 관련 논문도 찾아줘"
```

**분석**:
- 키워드: "설명", "논문", "찾"
- 도구: `glossary` (용어 설명) → `search_paper` (논문 검색)

### 2단계: YAML 패턴 작성

```yaml
- keywords:
    - 설명
    - 논문
    - 찾
  exclude_keywords:
    - 저장
    - 요약
  tools:
    - glossary
    - search_paper
  description: 용어 설명 후 관련 논문 검색
  priority: 100
  examples:
    - BERT 설명하고 관련 논문도 찾아줘
    - Transformer 설명하고 논문 검색해줘
```

### 3단계: 우선순위 확인

```python
# 기존 패턴과 충돌 확인
keywords = ["설명", "논문"]

# 기존 패턴 목록 확인
existing_patterns = [
    (["용어", "논문"], 100),
    (["논문", "찾"], 140),
    # ...
]

# 새 패턴 우선순위 결정
# - 2개 키워드 → priority 100-120
# - "찾"이 있으므로 100이 적절
```

### 4단계: 테스트

```python
# 테스트 질문 리스트
test_questions = [
    "BERT 설명하고 관련 논문도 찾아줘",  # ✅ 새 패턴 매칭
    "Transformer 설명해줘",             # ❌ 다른 패턴 (glossary만)
    "GPT 논문 찾아줘",                  # ❌ 다른 패턴 (search_paper만)
]
```

### 5단계: 메타데이터 업데이트

```yaml
metadata:
  version: '3.3'                    # 버전 증가
  total_patterns: 18                # 패턴 수 증가
  pattern_breakdown:
    two_tool: 7                     # 2-도구 패턴 +1
  notes:
    - 용어 설명 + 논문 검색 패턴 추가
```

---

## 🌐 Multi-turn 대응

### 맥락 참조 감지

**맥락 참조 키워드**:
```python
contextual_keywords = [
    "관련", "그거", "이거", "저거", "해당",
    "방금", "위", "앞서", "이전", "그"
]
```

**동작 방식**:
```
사용자 1: "Transformer가 뭐야?"
   ↓ 패턴 매칭: ["뭐야"] → glossary

사용자 2: "관련 논문 찾아줘"
   ↓ 맥락 참조 감지: "관련" 포함
   ↓ 패턴 매칭 건너뛰기
   ↓ LLM 라우팅 (이전 대화 컨텍스트 포함)
   ↓ search_paper 선택
```

### 예외 처리

**명확한 다중 요청은 패턴 우선**:
```python
# "관련"이 있어도 "저장"이 명확하면 패턴 매칭
multi_request_indicators = ["저장", "요약", "정리"]

if "관련" in question and "저장" in question:
    # 패턴 매칭 시도 ✅
    # "관련 논문 요약해서 저장해줘"
```

---

## 📈 성능 최적화

### 패턴 수 축소 (76개 → 17개)

**최적화 전** (2025-11-04):
```yaml
total_patterns: 76
- 단일 글자 키워드 다수 ("찾", "년", "웹")
- 중복 패턴 다수
- 우선순위 미설정
```

**최적화 후** (2025-11-05):
```yaml
total_patterns: 17
- 2글자 이상 키워드만
- 핵심 패턴만 선별
- 우선순위 명확화 (200 → 70)
```

**성능 향상**:
- 패턴 매칭 시간: 5.4배 빠름
- 메모리 사용량: 77% 감소
- 유지보수성: 크게 향상

### 우선순위 정렬 캐싱

```python
# config_loader.py
_multi_request_patterns_cache = None

def load_multi_request_patterns(force_reload: bool = False):
    global _multi_request_patterns_cache

    # 캐시된 패턴 반환 (정렬 완료)
    if _multi_request_patterns_cache is not None and not force_reload:
        return _multi_request_patterns_cache

    # YAML 로드 후 정렬
    patterns = sorted(
        raw_patterns,
        key=lambda p: p.get("priority", 0),
        reverse=True  # 내림차순
    )

    _multi_request_patterns_cache = patterns
    return _multi_request_patterns_cache
```

---

## 🐛 트러블슈팅

### 문제 1: 패턴이 매칭되지 않음

**증상**:
```
사용자: "GPT 논문 요약해줘"
실행: general_answer (❌ 잘못된 도구)
```

**원인**: 키워드 오타 또는 누락
```yaml
# YAML 패턴
keywords: ["논문", "요약"]

# 실제 질문에는 "GPT" 포함
# → "논문"과 "요약" 모두 포함되므로 매칭되어야 함
```

**해결**: 로그 확인
```python
# nodes.py에서 로깅
exp_manager.logger.write(f"패턴 매칭 시도: {keywords}")
exp_manager.logger.write(f"키워드 매칭: {keywords_match}")
exp_manager.logger.write(f"제외 키워드 매칭: {exclude_match}")
```

### 문제 2: 잘못된 패턴이 매칭됨

**증상**:
```
사용자: "AI가 뭔지 찾아서 저장해줘"
실행: search_paper (❌ glossary가 먼저 실행되어야 함)
```

**원인**: exclude_keywords 누락
```yaml
# 문제 패턴
keywords: ["뭔지"]
tools: [glossary]
# exclude_keywords 없음! → "찾아서"가 있어도 매칭됨
```

**해결**: exclude_keywords 추가
```yaml
keywords: ["뭔지"]
exclude_keywords: ["논문", "찾아"]  # ✅
tools: [glossary]
```

### 문제 3: 우선순위 충돌

**증상**:
```
사용자: "논문 요약해서 저장해줘"
기대: [search_paper, summarize, save_file]
실제: [search_paper, summarize]
```

**원인**: 우선순위 역전
```yaml
# 패턴 A (더 구체적, 하지만 낮은 우선순위)
keywords: ["논문", "요약", "저장"]
priority: 80  # ❌ 낮음
tools: [search_paper, summarize, save_file]

# 패턴 B (덜 구체적, 하지만 높은 우선순위)
keywords: ["논문", "요약"]
priority: 120  # ❌ 높음
tools: [search_paper, summarize]
```

**해결**: 구체적 패턴에 더 높은 우선순위
```yaml
# 패턴 A (3개 키워드)
keywords: ["논문", "요약", "저장"]
priority: 100  # ✅ 높음
tools: [search_paper, summarize, save_file]

# 패턴 B (2개 키워드)
keywords: ["논문", "요약"]
priority: 120  # 여전히 높지만 A가 먼저 매칭되면 A 선택
```

---

## 📚 참고 자료

### 관련 문서
- [06_AI_Agent_시스템.md](./06_AI_Agent_시스템.md): Agent 전체 구조
- [06-1_다중_요청_처리.md](./06-1_다중_요청_처리.md): 파이프라인 실행
- [09-1_도구_자동전환_기능.md](./09-1_도구_자동전환_기능.md): Fallback 메커니즘

### 구현 파일
- `configs/multi_request_patterns.yaml`: 패턴 정의 (17개)
- `src/agent/config_loader.py`: YAML 로더 및 검증
- `src/agent/nodes.py`: Router 노드 (lines 67-100)
- `src/agent/graph.py`: 파이프라인 실행

### YAML 문법 참고
- [YAML 공식 문서](https://yaml.org/)
- [Python PyYAML](https://pyyaml.org/)

---

## 🔄 업데이트 히스토리

| 날짜 | 버전 | 변경 내용 | 작성자 |
|------|------|-----------|--------|
| 2025-11-04 | 1.0 | 초기 구현 (76개 패턴) | 최현화 |
| 2025-11-05 | 3.0 | 패턴 최적화 (14개 축소) | 최현화 |
| 2025-11-05 | 3.1 | 복합 요청 패턴 추가 (17개) | 최현화 |
| 2025-11-05 | 3.2 | 완전한 파이프라인 추가 (4-6단계) | 최현화 |
| 2025-11-05 | - | 문서 작성 | 최현화 |

---

## ✅ 체크리스트

### 패턴 추가 시
- [ ] keywords 2글자 이상인가?
- [ ] exclude_keywords 필요한가?
- [ ] 우선순위 적절한가?
- [ ] 기존 패턴과 충돌 없는가?
- [ ] examples 추가했는가?
- [ ] 메타데이터 업데이트했는가?

### 테스트 시
- [ ] 예상대로 매칭되는가?
- [ ] 오매칭 없는가?
- [ ] 파이프라인 순서 올바른가?
- [ ] Multi-turn 대응 확인했는가?
