# 담당역할_01-1: 실험 관리 시스템

## 문서 정보
- **작성일**: 2025-10-31
- **프로젝트명**: 논문 리뷰 챗봇 (AI Agent + RAG)
- **팀명**: 연결의 민족
- **담당 기능**: 실험 관리 시스템, ExperimentManager 클래스, Session 자동 관리

---

## 담당자 정보

**담당자**: 최현화[팀장]

**역할**: 실험 관리 시스템 구축 및 ExperimentManager 클래스 구현

---

## 담당 업무 개요

이 역할은 프로젝트 전체에서 사용되는 **실험 관리 시스템** 구축을 담당합니다. 챗봇 실행 시마다 자동으로 폴더 구조를 생성하고, 모든 실행 정보(로그, DB 쿼리, 프롬프트, UI 인터랙션, 평가 지표)를 체계적으로 기록합니다.

### 주요 책임

1. **ExperimentManager 클래스 구현** (`src/utils/experiment_manager.py`)
   - Session ID 자동 부여 시스템
   - 7개 서브 폴더 자동 생성 및 관리
   - metadata.json 중앙 관리
   - 도구별 Logger 제공

2. **데이터 저장 메서드 구현**
   - DB 쿼리 및 검색 결과 저장
   - 프롬프트 기록 (system/user/final)
   - UI 인터랙션 로그
   - 평가 지표 저장 (RAG, Agent, 비용, 응답시간)
   - 최종 결과물 저장

3. **실험 검색 및 분석 도구**
   - metadata.json 기반 실험 검색
   - 평가 지표 집계 기능

---

## 참여 기간 및 우선순위

### 참여 기간
- **전체 기간 참여** (2025-10-28 ~ 2025-11-06, 10일)
- **우선 작업 기간**: 프로젝트 초기 (10/28-10/30, 3일)
  - ExperimentManager 클래스를 먼저 구현해야 다른 팀원들이 사용 가능

### 우선순위
1. **최우선 (Day 1-3)**: ExperimentManager 기본 기능 구현
   - 폴더 구조 자동 생성
   - Session ID 자동 부여
   - metadata.json 관리
   - 도구별 Logger 제공

2. **우선 (Day 4-6)**: 데이터 저장 메서드 구현
   - DB 쿼리 기록
   - 프롬프트 저장
   - UI 인터랙션 로그
   - 평가 지표 저장

3. **선택 (Day 7+)**: 실험 검색 및 분석 도구
   - find_experiments 스크립트
   - 평가 지표 집계 기능

---

## 세부 업무 및 구현 내용

### 1. ExperimentManager 클래스 기본 구조

**파일 경로**: `src/utils/experiment_manager.py`

#### 1.1 클래스 전체 코드

```python
import json
import yaml
from pathlib import Path
from datetime import datetime
from typing import Dict, List, Optional
from src.utils.logger import Logger


class ExperimentManager:
    """
    실험 폴더 생성 및 관리 클래스

    DB, UI, 프롬프트 등 모든 정보를 체계적으로 기록
    """

    def __init__(self):
        """실험 매니저 초기화"""
        today = datetime.now().strftime("%Y%m%d")
        time_now = datetime.now().strftime("%H%M%S")

        # 당일 session ID 생성
        session_id = self._get_next_session_id(today)

        # 메인 폴더
        self.experiment_dir = Path(
            f"experiments/{today}/{today}_{time_now}_session_{session_id:03d}"
        )
        self.experiment_dir.mkdir(parents=True, exist_ok=True)

        # 서브 폴더 생성
        self.tools_dir = self.experiment_dir / "tools"
        self.database_dir = self.experiment_dir / "database"
        self.prompts_dir = self.experiment_dir / "prompts"
        self.ui_dir = self.experiment_dir / "ui"
        self.outputs_dir = self.experiment_dir / "outputs"
        self.evaluation_dir = self.experiment_dir / "evaluation"
        self.debug_dir = self.experiment_dir / "debug"

        # 필수 폴더 생성
        for folder in [self.tools_dir, self.database_dir, self.prompts_dir,
                       self.ui_dir, self.outputs_dir, self.evaluation_dir]:
            folder.mkdir(exist_ok=True)

        # 메타데이터 초기화
        self.metadata = {
            'session_id': f"{session_id:03d}",
            'start_time': datetime.now().isoformat(),
            'difficulty': None,
            'tool_used': None,
            'user_query': None,
            'success': None,
            'response_time_ms': None,
            'end_time': None
        }

        self.metadata_file = self.experiment_dir / "metadata.json"

        # Logger 초기화
        self.logger = Logger(str(self.experiment_dir / "chatbot.log"))
        self.logger.write(f"세션 시작: session_{session_id:03d}")
        self.logger.write(f"폴더 경로: {self.experiment_dir}")

        # DB 관련 초기화
        self.db_queries = []
        self.pgvector_searches = []
        self.search_results = {}
        self.db_performance = {
            'summary': {},
            'queries': []
        }

    def _get_next_session_id(self, date: str) -> int:
        """당일 다음 session ID 반환"""
        date_dir = Path(f"experiments/{date}")
        if not date_dir.exists():
            return 1

        existing_sessions = list(date_dir.glob(f"{date}_*_session_*"))
        if not existing_sessions:
            return 1

        max_id = 0
        for session_dir in existing_sessions:
            try:
                session_id_str = session_dir.name.split('_')[-1]
                session_id = int(session_id_str)
                max_id = max(max_id, session_id)
            except (IndexError, ValueError):
                continue

        return max_id + 1

    # ===== 도구 로그 =====

    def get_tool_logger(self, tool_name: str) -> Logger:
        """
        도구별 Logger 생성

        Args:
            tool_name: 도구명 (rag_paper, rag_glossary, web_search 등)

        Returns:
            Logger 인스턴스
        """
        log_path = self.tools_dir / f"{tool_name}.log"
        return Logger(str(log_path))

    # ===== DB 관련 =====

    def log_sql_query(
        self,
        query: str,
        description: str = "",
        tool: str = "",
        execution_time_ms: Optional[int] = None
    ):
        """
        SQL 쿼리 기록

        Args:
            query: SQL 쿼리문
            description: 쿼리 설명
            tool: 사용한 도구명
            execution_time_ms: 실행 시간 (밀리초)
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

        query_record = f"""-- 실행 시간: {timestamp}
-- 도구: {tool}
-- 설명: {description}
"""
        if execution_time_ms:
            query_record += f"-- 실행 소요: {execution_time_ms}ms\n"

        query_record += f"\n{query};\n\n"

        self.db_queries.append(query_record)

        # queries.sql 파일에 즉시 추가
        with open(self.database_dir / "queries.sql", 'a', encoding='utf-8') as f:
            f.write(query_record)

        self.logger.write(f"SQL 쿼리 기록: {description}")

    def log_pgvector_search(self, search_info: Dict):
        """
        pgvector 검색 기록

        Args:
            search_info: 검색 정보 딕셔너리
                - tool: 도구명
                - collection: 컬렉션명
                - query_text: 검색 쿼리
                - top_k: 검색 결과 수
                - execution_time_ms: 실행 시간
                등
        """
        search_info['timestamp'] = datetime.now().isoformat()
        self.pgvector_searches.append(search_info)

        # pgvector_searches.json 업데이트
        with open(self.database_dir / "pgvector_searches.json", 'w', encoding='utf-8') as f:
            json.dump(self.pgvector_searches, f, ensure_ascii=False, indent=2)

        self.logger.write(f"pgvector 검색 기록: {search_info.get('tool', 'unknown')}")

    def save_search_results(self, tool_name: str, results: Dict):
        """
        DB 검색 결과 저장

        Args:
            tool_name: 도구명
            results: 검색 결과 딕셔너리
        """
        results['timestamp'] = datetime.now().isoformat()
        self.search_results[tool_name] = results

        # search_results.json 업데이트
        with open(self.database_dir / "search_results.json", 'w', encoding='utf-8') as f:
            json.dump(self.search_results, f, ensure_ascii=False, indent=2)

        self.logger.write(f"검색 결과 저장: {tool_name}")

    def save_db_performance(self, performance_data: Dict):
        """
        DB 성능 정보 저장

        Args:
            performance_data: 성능 데이터 딕셔너리
        """
        with open(self.database_dir / "db_performance.json", 'w', encoding='utf-8') as f:
            json.dump(performance_data, f, ensure_ascii=False, indent=2)

        self.logger.write("DB 성능 정보 저장 완료")

    # ===== 프롬프트 관련 =====

    def save_system_prompt(self, system_prompt: str, metadata: Optional[Dict] = None):
        """
        시스템 프롬프트 저장

        Args:
            system_prompt: 시스템 프롬프트 텍스트
            metadata: 메타데이터 딕셔너리
        """
        content = system_prompt

        if metadata:
            content += "\n\n===== 메타데이터 =====\n"
            for key, value in metadata.items():
                content += f"{key}: {value}\n"

        with open(self.prompts_dir / "system_prompt.txt", 'w', encoding='utf-8') as f:
            f.write(content)

        self.logger.write("시스템 프롬프트 저장 완료")

    def save_user_prompt(self, user_prompt: str, metadata: Optional[Dict] = None):
        """
        사용자 프롬프트 저장

        Args:
            user_prompt: 사용자 프롬프트 텍스트
            metadata: 메타데이터 딕셔너리
        """
        content = user_prompt

        if metadata:
            content += "\n\n===== 메타데이터 =====\n"
            for key, value in metadata.items():
                content += f"{key}: {value}\n"

        with open(self.prompts_dir / "user_prompt.txt", 'w', encoding='utf-8') as f:
            f.write(content)

        self.logger.write("사용자 프롬프트 저장 완료")

    def save_final_prompt(self, final_prompt: str, metadata: Optional[Dict] = None):
        """
        최종 프롬프트 저장

        Args:
            final_prompt: 최종 프롬프트 텍스트
            metadata: 메타데이터 딕셔너리
        """
        content = final_prompt

        if metadata:
            content += "\n\n===== 메타데이터 =====\n"
            for key, value in metadata.items():
                content += f"{key}: {value}\n"

        with open(self.prompts_dir / "final_prompt.txt", 'w', encoding='utf-8') as f:
            f.write(content)

        self.logger.write("최종 프롬프트 저장 완료")

    def save_prompt_template(self, template_info: Dict):
        """
        프롬프트 템플릿 정보 저장

        Args:
            template_info: 템플릿 정보 딕셔너리
        """
        with open(self.prompts_dir / "prompt_template.yaml", 'w', encoding='utf-8') as f:
            yaml.dump(template_info, f, allow_unicode=True, sort_keys=False)

        self.logger.write("프롬프트 템플릿 저장 완료")

    # ===== UI 관련 =====

    def save_streamlit_session(self, session_data: Dict):
        """
        Streamlit 세션 상태 저장

        Args:
            session_data: 세션 데이터 딕셔너리
        """
        with open(self.ui_dir / "streamlit_session.json", 'w', encoding='utf-8') as f:
            json.dump(session_data, f, ensure_ascii=False, indent=2)

        self.logger.write("Streamlit 세션 저장 완료")

    def log_ui_interaction(self, interaction: str):
        """
        UI 인터랙션 로그

        Args:
            interaction: 인터랙션 설명
        """
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        log_line = f"{timestamp} | {interaction}\n"

        with open(self.ui_dir / "user_interactions.log", 'a', encoding='utf-8') as f:
            f.write(log_line)

    def log_ui_event(self, event: Dict):
        """
        UI 이벤트 기록

        Args:
            event: 이벤트 딕셔너리
        """
        event['timestamp'] = datetime.now().isoformat()

        # 기존 이벤트 읽기
        events_file = self.ui_dir / "ui_events.json"
        if events_file.exists():
            with open(events_file, 'r', encoding='utf-8') as f:
                events = json.load(f)
        else:
            events = []

        events.append(event)

        # 업데이트
        with open(events_file, 'w', encoding='utf-8') as f:
            json.dump(events, f, ensure_ascii=False, indent=2)

    # ===== 출력 관련 =====

    def save_output(self, filename: str, content: str):
        """
        결과물 저장

        Args:
            filename: 파일명
            content: 내용
        """
        output_path = self.outputs_dir / filename
        with open(output_path, 'w', encoding='utf-8') as f:
            f.write(content)

        self.logger.write(f"결과물 저장: {filename}")

    # ===== 평가 지표 관련 =====

    def save_rag_metrics(self, metrics: Dict):
        """
        RAG 평가 지표 저장

        Args:
            metrics: RAG 평가 지표 딕셔너리
        """
        metrics['timestamp'] = datetime.now().isoformat()

        with open(self.evaluation_dir / "rag_metrics.json", 'w', encoding='utf-8') as f:
            json.dump(metrics, f, ensure_ascii=False, indent=2)

        self.logger.write("RAG 평가 지표 저장 완료")

    def save_agent_accuracy(self, accuracy_data: Dict):
        """
        Agent 정확도 저장

        Args:
            accuracy_data: Agent 정확도 데이터 딕셔너리
        """
        accuracy_data['timestamp'] = datetime.now().isoformat()

        with open(self.evaluation_dir / "agent_accuracy.json", 'w', encoding='utf-8') as f:
            json.dump(accuracy_data, f, ensure_ascii=False, indent=2)

        self.logger.write("Agent 정확도 저장 완료")

    def save_latency_report(self, latency_data: Dict):
        """
        응답 시간 분석 저장

        Args:
            latency_data: 응답 시간 데이터 딕셔너리
        """
        latency_data['timestamp'] = datetime.now().isoformat()

        with open(self.evaluation_dir / "latency_report.json", 'w', encoding='utf-8') as f:
            json.dump(latency_data, f, ensure_ascii=False, indent=2)

        self.logger.write("응답 시간 분석 저장 완료")

    def save_cost_analysis(self, cost_data: Dict):
        """
        비용 분석 저장

        Args:
            cost_data: 비용 분석 데이터 딕셔너리
        """
        cost_data['timestamp'] = datetime.now().isoformat()

        with open(self.evaluation_dir / "cost_analysis.json", 'w', encoding='utf-8') as f:
            json.dump(cost_data, f, ensure_ascii=False, indent=2)

        self.logger.write("비용 분석 저장 완료")

    def save_test_results(self, test_data: Dict):
        """
        테스트 결과 저장

        Args:
            test_data: 테스트 결과 데이터 딕셔너리
        """
        test_data['timestamp'] = datetime.now().isoformat()

        with open(self.evaluation_dir / "test_results.json", 'w', encoding='utf-8') as f:
            json.dump(test_data, f, ensure_ascii=False, indent=2)

        self.logger.write("테스트 결과 저장 완료")

    # ===== 디버그 관련 =====

    def save_debug_info(self, filename: str, data: Dict):
        """
        디버그 정보 저장

        Args:
            filename: 파일명
            data: 디버그 데이터
        """
        # debug 폴더가 없으면 생성
        self.debug_dir.mkdir(exist_ok=True)

        debug_path = self.debug_dir / filename
        with open(debug_path, 'w', encoding='utf-8') as f:
            json.dump(data, f, ensure_ascii=False, indent=2)

    # ===== 메타데이터 관련 =====

    def update_metadata(self, **kwargs):
        """
        메타데이터 업데이트

        Args:
            **kwargs: 업데이트할 키-값 쌍
        """
        self.metadata.update(kwargs)

        with open(self.metadata_file, 'w', encoding='utf-8') as f:
            json.dump(self.metadata, f, ensure_ascii=False, indent=2)

        self.logger.write(f"메타데이터 업데이트: {list(kwargs.keys())}")

    def save_config(self, config: Dict):
        """
        전체 설정 저장

        Args:
            config: 설정 딕셔너리
        """
        config_path = self.experiment_dir / "config.yaml"
        with open(config_path, 'w', encoding='utf-8') as f:
            yaml.dump(config, f, allow_unicode=True, sort_keys=False)

        self.logger.write("설정 파일 저장 완료")

    def close(self):
        """실험 종료"""
        # 종료 시간 기록
        self.metadata['end_time'] = datetime.now().isoformat()

        # 최종 메타데이터 저장
        with open(self.metadata_file, 'w', encoding='utf-8') as f:
            json.dump(self.metadata, f, ensure_ascii=False, indent=2)

        self.logger.write("=" * 50)
        self.logger.write("실험 종료")
        self.logger.write("=" * 50)
        self.logger.close()

    def __enter__(self):
        """with 문 지원"""
        return self

    def __exit__(self, exc_type, exc_val, exc_tb):
        """with 문 종료 시 자동 close"""
        self.close()
```

---

### 2. 폴더 구조 자동 생성

#### 2.1 생성되는 폴더 구조

```
experiments/20251031/20251031_103015_session_001/
├── metadata.json                    # ⭐ 전체 실험 메타데이터
├── chatbot.log                      # 메인 실행 로그
├── config.yaml                      # 전체 설정
│
├── tools/                           # 🔧 도구 실행 로그
│   ├── rag_paper.log
│   ├── rag_glossary.log
│   ├── web_search.log
│   ├── summary_paper.log
│   ├── file_save.log
│   └── general.log
│
├── database/                        # 🗄️ DB 관련 기록
│   ├── queries.sql
│   ├── pgvector_searches.json
│   ├── search_results.json
│   └── db_performance.json
│
├── prompts/                         # 💬 프롬프트 기록
│   ├── system_prompt.txt
│   ├── user_prompt.txt
│   ├── final_prompt.txt
│   └── prompt_template.yaml
│
├── ui/                              # 🖥️ UI 관련 기록
│   ├── streamlit_session.json
│   ├── user_interactions.log
│   └── ui_events.json
│
├── outputs/                         # 📄 생성된 결과물
│   ├── response.txt
│   ├── summary.md
│   └── saved_file.txt
│
├── evaluation/                      # 📊 평가 지표
│   ├── rag_metrics.json
│   ├── agent_accuracy.json
│   ├── latency_report.json
│   ├── cost_analysis.json
│   └── test_results.json
│
└── debug/                           # 🐛 디버그 정보 (선택)
    ├── agent_trace.json
    ├── llm_tokens.json
    └── error_trace.log
```

#### 2.2 Session ID 자동 부여 로직

```python
def _get_next_session_id(self, date: str) -> int:
    """
    당일 다음 session ID 반환

    예시:
    - 첫 실행: session_001
    - 두 번째 실행: session_002
    - 다음 날: 다시 session_001부터 시작
    """
    date_dir = Path(f"experiments/{date}")

    # 날짜 폴더가 없으면 첫 실행
    if not date_dir.exists():
        return 1

    # 기존 session 폴더 찾기
    existing_sessions = list(date_dir.glob(f"{date}_*_session_*"))
    if not existing_sessions:
        return 1

    # 가장 큰 session ID 찾기
    max_id = 0
    for session_dir in existing_sessions:
        try:
            session_id_str = session_dir.name.split('_')[-1]
            session_id = int(session_id_str)
            max_id = max(max_id, session_id)
        except (IndexError, ValueError):
            continue

    return max_id + 1
```

---

### 3. 사용 예시

#### 3.1 기본 사용

```python
from src.utils.experiment_manager import ExperimentManager

# with 문으로 자동 초기화 및 종료
with ExperimentManager() as exp:
    # 자동으로 다음 작업 수행:
    # 1. experiments/20251031/20251031_103015_session_001/ 생성
    # 2. 서브 폴더 6개 생성
    # 3. metadata.json 초기화
    # 4. chatbot.log 생성

    # 메인 로그 기록
    exp.logger.write("챗봇 실행 시작")

    # 사용자 질문
    question = "RAG에 대해 알려줘"

    # 메타데이터 업데이트
    exp.update_metadata(
        user_query=question,
        difficulty="easy"
    )

    # ... 챗봇 실행 ...

    # with 블록이 끝나면 자동으로 close() 호출
```

#### 3.2 도구별 Logger 사용

```python
with ExperimentManager() as exp:
    # 도구별 독립 Logger 생성
    rag_logger = exp.get_tool_logger('rag_paper')
    rag_logger.write("논문 검색 시작")
    rag_logger.write("검색 완료: 5개 논문 발견")
    rag_logger.close()

    # 다른 도구
    web_logger = exp.get_tool_logger('web_search')
    web_logger.write("웹 검색 시작")
    web_logger.close()
```

#### 3.3 DB 쿼리 기록

```python
with ExperimentManager() as exp:
    # SQL 쿼리 기록
    exp.log_sql_query(
        query="SELECT * FROM papers WHERE paper_id = 123",
        description="논문 메타데이터 조회",
        tool="rag_paper",
        execution_time_ms=12
    )

    # pgvector 검색 기록
    exp.log_pgvector_search({
        "tool": "rag_paper",
        "collection": "paper_chunks",
        "query_text": "RAG에 대해 알려줘",
        "top_k": 5,
        "execution_time_ms": 45
    })

    # 검색 결과 저장
    exp.save_search_results("rag_paper", {
        "query": "RAG에 대해 알려줘",
        "results_count": 5,
        "papers": [...]
    })
```

#### 3.4 프롬프트 저장

```python
with ExperimentManager() as exp:
    # 시스템 프롬프트 저장
    exp.save_system_prompt(
        system_prompt="당신은 논문을 쉽게 설명하는 전문가입니다.",
        metadata={"난이도": "easy", "템플릿": "EASY_SYSTEM_PROMPT"}
    )

    # 사용자 프롬프트 저장
    exp.save_user_prompt(
        user_prompt="[참고 논문]\n...\n\n[질문]\nRAG에 대해 알려줘",
        metadata={"검색 결과 수": 5}
    )

    # 최종 프롬프트 저장
    exp.save_final_prompt(final_prompt)

    # 프롬프트 템플릿 정보 저장
    exp.save_prompt_template({
        "difficulty": "easy",
        "llm_config": {"model": "gpt-4", "temperature": 0.7}
    })
```

#### 3.5 UI 인터랙션 기록

```python
with ExperimentManager() as exp:
    # 인터랙션 로그
    exp.log_ui_interaction("페이지 접속")
    exp.log_ui_interaction("난이도 선택: easy")
    exp.log_ui_interaction("질문 입력: RAG에 대해 알려줘")

    # UI 이벤트 기록
    exp.log_ui_event({
        "event_type": "difficulty_changed",
        "old_value": None,
        "new_value": "easy"
    })

    # Streamlit 세션 저장
    exp.save_streamlit_session({
        "session_id": "abc123",
        "messages": [...]
    })
```

#### 3.6 평가 지표 저장

```python
with ExperimentManager() as exp:
    # RAG 평가 지표
    exp.save_rag_metrics({
        "retrieval_metrics": {"recall_at_5": 0.8},
        "generation_metrics": {"faithfulness": 0.95}
    })

    # Agent 정확도
    exp.save_agent_accuracy({
        "routing_decision": {"predicted_tool": "rag_paper", "correct": True}
    })

    # 응답 시간 분석
    exp.save_latency_report({
        "total_latency": {"total_time_ms": 5000, "status": "PASS"}
    })

    # 비용 분석
    exp.save_cost_analysis({
        "llm_usage": {"total_tokens": 2345},
        "cost_breakdown_krw": {"total_cost": 30.51}
    })
```

#### 3.7 결과물 저장

```python
with ExperimentManager() as exp:
    # 최종 답변 저장
    exp.save_output('response.txt', final_answer)

    # 요약본 저장 (있을 경우)
    exp.save_output('summary.md', summary_text)

    # 사용자 저장 요청 파일
    exp.save_output('saved_file.txt', content)
```

---

### 4. 실험 검색 및 분석

#### 4.1 find_experiments 스크립트

**파일 경로**: `scripts/find_experiments.py`

```python
import json
from pathlib import Path
from typing import Optional, List, Dict


def find_experiments(
    difficulty: Optional[str] = None,
    tool: Optional[str] = None,
    date: Optional[str] = None,
    min_response_time: Optional[int] = None,
    max_response_time: Optional[int] = None
) -> List[Dict]:
    """
    메타데이터 기반 실험 검색

    Args:
        difficulty: 난이도 필터 (easy/hard)
        tool: 도구 필터 (rag_paper, web_search 등)
        date: 날짜 필터 (YYYYMMDD)
        min_response_time: 최소 응답 시간 (ms)
        max_response_time: 최대 응답 시간 (ms)

    Returns:
        검색된 실험 목록
    """
    results = []

    # 검색 경로
    if date:
        search_path = Path(f"experiments/{date}")
        if not search_path.exists():
            return []
    else:
        search_path = Path("experiments")

    # 모든 metadata.json 찾기
    for meta_file in search_path.rglob("metadata.json"):
        try:
            with open(meta_file, encoding='utf-8') as f:
                meta = json.load(f)
        except Exception:
            continue

        # 필터 적용
        if difficulty and meta.get('difficulty') != difficulty:
            continue
        if tool and meta.get('tool_used') != tool:
            continue
        if min_response_time and meta.get('response_time_ms', 0) < min_response_time:
            continue
        if max_response_time and meta.get('response_time_ms', float('inf')) > max_response_time:
            continue

        results.append({
            'path': meta_file.parent,
            'metadata': meta
        })

    results.sort(key=lambda x: x['metadata'].get('start_time', ''))
    return results


if __name__ == "__main__":
    # 사용 예시
    easy_experiments = find_experiments(difficulty="easy")
    print(f"Easy 모드 실험: {len(easy_experiments)}개")

    for exp in easy_experiments:
        print(f"  - {exp['path'].name}: {exp['metadata']['user_query']}")
```

#### 4.2 평가 지표 집계

**파일 경로**: `scripts/aggregate_metrics.py`

```python
import json
from pathlib import Path
from typing import Dict


def aggregate_metrics(date: str) -> Dict:
    """
    특정 날짜의 모든 실험 평가 지표 집계

    Args:
        date: 날짜 (YYYYMMDD)

    Returns:
        집계된 평가 지표
    """
    metrics_list = []

    for session_dir in Path(f"experiments/{date}").glob("*_session_*"):
        rag_metrics_file = session_dir / "evaluation" / "rag_metrics.json"
        if rag_metrics_file.exists():
            with open(rag_metrics_file) as f:
                metrics_list.append(json.load(f))

    if not metrics_list:
        return {}

    # 평균 계산
    avg_recall = sum(m['retrieval_metrics']['recall_at_5'] for m in metrics_list) / len(metrics_list)
    avg_faithfulness = sum(m['generation_metrics']['faithfulness'] for m in metrics_list) / len(metrics_list)

    return {
        'total_sessions': len(metrics_list),
        'avg_recall_at_5': avg_recall,
        'avg_faithfulness': avg_faithfulness
    }


if __name__ == "__main__":
    # 사용 예시
    result = aggregate_metrics("20251031")
    print(f"총 세션: {result['total_sessions']}")
    print(f"평균 Recall@5: {result['avg_recall_at_5']:.2f}")
    print(f"평균 Faithfulness: {result['avg_faithfulness']:.2f}")
```

---

## 참고 PRD 문서

아래 PRD 문서들을 참고하여 구현하세요:

1. **[실험_폴더_구조_최종안.md](../references/실험_폴더_구조_최종안.md)** ⭐⭐⭐
   - 전체 폴더 구조 상세 가이드
   - ExperimentManager 전체 코드
   - 실제 사용 예시
   - 파일별 상세 설명

2. **[06_실험_추적_관리.md](../PRD/06_실험_추적_관리.md)** ⭐⭐⭐
   - 실험 폴더 생성 흐름
   - Session ID 자동 부여 규칙
   - ExperimentManager 사용법
   - 실험 검색 및 분석

3. **[09_평가_기준.md](../PRD/09_평가_기준.md)** ⭐⭐
   - RAG 평가 지표 (Recall@K, Faithfulness 등)
   - Agent 정확도 측정 방법
   - 응답 시간 목표 (p95 ≤ 6000ms)
   - 비용 분석 기준

---

## 협업 방법

### 다른 담당자와의 협업

#### 1. 전체 팀원 - ExperimentManager 사용
- **협업 내용**: 모든 챗봇 실행 시 ExperimentManager 사용
- **타이밍**: ExperimentManager 구현 완료 즉시
- **전달 사항**:
  - ExperimentManager 사용법 문서
  - with 문 사용 예시
  - 도구별 Logger 사용법

#### 2. 최현화 (AI Agent 메인) - Agent에 통합
- **협업 내용**: LangGraph StateGraph에 ExperimentManager 통합
- **타이밍**: Agent graph 구현 완료 후
- **전달 사항**:
  - 메타데이터 업데이트 시점
  - 도구 실행 시 Logger 사용법
  - 평가 지표 저장 시점

#### 3. 임예슬 (UI/프롬프트) - UI 인터랙션 로깅
- **협업 내용**: Streamlit UI에서 ExperimentManager 사용
- **타이밍**: UI 구현 시
- **전달 사항**:
  - `log_ui_interaction()` 사용법
  - `log_ui_event()` 사용법
  - `save_streamlit_session()` 사용법

#### 4. 신준엽 (RAG/용어집) - DB 쿼리 로깅
- **협업 내용**: RAG 검색 시 DB 쿼리 기록
- **타이밍**: RAG 도구 구현 시
- **전달 사항**:
  - `log_sql_query()` 사용법
  - `log_pgvector_search()` 사용법
  - `save_search_results()` 사용법

---

## 구현 체크리스트

### Phase 1: ExperimentManager 기본 구현 (우선순위 1)
- [ ] `src/utils/experiment_manager.py` 파일 생성
- [ ] ExperimentManager 클래스 기본 구조 구현
  - [ ] `__init__()` - Session ID 자동 부여, 폴더 생성
  - [ ] `_get_next_session_id()` - Session ID 자동 계산
  - [ ] `get_tool_logger()` - 도구별 Logger 제공
  - [ ] `update_metadata()` - 메타데이터 관리
  - [ ] `save_config()` - 설정 저장
  - [ ] `close()` - 종료 처리
  - [ ] `__enter__()`, `__exit__()` - with 문 지원
- [ ] 테스트 스크립트 작성 및 검증
- [ ] 사용법 문서화 및 팀원 공유

### Phase 2: DB 및 프롬프트 저장 구현 (우선순위 2)
- [ ] DB 관련 메서드 구현
  - [ ] `log_sql_query()` - SQL 쿼리 기록
  - [ ] `log_pgvector_search()` - pgvector 검색 기록
  - [ ] `save_search_results()` - 검색 결과 저장
  - [ ] `save_db_performance()` - DB 성능 저장
- [ ] 프롬프트 관련 메서드 구현
  - [ ] `save_system_prompt()` - 시스템 프롬프트
  - [ ] `save_user_prompt()` - 사용자 프롬프트
  - [ ] `save_final_prompt()` - 최종 프롬프트
  - [ ] `save_prompt_template()` - 템플릿 정보
- [ ] 테스트 및 검증

### Phase 3: UI 및 평가 지표 구현 (우선순위 3)
- [ ] UI 관련 메서드 구현
  - [ ] `save_streamlit_session()` - Streamlit 세션
  - [ ] `log_ui_interaction()` - 인터랙션 로그
  - [ ] `log_ui_event()` - UI 이벤트
- [ ] 평가 지표 메서드 구현
  - [ ] `save_rag_metrics()` - RAG 평가
  - [ ] `save_agent_accuracy()` - Agent 정확도
  - [ ] `save_latency_report()` - 응답 시간
  - [ ] `save_cost_analysis()` - 비용 분석
  - [ ] `save_test_results()` - 테스트 결과
- [ ] 출력 관련 메서드 구현
  - [ ] `save_output()` - 결과물 저장
- [ ] 디버그 관련 메서드 구현
  - [ ] `save_debug_info()` - 디버그 정보

### Phase 4: 실험 검색 및 분석 도구 (선택)
- [ ] `scripts/find_experiments.py` 스크립트 작성
  - [ ] `find_experiments()` 함수 구현
  - [ ] 다양한 필터 옵션 지원
- [ ] `scripts/aggregate_metrics.py` 스크립트 작성
  - [ ] `aggregate_metrics()` 함수 구현
  - [ ] 평가 지표 집계 기능
- [ ] 사용 예시 및 문서화

### Phase 5: 문서화 및 테스트 (지속)
- [ ] README.md 업데이트 (ExperimentManager 사용법)
- [ ] 샘플 코드 작성
- [ ] 단위 테스트 작성 (`tests/utils/test_experiment_manager.py`)
- [ ] 통합 테스트
- [ ] 팀원 교육 및 사용법 공유

---

## 규칙 및 주의사항

### 1. Session ID 자동 부여 규칙
- **형식**: `session_001`, `session_002`, `session_003` ...
- **부여 방식**: 당일 기준으로 순차적으로 증가
- **시작 번호**: 매일 `001`부터 시작
- **중복 방지**: `_get_next_session_id()` 메서드가 자동 처리

### 2. 폴더 구조 규칙
- **필수 폴더 6개**: tools, database, prompts, ui, outputs, evaluation
- **선택 폴더 1개**: debug (필요 시 생성)
- **메타데이터**: metadata.json은 항상 최상위에 위치
- **로그 파일**: chatbot.log는 메인 로그, tools/*.log는 도구별 로그

### 3. 코드 품질
- 모든 메서드에 docstring 작성 (Args, Returns 명시)
- 타입 힌팅 사용 (Python 3.10+)
- with 문 지원 (`__enter__`, `__exit__`)
- 리소스 자동 정리 (`close()`)
- 에러 처리 철저히 (파일 I/O 시 try-except)

### 4. 테스트
- 단위 테스트 작성 (`tests/utils/test_experiment_manager.py`)
- Session ID 중복 방지 테스트
- 폴더 자동 생성 테스트
- 각 저장 메서드 개별 테스트
- with 문 동작 테스트

### 5. 성능 고려사항
- JSON 파일은 저장 시마다 덮어쓰기 (append 아님)
- SQL 쿼리는 append 방식 (queries.sql)
- Logger는 즉시 flush하여 유실 방지
- metadata.json은 변경 시마다 업데이트

---

## 예상 결과물

### 1. 파일 구조

```
src/
└── utils/
    ├── logger.py                  # Logger 클래스 (기존)
    └── experiment_manager.py      # ExperimentManager 클래스 (신규)

scripts/
├── find_experiments.py            # 실험 검색 도구 (신규)
└── aggregate_metrics.py           # 평가 지표 집계 (신규)

tests/
└── utils/
    └── test_experiment_manager.py # 단위 테스트 (신규)

experiments/                       # 실험 결과 폴더
└── 20251031/
    ├── 20251031_103015_session_001/
    │   ├── metadata.json
    │   ├── chatbot.log
    │   ├── config.yaml
    │   ├── tools/
    │   ├── database/
    │   ├── prompts/
    │   ├── ui/
    │   ├── outputs/
    │   └── evaluation/
    └── 20251031_110234_session_002/
        └── ...
```

### 2. 사용 예시

**기본 사용:**
```python
from src.utils.experiment_manager import ExperimentManager

with ExperimentManager() as exp:
    exp.logger.write("챗봇 실행 시작")
    exp.update_metadata(user_query="RAG에 대해 알려줘")
    # ... 챗봇 실행 ...
```

**도구별 Logger:**
```python
with ExperimentManager() as exp:
    tool_logger = exp.get_tool_logger('rag_paper')
    tool_logger.write("논문 검색 시작")
    tool_logger.close()
```

**평가 지표 저장:**
```python
with ExperimentManager() as exp:
    exp.save_rag_metrics({
        "retrieval_metrics": {"recall_at_5": 0.8},
        "generation_metrics": {"faithfulness": 0.95}
    })
```

**실험 검색:**
```python
from scripts.find_experiments import find_experiments

# Easy 모드 실험 찾기
easy_exps = find_experiments(difficulty="easy")

# 응답 시간 3초 이하 실험 찾기
fast_exps = find_experiments(max_response_time=3000)
```

---

## 추가 참고 사항

### 1. metadata.json 예시

```json
{
  "session_id": "001",
  "start_time": "2025-10-31T10:30:15",
  "end_time": "2025-10-31T10:32:45",
  "difficulty": "easy",
  "tool_used": "rag_paper",
  "user_query": "RAG에 대해 알려줘",
  "success": true,
  "response_time_ms": 2500,
  "response_length": 450,
  "model": "gpt-4",
  "temperature": 0.7,
  "tokens_used": {
    "prompt": 1200,
    "completion": 800,
    "total": 2000
  },
  "db_queries_count": 4,
  "db_total_time_ms": 120
}
```

### 2. config.yaml 예시

```yaml
# 챗봇 설정
difficulty: easy
model: gpt-4
temperature: 0.7
max_tokens: 2000

# RAG 설정
top_k: 5
similarity_threshold: 0.7

# DB 설정
database: papers
host: localhost
port: 5432
```

### 3. 실험 검색 쿼리 예시

```python
# 난이도별 검색
easy_experiments = find_experiments(difficulty="easy")
hard_experiments = find_experiments(difficulty="hard")

# 도구별 검색
rag_experiments = find_experiments(tool="rag_paper")
web_experiments = find_experiments(tool="web_search")

# 날짜별 검색
today_experiments = find_experiments(date="20251031")

# 응답 시간 기준 검색
fast_experiments = find_experiments(max_response_time=3000)
slow_experiments = find_experiments(min_response_time=5000)

# 복합 조건 검색
filtered = find_experiments(
    difficulty="easy",
    tool="rag_paper",
    min_response_time=2000,
    max_response_time=5000
)
```
