# 데이터 삭제 가이드

## 문서 정보
- **작성일**: 2025-11-05
- **프로젝트명**: 논문 리뷰 챗봇 (AI Agent + RAG)
- **팀명**: 연결의 민족
- **목적**: 데이터 파이프라인 재실행을 위한 기존 데이터 완전 삭제 가이드

---

## 목차
1. [개요](#1-개요)
2. [사전 준비사항](#2-사전-준비사항)
3. [데이터 삭제 순서](#3-데이터-삭제-순서)
4. [Papers 테이블 데이터 삭제](#4-papers-테이블-데이터-삭제)
5. [PGVector 데이터 삭제](#5-pgvector-데이터-삭제)
6. [PDF 파일 삭제](#6-pdf-파일-삭제)
7. [삭제 검증](#7-삭제-검증)
8. [파이프라인 재실행](#8-파이프라인-재실행)
9. [주의사항](#9-주의사항)

---

## 1. 개요

### 1.1 언제 사용하나요?

이 가이드는 다음 상황에서 사용합니다:
- 데이터 파이프라인(`scripts/data/run_full_pipeline.py`)을 처음부터 다시 실행하고 싶을 때
- 임베딩 품질 문제로 인해 전체 데이터를 재생성해야 할 때
- 청크 중복 문제를 해결하기 위해 데이터를 초기화해야 할 때
- 데이터베이스 스키마 변경 후 데이터를 다시 로드해야 할 때

### 1.2 무엇이 삭제되나요?

이 가이드를 따르면 다음 데이터가 **완전히 삭제**됩니다:
1. **Papers 테이블 데이터**: 논문 메타데이터 (제목, 저자, 초록 등)
2. **PGVector 데이터**: 논문 청크 임베딩 벡터 (paper_chunks 컬렉션)
3. **PDF 파일**: 다운로드된 원본 PDF 파일들

### 1.3 삭제되지 않는 것

다음 항목은 **유지**됩니다:
- ✅ Glossary 테이블 데이터 (용어집)
- ✅ Query logs 테이블 데이터 (질의 로그)
- ✅ 데이터베이스 스키마 (테이블 구조)
- ✅ 소스 코드 및 설정 파일

---

## 2. 사전 준비사항

### 2.1 환경 확인

```bash
# 프로젝트 루트 디렉토리로 이동
cd /path/to/langchain-project

# 환경 변수 로드 확인
cat .env | grep DATABASE_URL
```

### 2.2 백업 (선택사항)

삭제 전 중요 데이터를 백업하고 싶다면:

```bash
# Papers 테이블 백업
pg_dump -h localhost -U papers_user -d papers -t papers > backup_papers_$(date +%Y%m%d_%H%M%S).sql

# PDF 파일 백업
tar -czf backup_pdfs_$(date +%Y%m%d_%H%M%S).tar.gz data/raw/pdfs/
```

### 2.3 필요 권한 확인

```bash
# PostgreSQL 연결 테스트
psql $DATABASE_URL -c "SELECT version();"

# papers_user가 papers 테이블에 DELETE 권한이 있는지 확인
psql $DATABASE_URL -c "SELECT has_table_privilege('papers_user', 'papers', 'DELETE');"
```

---

## 3. 데이터 삭제 순서

**권장 순서**를 반드시 따르세요:

```
1. Papers 테이블 데이터 삭제       ← 메타데이터 제거
2. PGVector 컬렉션 데이터 삭제     ← 임베딩 벡터 제거
3. PDF 파일 삭제                   ← 원본 파일 제거
4. 삭제 검증                       ← 모든 데이터가 삭제되었는지 확인
5. 파이프라인 재실행               ← 깨끗한 상태에서 데이터 재생성
```

**주의**: 역순으로 삭제하면 안 됩니다! Papers 테이블의 paper_id가 pgvector 메타데이터의 참조 키이므로, Papers를 먼저 삭제해야 합니다.

---

## 4. Papers 테이블 데이터 삭제

### 4.1 현재 데이터 확인

```bash
# Papers 테이블 행 개수 확인
psql $DATABASE_URL -c "SELECT COUNT(*) FROM papers;"
```

### 4.2 Papers 테이블 전체 데이터 삭제

```bash
# 방법 1: TRUNCATE (빠르고 권장됨)
psql $DATABASE_URL -c "TRUNCATE TABLE papers RESTART IDENTITY CASCADE;"

# 방법 2: DELETE (느리지만 특정 조건 가능)
psql $DATABASE_URL -c "DELETE FROM papers;"
```

**TRUNCATE vs DELETE 차이**:
- `TRUNCATE`: 테이블 전체를 빠르게 비움, AUTO INCREMENT 초기화
- `DELETE`: 행 단위로 삭제, WHERE 조건 사용 가능

### 4.3 삭제 확인

```bash
# Papers 테이블이 비었는지 확인
psql $DATABASE_URL -c "SELECT COUNT(*) FROM papers;"
# 예상 결과: count = 0
```

---

## 5. PGVector 데이터 삭제

### 5.1 현재 컬렉션 확인

```bash
# 모든 PGVector 컬렉션 확인
psql $DATABASE_URL -c "SELECT name, cmetadata FROM langchain_pg_collection;"

# paper_chunks 컬렉션의 임베딩 개수 확인
psql $DATABASE_URL -c "
SELECT
    c.name,
    COUNT(e.id) as embedding_count
FROM langchain_pg_collection c
LEFT JOIN langchain_pg_embedding e ON e.collection_id = c.uuid
WHERE c.name = 'paper_chunks'
GROUP BY c.name;
"
```

### 5.2 paper_chunks 컬렉션 삭제

#### 옵션 A: 컬렉션 전체 삭제 (권장)

```bash
# paper_chunks 컬렉션과 모든 임베딩 삭제
psql $DATABASE_URL <<EOF
-- 1. 컬렉션 UUID 가져오기
DO \$\$
DECLARE
    collection_uuid UUID;
BEGIN
    SELECT uuid INTO collection_uuid
    FROM langchain_pg_collection
    WHERE name = 'paper_chunks';

    -- 2. 임베딩 데이터 삭제
    DELETE FROM langchain_pg_embedding
    WHERE collection_id = collection_uuid;

    -- 3. 컬렉션 삭제
    DELETE FROM langchain_pg_collection
    WHERE name = 'paper_chunks';

    RAISE NOTICE 'paper_chunks 컬렉션 삭제 완료';
END \$\$;
EOF
```

#### 옵션 B: 임베딩만 삭제 (컬렉션 유지)

```bash
# 컬렉션 구조는 유지하고 데이터만 삭제
psql $DATABASE_URL -c "
DELETE FROM langchain_pg_embedding
WHERE collection_id = (
    SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks'
);
"
```

### 5.3 삭제 확인

```bash
# 컬렉션 확인
psql $DATABASE_URL -c "SELECT name FROM langchain_pg_collection WHERE name = 'paper_chunks';"
# 예상 결과: 0 rows (옵션 A) 또는 1 row (옵션 B)

# 임베딩 개수 확인
psql $DATABASE_URL -c "
SELECT COUNT(*)
FROM langchain_pg_embedding
WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks');
"
# 예상 결과: count = 0
```

---

## 6. PDF 파일 삭제

### 6.1 현재 PDF 파일 확인

```bash
# PDF 파일 개수 확인
find data/raw/pdfs -name "*.pdf" -type f | wc -l

# PDF 파일 목록 확인 (처음 10개)
ls -lh data/raw/pdfs/*.pdf | head -10

# 디스크 사용량 확인
du -sh data/raw/pdfs
```

### 6.2 PDF 파일 삭제

#### 옵션 A: 디렉토리 전체 삭제 후 재생성 (권장)

```bash
# data/raw/pdfs 디렉토리 삭제
rm -rf data/raw/pdfs

# 디렉토리 재생성 (파이프라인에서 필요)
mkdir -p data/raw/pdfs
```

#### 옵션 B: PDF 파일만 삭제 (디렉토리 유지)

```bash
# .pdf 파일만 삭제
rm -f data/raw/pdfs/*.pdf
```

### 6.3 삭제 확인

```bash
# PDF 파일이 없는지 확인
ls data/raw/pdfs/
# 예상 결과: (빈 디렉토리) 또는 "디렉토리가 비어있습니다"

# PDF 파일 개수 확인
find data/raw/pdfs -name "*.pdf" -type f 2>/dev/null | wc -l
# 예상 결과: 0
```

---

## 7. 삭제 검증

### 7.1 종합 검증 스크립트

```bash
#!/bin/bash
echo "==================================="
echo "데이터 삭제 검증"
echo "==================================="

# 1. Papers 테이블 확인
PAPERS_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM papers;")
echo "Papers 테이블: $PAPERS_COUNT 행"

# 2. PGVector 임베딩 확인
EMBEDDINGS_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM langchain_pg_embedding WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks');")
echo "PGVector 임베딩: $EMBEDDINGS_COUNT 개"

# 3. PDF 파일 확인
PDF_COUNT=$(find data/raw/pdfs -name "*.pdf" -type f 2>/dev/null | wc -l)
echo "PDF 파일: $PDF_COUNT 개"

echo "==================================="
if [ "$PAPERS_COUNT" -eq 0 ] && [ "$EMBEDDINGS_COUNT" -eq 0 ] && [ "$PDF_COUNT" -eq 0 ]; then
    echo "✅ 모든 데이터가 정상적으로 삭제되었습니다!"
else
    echo "⚠️  일부 데이터가 남아있습니다. 위 결과를 확인하세요."
fi
```

### 7.2 검증 실행

```bash
# 검증 스크립트 저장
cat > /tmp/verify_deletion.sh << 'EOF'
#!/bin/bash
echo "==================================="
echo "데이터 삭제 검증"
echo "==================================="

PAPERS_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM papers;")
echo "Papers 테이블: $PAPERS_COUNT 행"

EMBEDDINGS_COUNT=$(psql $DATABASE_URL -t -c "SELECT COUNT(*) FROM langchain_pg_embedding WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks');")
echo "PGVector 임베딩: $EMBEDDINGS_COUNT 개"

PDF_COUNT=$(find data/raw/pdfs -name "*.pdf" -type f 2>/dev/null | wc -l)
echo "PDF 파일: $PDF_COUNT 개"

echo "==================================="
if [ "$PAPERS_COUNT" -eq 0 ] && [ "$EMBEDDINGS_COUNT" -eq 0 ] && [ "$PDF_COUNT" -eq 0 ]; then
    echo "✅ 모든 데이터가 정상적으로 삭제되었습니다!"
else
    echo "⚠️  일부 데이터가 남아있습니다. 위 결과를 확인하세요."
fi
EOF

chmod +x /tmp/verify_deletion.sh
/tmp/verify_deletion.sh
```

---

## 8. 파이프라인 재실행

모든 데이터가 삭제되었다면 파이프라인을 재실행할 수 있습니다.

### 8.1 재실행 전 확인사항

```bash
# 1. 환경 변수 로드
source .env

# 2. Python 가상환경 활성화
source venv/bin/activate  # 또는 conda activate langchain-project

# 3. 필요 패키지 설치 확인
pip install -r requirements.txt
```

### 8.2 전체 파이프라인 실행

```bash
# 데이터 파이프라인 재실행
python scripts/data/run_full_pipeline.py
```

**실행 단계**:
1. Phase 1: arXiv 논문 수집 (PDF 다운로드)
2. Phase 2: PostgreSQL 데이터베이스 초기화 (Papers 테이블 INSERT)
3. Phase 3: PDF 문서 로드 및 청크 분할
4. Phase 4: 임베딩 생성 및 Vector DB 저장

**예상 소요 시간**:
- 논문 20개 기준: 약 5-10분
- 논문 100개 기준: 약 20-30분

### 8.3 재실행 확인

```bash
# Papers 테이블 확인
psql $DATABASE_URL -c "SELECT COUNT(*) as total_papers FROM papers;"

# PGVector 임베딩 확인
psql $DATABASE_URL -c "
SELECT
    COUNT(*) as total_embeddings,
    COUNT(DISTINCT cmetadata->>'paper_id') as unique_papers
FROM langchain_pg_embedding
WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks');
"

# PDF 파일 확인
ls -lh data/raw/pdfs | wc -l
```

---

## 9. 주의사항

### 9.1 데이터 손실 경고

**이 작업은 되돌릴 수 없습니다!**

- Papers 테이블 데이터 삭제 후 복구 불가
- PGVector 임베딩 삭제 후 복구 불가
- PDF 파일 삭제 후 arXiv에서 재다운로드 필요

**백업 권장**: 삭제 전 반드시 [2.2 백업](#22-백업-선택사항) 섹션을 참고하여 백업하세요.

### 9.2 삭제 권한 문제

```bash
# 권한 오류 발생 시
ERROR: permission denied for table papers

# 해결 방법: papers_user에게 DELETE 권한 부여
psql -U postgres -d papers -c "GRANT DELETE ON papers TO papers_user;"
```

### 9.3 외래 키 제약 조건

```bash
# CASCADE 삭제 실패 시
ERROR: update or delete on table "papers" violates foreign key constraint

# 해결 방법: TRUNCATE with CASCADE
psql $DATABASE_URL -c "TRUNCATE TABLE papers RESTART IDENTITY CASCADE;"
```

### 9.4 파이프라인 실행 실패

파이프라인 재실행 시 오류가 발생하면:

1. **arXiv API Rate Limit**: 5분 대기 후 재시도
2. **OpenAI API Rate Limit**: `load_embeddings.py`의 배치 크기를 줄이거나 대기 시간 증가
3. **PostgreSQL 연결 실패**: `.env` 파일의 `DATABASE_URL` 확인
4. **디렉토리 없음**: `mkdir -p data/raw/pdfs data/processed` 실행

### 9.5 Glossary와 Query Logs는?

이 가이드는 **Papers와 PGVector 데이터만** 삭제합니다.

Glossary와 Query Logs를 삭제하려면:

```bash
# Glossary 테이블 삭제
psql $DATABASE_URL -c "TRUNCATE TABLE glossary RESTART IDENTITY CASCADE;"

# Query Logs 테이블 삭제
psql $DATABASE_URL -c "TRUNCATE TABLE query_logs RESTART IDENTITY CASCADE;"
```

---

## 10. 빠른 참조

### 10.1 한 줄 명령어 모음

```bash
# Papers 테이블 삭제
psql $DATABASE_URL -c "TRUNCATE TABLE papers RESTART IDENTITY CASCADE;"

# PGVector 컬렉션 삭제
psql $DATABASE_URL -c "DELETE FROM langchain_pg_embedding WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks'); DELETE FROM langchain_pg_collection WHERE name = 'paper_chunks';"

# PDF 파일 삭제
rm -rf data/raw/pdfs && mkdir -p data/raw/pdfs

# 검증
psql $DATABASE_URL -c "SELECT COUNT(*) FROM papers; SELECT COUNT(*) FROM langchain_pg_embedding;" && ls data/raw/pdfs
```

### 10.2 전체 삭제 스크립트

```bash
#!/bin/bash
set -e

echo "⚠️  경고: 모든 데이터를 삭제합니다! (3초 후 진행)"
sleep 3

echo "1. Papers 테이블 삭제..."
psql $DATABASE_URL -c "TRUNCATE TABLE papers RESTART IDENTITY CASCADE;"

echo "2. PGVector 데이터 삭제..."
psql $DATABASE_URL -c "DELETE FROM langchain_pg_embedding WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks'); DELETE FROM langchain_pg_collection WHERE name = 'paper_chunks';"

echo "3. PDF 파일 삭제..."
rm -rf data/raw/pdfs
mkdir -p data/raw/pdfs

echo "✅ 모든 데이터 삭제 완료!"
```

---

## 관련 문서

- [데이터베이스 설치 및 설정 가이드](./데이터베이스_설치_및_설정_가이드.md)
- [실행 명령어 가이드](./실행_명령어_가이드.md)
- [데이터 파이프라인 이슈](../issues/데이터_파이프라인_청크_중복_문제.md)
- [데이터 파이프라인 Q&A](../QnA/데이터_파이프라인_QnA.md)

---

**작성자**: 연결의 민족 팀
**최종 수정일**: 2025-11-05
