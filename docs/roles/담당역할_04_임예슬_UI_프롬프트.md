# 담당역할: 임예슬 - Streamlit UI & 프롬프트 & 웹검색/파일저장 도구

## 담당자 정보
- **이름**: 임예슬
- **역할**: UI 및 프롬프트 담당
- **참여 기간**: 전체 기간
- **핵심 역할**: Streamlit UI 개발, 프롬프트 템플릿, 웹 검색 도구, 파일 저장 도구

---

## 담당 모듈 및 도구

### 1. Streamlit UI (`ui/app.py`)
- 채팅 인터페이스 구현
- LangGraph Agent 스트리밍 연동 (astream_events)
- StreamlitCallbackHandler 구현
- 난이도 선택 UI (Easy/Hard)
- 대화 히스토리 표시 (ChatMessageHistory 연동)
- 파일 다운로드 기능

### 2. 프롬프트 템플릿 (`src/prompts/`)
- Langchain PromptTemplate 구현
- ChatPromptTemplate으로 Easy/Hard 모드 프롬프트 구성
- FewShotPromptTemplate (예시 기반 프롬프트, 선택)
- 도구별 프롬프트 (SystemMessage, HumanMessage)

### 3. 도구 2: 웹 검색 도구 (`src/tools/web_search.py`)
- Langchain TavilySearchResults 도구 연동
- @tool 데코레이터로 커스텀 웹 검색 래퍼 구현
- 검색 결과 포맷팅

### 4. 도구 5: 파일 저장 도구 (`src/tools/file_save.py`)
- Langchain @tool 데코레이터로 save_to_file 구현
- 대화 내용 저장
- 요약 내용 저장
- Streamlit 다운로드 버튼 연동

---

## Streamlit UI 구현

### 1. 기본 채팅 인터페이스

**파일 경로**: `ui/app.py`

**구현 방법**:
1. Streamlit 페이지 설정
   - page_title, page_icon, layout 설정
2. 제목 및 설명 표시
3. 사이드바에 난이도 선택 UI 구현
   - selectbox로 Easy/Hard 모드 선택
   - 사용 방법 및 예시 질문 표시
4. 세션 상태 초기화
   - messages 리스트 (대화 이력)
   - memory_manager (ChatMemoryManager 인스턴스)
   - agent (LangGraph Agent)
5. 대화 히스토리 표시
   - st.session_state.messages를 순회하며 각 메시지 출력
6. 사용자 입력 처리
   - st.chat_input()으로 질문 입력
   - 사용자 메시지를 messages에 추가하고 화면에 표시
7. AI 답변 생성
   - st.spinner()로 로딩 표시
   - Agent.invoke()로 답변 생성 (question, difficulty, messages 전달)
   - 답변을 messages에 추가하고 화면에 표시
   - ChatMemoryManager에 대화 내용 저장
8. 대화 초기화 버튼 구현
   - 버튼 클릭 시 messages와 memory 초기화
   - st.rerun()으로 화면 새로고침

### 2. 스트리밍 응답 (고급)

**파일 경로**: `ui/app_streaming.py`

**구현 방법**:
1. StreamlitCallbackHandler 생성
   - st.container()를 전달하여 초기화
2. 응답을 표시할 placeholder 생성
   - st.empty()로 빈 컨테이너 생성
3. Agent 스트리밍 실행
   - agent.astream_events()로 비동기 이벤트 스트림 생성
   - question, difficulty 전달
4. 이벤트 처리
   - "on_chat_model_stream" 이벤트에서 청크 추출
   - 청크를 full_response에 누적
   - placeholder에 실시간으로 응답 업데이트 (커서 효과: "▌")
5. 최종 응답 표시
   - 스트리밍 완료 후 최종 응답 표시

### 3. 파일 다운로드 기능

**파일 경로**: `ui/app.py` (추가 기능)

**구현 방법**:
1. 사이드바에 파일 저장 섹션 추가
2. "대화 내용 저장" 버튼 구현
3. 버튼 클릭 시 처리
   - st.session_state.messages를 순회하며 텍스트로 변환
   - 각 메시지의 role에 따라 "사용자" 또는 "AI" 레이블 추가
4. 파일명 생성
   - datetime.now()로 현재 시간 기반 파일명 생성
5. st.download_button() 구현
   - conversation_text를 데이터로 전달
   - 생성된 파일명 사용
   - MIME 타입: text/plain
6. 성공 또는 경고 메시지 표시

---

## 프롬프트 템플릿 구현

### 1. Easy/Hard 모드 프롬프트

**파일 경로**: `src/prompts/templates.py`

**구현 방법**:
1. Langchain 프롬프트 모듈 임포트
   - ChatPromptTemplate, SystemMessagePromptTemplate, HumanMessagePromptTemplate, PromptTemplate
2. Easy 모드 시스템 프롬프트 정의
   - 전문 용어를 쉬운 말로 설명
   - 실생활 비유 사용
   - 수식 최소화 및 직관적 설명
   - 핵심 아이디어 3가지 이내로 요약
   - 초심자도 이해할 수 있는 언어 사용
3. Easy 모드 ChatPromptTemplate 생성
   - SystemMessage와 HumanMessage 조합
4. Hard 모드 시스템 프롬프트 정의
   - 기술적 세부사항 및 수식 포함
   - 알고리즘의 시간/공간 복잡도 분석
   - 관련 논문과의 비교 (장단점)
   - 구현 시 고려사항 설명
   - 최신 연구 동향과의 연결
5. Hard 모드 ChatPromptTemplate 생성
6. `get_difficulty_prompt` 함수 구현
   - 난이도에 따라 적절한 프롬프트 반환

### 2. RAG 프롬프트

**구현 방법**:
1. RAG_PROMPT_TEMPLATE을 ChatPromptTemplate으로 생성
2. SystemMessage에 다음 규칙 포함
   - 논문 리뷰 전문가 역할
   - 검색 결과의 내용을 기반으로 답변
   - 출처 명시 (논문 제목, 저자)
   - 검색 결과에 없는 내용은 추측하지 않음
   - 난이도 모드 반영
   - 검색 결과(context) 포함
3. HumanMessage에 사용자 질문 포함

### 3. Few-Shot 프롬프트 (선택)

**구현 방법**:
1. 예시 데이터 리스트 정의
   - Easy 모드 예시: "Transformer가 뭐야?" → 쉬운 설명
   - Hard 모드 예시: "Transformer의 시간 복잡도는?" → 기술적 설명
2. example_prompt 생성
   - PromptTemplate으로 question, difficulty, answer 포함
3. FewShotPromptTemplate 생성
   - examples: 예시 데이터
   - example_prompt: 예시 포맷
   - prefix: 도입 문구
   - suffix: 실제 질문 부분
   - input_variables: question, difficulty

---

## 도구 2: 웹 검색 도구

### 기능 설명
최신 논문 정보를 웹에서 실시간으로 검색하는 도구

### Langchain 구현

#### 1. TavilySearchResults 연동

**파일 경로**: `src/tools/web_search.py`

**구현 방법**:
1. TavilySearchResults 초기화
   - max_results: 5
   - search_depth: "advanced"
   - include_answer: True
   - include_raw_content: False
   - API 키를 환경변수에서 로드
2. `search_latest_papers` 함수를 @tool 데코레이터로 정의
   - 인자: query (검색 질문)
   - 검색 쿼리 확장 (AI ML paper 2024 2025 arxiv 추가)
   - tavily_search.invoke()로 검색 수행
3. `format_web_search_results` 함수 구현
   - 검색 결과를 Markdown 형식으로 포맷팅
   - 각 결과의 title, url, content 포함
   - 결과가 없으면 "검색 결과가 없습니다." 반환

#### 2. arXiv 검색 (선택)

**구현 방법**:
1. `search_arxiv` 함수를 @tool 데코레이터로 정의
   - 인자: query, max_docs
2. ArxivLoader로 검색 수행
   - query와 max_docs 전달
   - load()로 문서 로드
3. 결과 포맷팅
   - 각 문서의 Title, Authors, Published 메타데이터 추출
   - page_content에서 요약 500자 추출
   - Markdown 형식으로 포맷팅

### 사용하는 DB
**DB 사용 없음** (외부 API 호출)

---

## 도구 5: 파일 저장 도구

### 기능 설명
대화 내용, 논문 요약, 참고 자료를 파일로 저장하는 도구

### Langchain 구현

#### 1. 텍스트 파일 저장

**파일 경로**: `src/tools/file_save.py`

**구현 방법**:
1. `save_to_file` 함수를 @tool 데코레이터로 정의
   - 인자: content (저장할 내용), filename (선택적)
2. 파일명이 없으면 타임스탬프 기반으로 자동 생성
3. output_dir (data/outputs) 생성
4. 파일 경로 생성 및 파일 저장
5. 저장 성공 메시지 반환

#### 2. Markdown 형식 저장

**구현 방법**:
1. `save_to_markdown` 함수를 @tool 데코레이터로 정의
   - 인자: content, title, filename (선택적)
2. 파일명이 없으면 타임스탬프 기반으로 자동 생성
3. Markdown 형식으로 content 포맷팅
   - 제목, 생성일, 내용, 푸터 포함
4. output_dir 생성 및 파일 저장
5. 저장 성공 메시지 반환

#### 3. Streamlit 다운로드 버튼 연동

**파일 경로**: `ui/app.py` (파일 저장 UI)

**구현 방법**:
1. 사이드바에 파일 저장 섹션 추가
2. st.radio()로 저장 내용 선택 ("대화 내용" 또는 "마지막 답변만")
3. "파일 저장" 버튼 구현
4. 선택된 옵션에 따라 content 생성
   - "대화 내용": 전체 messages를 순회하며 텍스트 생성
   - "마지막 답변만": assistant 역할의 마지막 메시지 추출
5. save_to_file.invoke()로 파일 저장
6. st.download_button()으로 다운로드 버튼 생성
   - 타임스탬프 기반 파일명
   - MIME 타입: text/plain

### 사용하는 DB
**DB 사용 없음** (파일 시스템 직접 접근)

---

## LangGraph 통합 (웹 검색/파일 저장 노드)

**파일 경로**: `src/agent/nodes.py`

### 1. 웹 검색 노드

**구현 방법**:
1. `web_search_node` 함수 정의
   - 인자: state (AgentState)
2. state에서 질문 추출
3. 웹 검색 도구 호출
   - search_latest_papers.invoke()로 검색 수행
4. 검색 결과를 state["tool_result"]에 저장
5. 프롬프트 구성
   - 검색 결과와 사용자 질문 포함
6. LLM 호출하여 최종 답변 생성
   - SystemMessage: "당신은 최신 AI/ML 정보를 제공하는 전문가입니다."
   - HumanMessage: 프롬프트
7. 최종 답변을 state["final_answer"]에 저장 후 반환

### 2. 파일 저장 노드

**구현 방법**:
1. `save_file_node` 함수 정의
   - 인자: state (AgentState)
2. state에서 이전 답변(final_answer) 추출
3. 답변이 있으면 파일 저장 도구 호출
   - save_to_file.invoke()로 저장 수행
   - 저장 결과를 state["final_answer"]에 저장
4. 답변이 없으면 "저장할 내용이 없습니다." 메시지 반환
5. state 반환

---

## 개발 일정

### Phase 1: Streamlit UI 기초 개발
- 기본 채팅 인터페이스 구현
- 난이도 선택 UI
- 대화 히스토리 표시
- StreamlitCallbackHandler 연동

### Phase 2: 프롬프트 템플릿 개발
- Easy/Hard 모드 프롬프트
- RAG 프롬프트
- FewShotPromptTemplate (선택)

### Phase 3: 도구 개발
- 웹 검색 도구 (TavilySearchResults)
- 파일 저장 도구
- Streamlit 다운로드 버튼 연동

### Phase 4: 스트리밍 및 최적화
- 스트리밍 응답 구현
- UI 디자인 개선
- 통합 테스트

---

## Feature 브랜치

- `feature/streamlit-ui` - Streamlit UI
- `feature/prompts` - 프롬프트 템플릿
- `feature/tool-web-search` - 웹 검색 도구
- `feature/tool-file-save` - 파일 저장 도구

---

## 테스트 코드

**파일 경로**: `tests/test_tools.py`

### 테스트 항목

1. **test_web_search**: 웹 검색 도구 테스트
   - search_latest_papers.invoke() 호출 (query: "transformer 2025")
   - 반환 결과에 "검색 결과" 텍스트가 포함되어 있는지 확인
   - 결과가 비어있지 않은지 확인

2. **test_file_save**: 파일 저장 도구 테스트
   - save_to_file.invoke() 호출 (content: "테스트 내용입니다.", filename: "test_file.txt")
   - 반환 결과에 "저장되었습니다" 텍스트가 포함되어 있는지 확인
   - 파일이 실제로 생성되었는지 확인 (data/outputs/test_file.txt)

---

## 참고 자료

- Streamlit 공식 문서: https://docs.streamlit.io/
- Streamlit Chat Elements: https://docs.streamlit.io/library/api-reference/chat
- Langchain Prompts: https://python.langchain.com/docs/modules/model_io/prompts/
- Langchain Callbacks: https://python.langchain.com/docs/modules/callbacks/
- TavilySearchResults: https://python.langchain.com/docs/integrations/tools/tavily_search/
- StreamlitCallbackHandler: https://python.langchain.com/docs/integrations/callbacks/streamlit
