# 실험 폴더 명명 규칙

## 📋 개요

프로젝트에서 코드를 실행하고 결과물을 저장할 때는 **반드시 정해진 폴더 구조**를 따라야 합니다.

모든 실험 결과물(로그, 답변, DB 결과, config 설정 등)은 **동일한 실험 폴더**에 함께 저장되어야 합니다.

---

## 🎯 필수 폴더 구조

### 기본 형식
```
experiments/{날짜}/{날짜}_{시간}_{실험명}/
```

### 실제 예시
```
experiments/20251028/20251028_143052_rag_vectordb_build/
```

---

## 📂 폴더 구조 상세

```
experiments/
└── 20251028/                                      # 1단계: 날짜 폴더 (YYYYMMDD)
    ├── 20251028_143052_rag_vectordb_build/       # 2단계: 날짜_시간_실험명
    │   ├── experiment.log                         # 로그 파일
    │   ├── config.yaml                            # 실행 시 사용한 설정
    │   ├── vectordb/                              # VectorDB 결과
    │   ├── results.json                           # 실험 결과
    │   └── outputs/                               # 생성된 답변 등
    │
    ├── 20251028_150823_agent_execution/          # 다른 실험
    │   ├── experiment.log
    │   ├── config.yaml
    │   ├── user_queries.txt
    │   ├── responses.json
    │   └── tool_logs/
    │
    └── 20251028_163045_chatbot_evaluation/       # 또 다른 실험
        ├── experiment.log
        ├── config.yaml
        ├── test_questions.json
        ├── evaluation_results.json
        └── screenshots/
```

---

## 💻 실험 폴더 생성 방법

### 1. 기본 템플릿 (모든 코드에서 사용)

```python
import os
from datetime import datetime

# 1. 날짜와 시간 생성
today = datetime.now().strftime("%Y%m%d")        # "20251028"
time_now = datetime.now().strftime("%H%M%S")     # "143052"

# 2. 실험명 정의 (작업 내용에 맞게)
experiment_name = "rag_vectordb_build"

# 3. 실험 폴더 경로 생성
experiment_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"
os.makedirs(experiment_dir, exist_ok=True)

# 4. 이제 이 폴더에 모든 결과물 저장
print(f"실험 폴더 생성: {experiment_dir}")
```

### 2. 하위 폴더 구조 예시

```python
import os
from datetime import datetime

# 실험 폴더 생성
today = datetime.now().strftime("%Y%m%d")
time_now = datetime.now().strftime("%H%M%S")
experiment_name = "chatbot_evaluation"
experiment_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"

# 하위 폴더들 생성
os.makedirs(f"{experiment_dir}/outputs", exist_ok=True)      # 답변 결과
os.makedirs(f"{experiment_dir}/logs", exist_ok=True)         # 추가 로그
os.makedirs(f"{experiment_dir}/configs", exist_ok=True)      # 설정 파일
os.makedirs(f"{experiment_dir}/data", exist_ok=True)         # 데이터 파일

print(f"실험 폴더 및 하위 구조 생성 완료: {experiment_dir}")
```

---

## 📝 실험명 명명 규칙

실험명(`experiment_name`)은 작업 내용을 명확히 나타내야 합니다:

### 기능 개발
- 형식: `feature_<기능명>`
- 예시:
  - `feature_web_search_tool`
  - `feature_file_save`
  - `feature_rag_retriever`

### RAG 관련 작업
- 형식: `rag_<작업내용>`
- 예시:
  - `rag_vectordb_build`
  - `rag_document_loader_test`
  - `rag_retriever_evaluation`

### AI Agent 관련 작업
- 형식: `agent_<작업내용>`
- 예시:
  - `agent_tool_calling_test`
  - `agent_routing_logic`
  - `agent_execution_demo`

### 평가 작업
- 형식: `eval_<대상>`
- 예시:
  - `eval_chatbot_accuracy`
  - `eval_response_quality`
  - `eval_retrieval_performance`

### 디버깅/테스트
- 형식: `debug_<문제>` 또는 `test_<대상>`
- 예시:
  - `debug_memory_leak`
  - `debug_api_timeout`
  - `test_vectordb_connection`

---

## 📦 실험 폴더에 저장해야 할 파일들

### 1. 필수 파일

#### 로그 파일 (필수)
```python
from src.utils.logger import Logger

# Logger 생성 (반드시 실험 폴더 내부에)
logger = Logger(f"{experiment_dir}/experiment.log")
```

#### Config 설정 파일 (필수)
```python
import yaml

# 실행 시 사용한 설정을 저장
config = {
    "model": "gpt-4",
    "temperature": 0.7,
    "max_tokens": 2000,
    "embedding_model": "text-embedding-3-small"
}

with open(f"{experiment_dir}/config.yaml", "w") as f:
    yaml.dump(config, f)
```

### 2. 결과 파일

#### 실험 결과 (JSON/CSV 등)
```python
import json

# 실험 결과 저장
results = {
    "accuracy": 0.92,
    "f1_score": 0.89,
    "total_queries": 100,
    "successful": 92
}

with open(f"{experiment_dir}/results.json", "w") as f:
    json.dump(results, f, indent=2)
```

#### 사용자 질문 및 답변
```python
import json

# 챗봇 응답 저장
responses = [
    {
        "question": "RAG란 무엇인가요?",
        "answer": "RAG는 Retrieval-Augmented Generation의 약자로...",
        "timestamp": "2025-10-28 14:30:52"
    },
    # ...
]

with open(f"{experiment_dir}/responses.json", "w", encoding="utf-8") as f:
    json.dump(responses, f, ensure_ascii=False, indent=2)
```

### 3. 데이터베이스 결과

#### VectorDB 저장
```python
from langchain_community.vectorstores import Chroma

# VectorDB를 실험 폴더에 저장
vectordb = Chroma.from_documents(
    documents=chunks,
    embedding=embeddings,
    persist_directory=f"{experiment_dir}/vectordb"
)
```

#### RDB 결과 (SQLite)
```python
import sqlite3

# SQLite DB를 실험 폴더에 저장
db_path = f"{experiment_dir}/results.db"
conn = sqlite3.connect(db_path)
# ... DB 작업 ...
conn.close()
```

### 4. 기타 파일

#### 체크포인트/모델 가중치
```python
# 모델 체크포인트 저장
checkpoint_dir = f"{experiment_dir}/checkpoints"
os.makedirs(checkpoint_dir, exist_ok=True)

# 모델 저장 (예시)
model.save(f"{checkpoint_dir}/model_epoch_10.pt")
```

#### 스크린샷/시각화
```python
import matplotlib.pyplot as plt

# 그래프 저장
plt.figure()
plt.plot(losses)
plt.savefig(f"{experiment_dir}/loss_curve.png")
plt.close()
```

---

## 🎯 실전 사용 예시

### 예시 1: RAG VectorDB 구축

```python
import os
import yaml
from datetime import datetime
from src.utils.logger import Logger
from langchain_community.vectorstores import Chroma

def build_vectordb():
    # 1. 실험 폴더 생성
    today = datetime.now().strftime("%Y%m%d")
    time_now = datetime.now().strftime("%H%M%S")
    experiment_name = "rag_vectordb_build"
    experiment_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"
    os.makedirs(experiment_dir, exist_ok=True)

    # 2. Logger 생성
    logger = Logger(f"{experiment_dir}/experiment.log")
    logger.write("VectorDB 구축 시작")

    # 3. Config 저장
    config = {
        "embedding_model": "text-embedding-3-small",
        "chunk_size": 500,
        "chunk_overlap": 50,
        "document_source": "data/raw/papers/"
    }
    with open(f"{experiment_dir}/config.yaml", "w") as f:
        yaml.dump(config, f)
    logger.write(f"Config 저장 완료: {experiment_dir}/config.yaml")

    # 4. 문서 로드 및 처리
    documents = load_documents("data/raw/papers/")
    logger.write(f"총 {len(documents)}개 문서 로드 완료")

    chunks = text_splitter.split_documents(documents)
    logger.write(f"{len(chunks)}개 청크 생성 완료")

    # 5. VectorDB 생성 및 저장 (실험 폴더 내부)
    vectordb = Chroma.from_documents(
        documents=chunks,
        embedding=embeddings,
        persist_directory=f"{experiment_dir}/vectordb"
    )
    logger.write(f"VectorDB 저장 완료: {experiment_dir}/vectordb")

    # 6. 결과 요약 저장
    summary = {
        "total_documents": len(documents),
        "total_chunks": len(chunks),
        "vectordb_size": "100MB",  # 예시
        "timestamp": datetime.now().isoformat()
    }
    with open(f"{experiment_dir}/summary.json", "w") as f:
        json.dump(summary, f, indent=2)

    logger.write("VectorDB 구축 완료")
    logger.close()

    return experiment_dir
```

### 예시 2: 챗봇 평가

```python
import os
import json
from datetime import datetime
from src.utils.logger import Logger

def evaluate_chatbot(test_questions):
    # 1. 실험 폴더 생성
    today = datetime.now().strftime("%Y%m%d")
    time_now = datetime.now().strftime("%H%M%S")
    experiment_name = "eval_chatbot_accuracy"
    experiment_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"
    os.makedirs(experiment_dir, exist_ok=True)

    # 2. Logger 생성
    logger = Logger(f"{experiment_dir}/evaluation.log")
    logger.write(f"챗봇 평가 시작 - {len(test_questions)}개 질문")

    # 3. Config 저장
    config = {
        "model": "gpt-4",
        "temperature": 0.7,
        "max_tokens": 2000,
        "evaluation_criteria": ["accuracy", "relevance", "coherence"]
    }
    with open(f"{experiment_dir}/config.yaml", "w") as f:
        yaml.dump(config, f)

    # 4. 평가 실행 및 결과 저장
    results = []
    for question in test_questions:
        answer = chatbot.generate(question)
        score = evaluator.score(question, answer)

        result = {
            "question": question,
            "answer": answer,
            "score": score
        }
        results.append(result)
        logger.write(f"질문: {question} | 점수: {score}/5")

    # 5. 전체 결과 저장
    with open(f"{experiment_dir}/evaluation_results.json", "w", encoding="utf-8") as f:
        json.dump(results, f, ensure_ascii=False, indent=2)

    # 6. 통계 저장
    avg_score = sum(r["score"] for r in results) / len(results)
    stats = {
        "total_questions": len(test_questions),
        "average_score": avg_score,
        "passed": sum(1 for r in results if r["score"] >= 3),
        "failed": sum(1 for r in results if r["score"] < 3)
    }
    with open(f"{experiment_dir}/statistics.json", "w") as f:
        json.dump(stats, f, indent=2)

    logger.write(f"평가 완료 - 평균 점수: {avg_score:.2f}/5")
    logger.close()

    return experiment_dir
```

### 예시 3: Agent 실행 및 기록

```python
import os
import json
from datetime import datetime
from src.utils.logger import Logger

def run_agent_with_logging(user_query):
    # 1. 실험 폴더 생성
    today = datetime.now().strftime("%Y%m%d")
    time_now = datetime.now().strftime("%H%M%S")
    experiment_name = "agent_execution"
    experiment_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"
    os.makedirs(experiment_dir, exist_ok=True)

    # 2. Logger 생성
    logger = Logger(f"{experiment_dir}/agent_execution.log")
    logger.write(f"사용자 질문: {user_query}")

    # 3. 질문 분류
    query_type = router.classify(user_query)
    logger.write(f"질문 유형: {query_type}")

    # 4. 도구 호출 기록
    tool_logs = []
    if query_type == "web_search":
        logger.write("웹 검색 도구 호출")
        result = web_search_tool.run(user_query)
        tool_logs.append({
            "tool": "web_search",
            "query": user_query,
            "result_length": len(result)
        })
    elif query_type == "rag":
        logger.write("RAG 검색 도구 호출")
        result = rag_tool.run(user_query)
        tool_logs.append({
            "tool": "rag",
            "query": user_query,
            "result_length": len(result)
        })

    # 5. 도구 호출 로그 저장
    with open(f"{experiment_dir}/tool_logs.json", "w", encoding="utf-8") as f:
        json.dump(tool_logs, f, ensure_ascii=False, indent=2)

    # 6. 최종 응답 저장
    response = {
        "question": user_query,
        "query_type": query_type,
        "answer": result,
        "timestamp": datetime.now().isoformat()
    }
    with open(f"{experiment_dir}/response.json", "w", encoding="utf-8") as f:
        json.dump(response, f, ensure_ascii=False, indent=2)

    logger.write("Agent 실행 완료")
    logger.close()

    return result, experiment_dir
```

---

## ⚠️ 주의사항

### 1. 절대 경로 사용 금지
❌ 잘못된 예:
```python
# 하드코딩된 경로 사용 금지
experiment_dir = "C:/Users/myname/experiments/20251028/test/"
```

✅ 올바른 예:
```python
# 상대 경로 + 동적 생성
today = datetime.now().strftime("%Y%m%d")
time_now = datetime.now().strftime("%H%M%S")
experiment_dir = f"experiments/{today}/{today}_{time_now}_{experiment_name}"
```

### 2. 폴더 생성 확인
반드시 `os.makedirs()`로 폴더를 생성하세요:
```python
os.makedirs(experiment_dir, exist_ok=True)  # exist_ok=True 필수
```

### 3. 한글 파일명 사용 시 인코딩
한글이 포함된 파일 저장 시 UTF-8 인코딩을 명시:
```python
with open(f"{experiment_dir}/결과.json", "w", encoding="utf-8") as f:
    json.dump(data, f, ensure_ascii=False, indent=2)
```

### 4. 로그 파일은 항상 실험 폴더 내부에
❌ 잘못된 예:
```python
logger = Logger("logs/experiment.log")  # 별도 폴더에 로그 저장
```

✅ 올바른 예:
```python
logger = Logger(f"{experiment_dir}/experiment.log")  # 실험 폴더에 로그 저장
```

---

## 📋 체크리스트

코드 실행 전 다음을 확인하세요:

- [ ] `experiments/{날짜}/{날짜}_{시간}_{실험명}` 형식으로 폴더 생성
- [ ] 실험명이 작업 내용을 명확히 나타냄
- [ ] Logger를 실험 폴더 내부에 생성
- [ ] Config 설정을 YAML/JSON으로 저장
- [ ] 모든 결과물(답변, DB, 모델 등)을 동일한 실험 폴더에 저장
- [ ] 실험 완료 후 Logger 종료 (`logger.close()`)

---

## 🔍 실험 폴더 찾기

날짜별로 실험을 찾으려면:
```bash
# 특정 날짜의 모든 실험 보기
ls experiments/20251028/

# 특정 실험명 검색
ls experiments/20251028/ | grep "rag_vectordb"

# 최신 실험 찾기
ls -lt experiments/20251028/ | head -5
```

---

## 📚 참고

- Logger 사용법: `docs/rules/logger_사용법.md`
- 디렉토리 구조: `docs/PRD/디렉토리_구조.md`
- Commit 규칙: `docs/rules/commit_style.md`

---

## 💡 핵심 정리

1. **모든 실험 결과물**은 `experiments/{날짜}/{날짜}_{시간}_{실험명}/` 폴더에 저장
2. **로그, config, 결과물, DB, 모델** 등 모두 동일한 실험 폴더에 함께 저장
3. **실험명은 작업 내용**을 명확히 나타내야 함
4. **날짜와 시간**을 자동으로 생성하여 폴더명 중복 방지
5. 팀원들은 이 규칙을 **반드시 따라야** 함
