# 08. ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ

## ğŸ“‹ ë¬¸ì„œ ì •ë³´
- **ì‘ì„±ì¼**: 2025-11-04
- **ì‘ì„±ì**: ìµœí˜„í™”[íŒ€ì¥]
- **ì‹œìŠ¤í…œëª…**: ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œ (PostgreSQL + pgvector)
- **êµ¬í˜„ íŒŒì¼**: `src/database/`, `database/schema.sql`, `configs/db_config.yaml`
- **ìš°ì„ ìˆœìœ„**: â­â­â­ (ìµœê³  - í•µì‹¬ ì¸í”„ë¼)
- **ì°¸ê³  ë¬¸ì„œ**: [PRD/11_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md](../PRD/11_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)

---

## ğŸ“Œ ì‹œìŠ¤í…œ ê°œìš”

### ëª©ì  ë° ë°°ê²½

ë°ì´í„°ë² ì´ìŠ¤ ì‹œìŠ¤í…œì€ **ë…¼ë¬¸ ë¦¬ë·° ì±—ë´‡ì˜ ëª¨ë“  ë°ì´í„°ë¥¼ ì €ì¥í•˜ê³  ê´€ë¦¬**í•˜ëŠ” í•µì‹¬ ì¸í”„ë¼ì…ë‹ˆë‹¤. PostgreSQL 15+ë¥¼ RDBMSë¡œ ì‚¬ìš©í•˜ê³ , pgvector Extensionì„ í†µí•´ ë²¡í„° ê²€ìƒ‰ ê¸°ëŠ¥ì„ í†µí•©í•˜ì—¬ **í•˜ë‚˜ì˜ ë°ì´í„°ë² ì´ìŠ¤ì—ì„œ ê´€ê³„í˜• ë°ì´í„°ì™€ ë²¡í„° ë°ì´í„°ë¥¼ ëª¨ë‘ ì²˜ë¦¬**í•©ë‹ˆë‹¤.

### í†µí•© ë°ì´í„°ë² ì´ìŠ¤ ì „ëµ

**ì „í†µì ì¸ ë°©ì‹ (ë¶„ë¦¬í˜•)**:
```
PostgreSQL  â† ë…¼ë¬¸ ë©”íƒ€ë°ì´í„° (ì œëª©, ì €ì, ë‚ ì§œ ë“±)
    +
Chroma/Pinecone  â† ë²¡í„° ì„ë² ë”© (RAG ê²€ìƒ‰)
```

**ë³¸ í”„ë¡œì íŠ¸ ë°©ì‹ (í†µí•©í˜•)**:
```
PostgreSQL + pgvector
    â”œâ”€â”€ papers í…Œì´ë¸” (RDBMS)          â† ë…¼ë¬¸ ë©”íƒ€ë°ì´í„°
    â”œâ”€â”€ glossary í…Œì´ë¸” (RDBMS)        â† ìš©ì–´ì§‘
    â”œâ”€â”€ query_logs í…Œì´ë¸” (RDBMS)      â† ë¡œê·¸
    â””â”€â”€ langchain_pg_collection (pgvector) â† ë²¡í„° ì„ë² ë”©
        â””â”€â”€ langchain_pg_embedding     â† ì‹¤ì œ ë²¡í„° ë°ì´í„°
```

**í†µí•© ì „ëµì˜ ì¥ì **:
- **ë‹¨ì¼ DB ê´€ë¦¬**: ìš´ì˜ ë° ìœ ì§€ë³´ìˆ˜ ê°„ì†Œí™”
- **íŠ¸ëœì­ì…˜ ì¼ê´€ì„±**: ACID ë³´ì¥
- **ì¡°ì¸ ê°€ëŠ¥**: ê´€ê³„í˜• ë°ì´í„°ì™€ ë²¡í„° ë°ì´í„° ì¡°ì¸ ê°€ëŠ¥
- **ë¹„ìš© ì ˆê°**: ë³„ë„ì˜ ë²¡í„° DB ì„œë¹„ìŠ¤ ë¶ˆí•„ìš”
- **Langchain í†µí•©**: Langchain PGVector ë„¤ì´í‹°ë¸Œ ì§€ì›

---

## ğŸ—„ï¸ PostgreSQL 15+

### ë²„ì „ ì •ë³´
- **ì‚¬ìš© ë²„ì „**: PostgreSQL 15.5 ì´ìƒ
- **ì„¤ì¹˜ ìœ„ì¹˜**: WSL 24.04 LTS (Ubuntu)
- **í¬íŠ¸**: 5432 (ê¸°ë³¸ê°’)
- **ì¸ì½”ë”©**: UTF-8

### ì—­í•  ë° íŠ¹ì§•

**RDBMS (Relational Database Management System)**:
- SQL í‘œì¤€ ì¤€ìˆ˜
- ACID íŠ¸ëœì­ì…˜ ì§€ì›
- ë³µì¡í•œ ì¿¼ë¦¬ ìµœì í™”
- ê°•ë ¥í•œ ì¸ë±ìŠ¤ ì‹œìŠ¤í…œ

**í”„ë¡œì íŠ¸ì—ì„œ ì‚¬ìš©í•˜ëŠ” ì´ìœ **:
1. **í™•ì¥ì„±**: pgvector Extension ì§€ì›
2. **ì•ˆì •ì„±**: 20ë…„ ì´ìƒì˜ ê²€ì¦ëœ ì—­ì‚¬
3. **ì„±ëŠ¥**: Full-text search, GIN ì¸ë±ìŠ¤
4. **ì˜¤í”ˆì†ŒìŠ¤**: ë¬´ë£Œ, í™œë°œí•œ ì»¤ë®¤ë‹ˆí‹°
5. **Langchain ì§€ì›**: LangChain PGVector ë„¤ì´í‹°ë¸Œ í†µí•©

### PostgreSQL ì‚¬ìš©ì ì„¤ì •

**ì‚¬ìš©ì ì •ë³´**:
- **ì‚¬ìš©ìëª…**: `langchain`
- **ë¹„ë°€ë²ˆí˜¸**: `dusrufdmlalswhr` (í”„ë¡œì íŠ¸ ì „ìš©)
- **ê¶Œí•œ**: SUPERUSER, CREATE DB
- **ì ‘ì† ë°©ë²•**: TCP/IP (`-h localhost`)

**ì‚¬ìš©ì ìƒì„± ëª…ë ¹ì–´** (`docs/usage/` ë¬¸ì„œ ì°¸ì¡°):
```sql
CREATE USER langchain WITH PASSWORD 'dusrufdmlalswhr';
ALTER USER langchain CREATEDB;
ALTER USER langchain WITH SUPERUSER;
```

### ë°ì´í„°ë² ì´ìŠ¤ ì •ë³´

**ë°ì´í„°ë² ì´ìŠ¤ëª…**: `papers`
- **Owner**: langchain
- **Encoding**: UTF8
- **Collate**: en_US.UTF-8
- **Extensions**: vector (pgvector)

---

## ğŸ” pgvector 0.5.0+

### Extension ì—­í• 

**pgvector**ëŠ” PostgreSQLì—ì„œ **ë²¡í„° ì„ë² ë”©ì„ ì €ì¥í•˜ê³  ìœ ì‚¬ë„ ê²€ìƒ‰ì„ ìˆ˜í–‰**í•  ìˆ˜ ìˆê²Œ í•´ì£¼ëŠ” í™•ì¥ ê¸°ëŠ¥ì…ë‹ˆë‹¤.

**ì£¼ìš” ê¸°ëŠ¥**:
- **vector ë°ì´í„° íƒ€ì…**: `vector(1536)` (1536ì°¨ì› ë²¡í„°)
- **ìœ ì‚¬ë„ ì—°ì‚°ì**: ì½”ì‚¬ì¸ ìœ ì‚¬ë„, L2 ê±°ë¦¬, ë‚´ì 
- **ì¸ë±ìŠ¤**: IVFFlat ì¸ë±ìŠ¤ë¡œ ë¹ ë¥¸ ê²€ìƒ‰
- **SQL ì¿¼ë¦¬**: í‘œì¤€ SQLë¡œ ë²¡í„° ê²€ìƒ‰ ê°€ëŠ¥

### ë²¡í„° ê²€ìƒ‰ ì›ë¦¬

**ì„ë² ë”© ë²¡í„°**:
- OpenAI `text-embedding-3-small` ëª¨ë¸ ì‚¬ìš©
- **ì°¨ì›**: 1536
- **í‘œí˜„ ë°©ì‹**: Float32 ë°°ì—´

**ìœ ì‚¬ë„ ê³„ì‚°**:
```sql
-- ì½”ì‚¬ì¸ ìœ ì‚¬ë„ (Cosine Similarity)
SELECT
    content,
    embedding <=> '[0.1, 0.2, ...]'::vector AS distance
FROM langchain_pg_embedding
ORDER BY embedding <=> '[0.1, 0.2, ...]'::vector
LIMIT 5;
```

**ìœ ì‚¬ë„ ì—°ì‚°ì**:
- `<->`: L2 ê±°ë¦¬ (Euclidean Distance)
- `<=>`: ì½”ì‚¬ì¸ ê±°ë¦¬ (1 - Cosine Similarity)
- `<#>`: ë‚´ì  (Inner Product)

### IVFFlat ì¸ë±ìŠ¤

**ì¸ë±ìŠ¤ ìƒì„±**:
```sql
CREATE INDEX ON langchain_pg_embedding
USING ivfflat (embedding vector_cosine_ops);
```

**IVFFlat (Inverted File with Flat compression)**:
- **ì›ë¦¬**: ë²¡í„° ê³µê°„ì„ ì—¬ëŸ¬ í´ëŸ¬ìŠ¤í„°ë¡œ ë¶„í• 
- **ê²€ìƒ‰ ì†ë„**: O(log n) â†’ ìˆ˜ì‹­ë§Œ ë²¡í„°ë„ ë¹ ë¥¸ ê²€ìƒ‰
- **ì •í™•ë„**: ê·¼ì‚¬ ê²€ìƒ‰ (Approximate Nearest Neighbor)
- **íŠ¸ë ˆì´ë“œì˜¤í”„**: ì†ë„ vs ì •í™•ë„ ì¡°ì ˆ ê°€ëŠ¥

---

## ğŸ“Š ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ

### ì „ì²´ í…Œì´ë¸” êµ¬ì¡°

```
papers DB (PostgreSQL 15+)
â”‚
â”œâ”€â”€ ğŸ“ RDBMS í…Œì´ë¸” (ì‚¬ìš©ì ì •ì˜, 4ê°œ)
â”‚   â”œâ”€â”€ papers (ë…¼ë¬¸ ë©”íƒ€ë°ì´í„°)
â”‚   â”œâ”€â”€ glossary (ìš©ì–´ì§‘)
â”‚   â”œâ”€â”€ query_logs (ì‚¬ìš©ì ì§ˆì˜ ë¡œê·¸)
â”‚   â””â”€â”€ evaluation_results (ì„±ëŠ¥ í‰ê°€ ê²°ê³¼)
â”‚
â””â”€â”€ ğŸ“ VectorDB í…Œì´ë¸” (LangChain ìë™ ìƒì„±, 2ê°œ)
    â”œâ”€â”€ langchain_pg_collection (ë²¡í„° ì»¬ë ‰ì…˜ ë©”íƒ€ë°ì´í„°)
    â””â”€â”€ langchain_pg_embedding (ë²¡í„° ì„ë² ë”© ë°ì´í„°)
```

**RDBMS vs VectorDB êµ¬ë¶„**:

| êµ¬ë¶„ | í…Œì´ë¸” | ìƒì„± ë°©ì‹ | ê´€ë¦¬ ì£¼ì²´ | ìš©ë„ |
|------|--------|-----------|-----------|------|
| **RDBMS** | papers, glossary, query_logs, evaluation_results | `database/schema.sql` ìˆ˜ë™ ì‹¤í–‰ | ê°œë°œì | ë…¼ë¬¸ ë©”íƒ€ë°ì´í„°, ìš©ì–´ì§‘, ë¡œê·¸, í‰ê°€ ê²°ê³¼ ì €ì¥ |
| **VectorDB** | langchain_pg_collection, langchain_pg_embedding | LangChain PGVector ìë™ ìƒì„± | LangChain ë¼ì´ë¸ŒëŸ¬ë¦¬ | ë²¡í„° ì„ë² ë”© ì €ì¥ ë° ìœ ì‚¬ë„ ê²€ìƒ‰ |

**VectorDB ìë™ ìƒì„± ë©”ì»¤ë‹ˆì¦˜**:
- **ì‹œì **: `PGVector.from_documents()` ë˜ëŠ” `PGVector.from_texts()` ìµœì´ˆ í˜¸ì¶œ ì‹œ
- **ë°©ì‹**: LangChainì´ ë‚´ë¶€ì ìœ¼ë¡œ `CREATE TABLE IF NOT EXISTS` ì‹¤í–‰
- **íŠ¹ì§•**: ê°œë°œìê°€ ì§ì ‘ í…Œì´ë¸” ìƒì„± ë¶ˆí•„ìš”, ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ìŠ¤í‚¤ë§ˆ ê´€ë¦¬

---

### 1. papers í…Œì´ë¸” (ë…¼ë¬¸ ë©”íƒ€ë°ì´í„°)

#### ìŠ¤í‚¤ë§ˆ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| **paper_id** | SERIAL | PRIMARY KEY | ë…¼ë¬¸ ê³ ìœ  ID (ìë™ ì¦ê°€) |
| **title** | VARCHAR(500) | NOT NULL | ë…¼ë¬¸ ì œëª© |
| **authors** | TEXT | - | ì €ì ëª©ë¡ (ì‰¼í‘œ êµ¬ë¶„) |
| **publish_date** | DATE | - | ë°œí‘œ ë‚ ì§œ (YYYY-MM-DD) |
| **source** | VARCHAR(100) | - | ì¶œì²˜ (arXiv, IEEE, ACL ë“±) |
| **url** | TEXT | UNIQUE | ë…¼ë¬¸ URL (ì¤‘ë³µ ë°©ì§€) |
| **category** | VARCHAR(100) | - | ì¹´í…Œê³ ë¦¬ (cs.AI, cs.CL, cs.CV) |
| **citation_count** | INT | DEFAULT 0 | ì¸ìš© ìˆ˜ |
| **abstract** | TEXT | - | ë…¼ë¬¸ ì´ˆë¡ |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ìƒì„± ì‹œê°„ |
| **updated_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ìˆ˜ì • ì‹œê°„ |

#### ì¸ë±ìŠ¤ ì „ëµ

```sql
-- Full-text search ì¸ë±ìŠ¤ (ì œëª© ê²€ìƒ‰)
CREATE INDEX idx_papers_title
ON papers USING GIN (to_tsvector('english', title));

-- ì¹´í…Œê³ ë¦¬ ê²€ìƒ‰ ì¸ë±ìŠ¤
CREATE INDEX idx_papers_category ON papers(category);

-- ë‚ ì§œ ì •ë ¬ ì¸ë±ìŠ¤ (ìµœì‹ ìˆœ)
CREATE INDEX idx_papers_publish_date ON papers(publish_date DESC);

-- ìƒì„± ì‹œê°„ ì¸ë±ìŠ¤
CREATE INDEX idx_papers_created_at ON papers(created_at DESC);
```

**ì¸ë±ìŠ¤ ì„ íƒ ì´ìœ **:
- **GIN ì¸ë±ìŠ¤ (title)**: Full-text ê²€ìƒ‰ ì„±ëŠ¥ í–¥ìƒ
- **B-tree ì¸ë±ìŠ¤ (category, date)**: í•„í„°ë§ ë° ì •ë ¬ ìµœì í™”

#### ì‚¬ìš© ì‹œì 

**ë„êµ¬ë³„ papers í…Œì´ë¸” ì‚¬ìš©**:

| ë„êµ¬ | ì‚¬ìš© ë°©ì‹ | SQL ì¿¼ë¦¬ ì˜ˆì‹œ |
|------|-----------|---------------|
| **search_paper** | paper_idë¡œ ë©”íƒ€ë°ì´í„° ì¡°íšŒ | `SELECT * FROM papers WHERE paper_id = ?` |
| **summarize** | ë…¼ë¬¸ ì œëª©ìœ¼ë¡œ paper_id ê²€ìƒ‰ | `SELECT paper_id FROM papers WHERE title ILIKE '%Transformer%'` |
| **web_search** | arXiv ë…¼ë¬¸ ì €ì¥ (ArxivHandler) | `INSERT INTO papers (...) VALUES (...) ON CONFLICT (url) DO NOTHING` |
| **text2sql** | ë…¼ë¬¸ í†µê³„ ì¡°íšŒ | `SELECT COUNT(*) FROM papers WHERE EXTRACT(YEAR FROM publish_date) = 2024` |

---

### 2. glossary í…Œì´ë¸” (ìš©ì–´ì§‘)

#### ìŠ¤í‚¤ë§ˆ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| **term_id** | SERIAL | PRIMARY KEY | ìš©ì–´ ê³ ìœ  ID |
| **term** | VARCHAR(200) | NOT NULL, UNIQUE | ìš©ì–´ (ì˜ˆ: "BERT", "Attention") |
| **definition** | TEXT | NOT NULL | ê¸°ë³¸ ì •ì˜ |
| **easy_explanation** | TEXT | - | Easy ëª¨ë“œ ì„¤ëª… (ì´ˆì‹¬ììš©) |
| **hard_explanation** | TEXT | - | Hard ëª¨ë“œ ì„¤ëª… (ì „ë¬¸ê°€ìš©) |
| **category** | VARCHAR(100) | - | ì¹´í…Œê³ ë¦¬ (ML, NLP, CV, RL) |
| **difficulty_level** | VARCHAR(20) | - | ë‚œì´ë„ (beginner, intermediate, advanced) |
| **related_terms** | TEXT[] | - | ê´€ë ¨ ìš©ì–´ ë°°ì—´ |
| **examples** | TEXT | - | ì‚¬ìš© ì˜ˆì‹œ |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ìƒì„± ì‹œê°„ |
| **updated_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ìˆ˜ì • ì‹œê°„ |

#### ì¸ë±ìŠ¤

```sql
-- ìš©ì–´ ê²€ìƒ‰ ì¸ë±ìŠ¤
CREATE INDEX idx_glossary_term ON glossary(term);

-- ì¹´í…Œê³ ë¦¬ í•„í„° ì¸ë±ìŠ¤
CREATE INDEX idx_glossary_category ON glossary(category);

-- ë‚œì´ë„ í•„í„° ì¸ë±ìŠ¤
CREATE INDEX idx_glossary_difficulty ON glossary(difficulty_level);
```

#### ì‚¬ìš© ì‹œì 

**glossary ë„êµ¬**:
1. **ìš©ì–´ ì¶”ì¶œ**: LLMì´ ì§ˆë¬¸ì—ì„œ ìš©ì–´ ì¶”ì¶œ
2. **DB ê²€ìƒ‰**: `SELECT * FROM glossary WHERE term ILIKE '%BERT%'`
3. **ë‚œì´ë„ë³„ ë°˜í™˜**:
   - Easy ëª¨ë“œ â†’ `easy_explanation`
   - Hard ëª¨ë“œ â†’ `hard_explanation`
   - Fallback â†’ `definition`

**ì¿¼ë¦¬ ì˜ˆì‹œ**:
```sql
-- ìš©ì–´ ê²€ìƒ‰
SELECT
    term,
    CASE
        WHEN 'easy' = 'easy' THEN easy_explanation
        ELSE hard_explanation
    END AS explanation
FROM glossary
WHERE term ILIKE '%Attention%'
LIMIT 1;
```

---

### 3. query_logs í…Œì´ë¸” (ì‚¬ìš©ì ì§ˆì˜ ë¡œê·¸)

#### ìŠ¤í‚¤ë§ˆ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| **log_id** | SERIAL | PRIMARY KEY | ë¡œê·¸ ê³ ìœ  ID |
| **user_query** | TEXT | NOT NULL | ì‚¬ìš©ì ì§ˆë¬¸ |
| **difficulty_mode** | VARCHAR(20) | - | ë‚œì´ë„ (easy, hard) |
| **tool_used** | VARCHAR(50) | - | ì‚¬ìš©ëœ ë„êµ¬ëª… |
| **response** | TEXT | - | ìƒì„±ëœ ì‘ë‹µ |
| **response_time_ms** | INT | - | ì‘ë‹µ ì‹œê°„ (ë°€ë¦¬ì´ˆ) |
| **success** | BOOLEAN | DEFAULT TRUE | ì„±ê³µ ì—¬ë¶€ |
| **error_message** | TEXT | - | ì˜¤ë¥˜ ë©”ì‹œì§€ (ì‹¤íŒ¨ ì‹œ) |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ìƒì„± ì‹œê°„ |

#### ì¸ë±ìŠ¤

```sql
-- ì‹œê°„ ê¸°ë°˜ ì¡°íšŒ ì¸ë±ìŠ¤ (ìµœì‹ ìˆœ)
CREATE INDEX idx_query_logs_created_at ON query_logs(created_at DESC);

-- ë„êµ¬ë³„ í•„í„° ì¸ë±ìŠ¤
CREATE INDEX idx_query_logs_tool_used ON query_logs(tool_used);

-- ì„±ê³µ/ì‹¤íŒ¨ í•„í„° ì¸ë±ìŠ¤
CREATE INDEX idx_query_logs_success ON query_logs(success);
```

#### ì‚¬ìš© ì‹œì 

**text2sql ë„êµ¬**:
- ëª¨ë“  Text-to-SQL ìš”ì²­ì„ `query_logs` í…Œì´ë¸”ì— ê¸°ë¡
- ì„±ê³µ/ì‹¤íŒ¨ ì—¬ë¶€, ì‘ë‹µ ì‹œê°„, ì—ëŸ¬ ë©”ì‹œì§€ ì €ì¥

**ì¿¼ë¦¬ ì˜ˆì‹œ**:
```sql
-- í†µê³„ ë¶„ì„
SELECT
    tool_used,
    COUNT(*) AS total_queries,
    AVG(response_time_ms) AS avg_response_time,
    SUM(CASE WHEN success THEN 1 ELSE 0 END) * 100.0 / COUNT(*) AS success_rate
FROM query_logs
WHERE created_at >= NOW() - INTERVAL '7 days'
GROUP BY tool_used
ORDER BY total_queries DESC;
```

---

### 4. evaluation_results í…Œì´ë¸” (ì„±ëŠ¥ í‰ê°€ ê²°ê³¼)

#### ìŠ¤í‚¤ë§ˆ

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì œì•½ì¡°ê±´ | ì„¤ëª… |
|--------|------|----------|------|
| **eval_id** | SERIAL | PRIMARY KEY | í‰ê°€ ê³ ìœ  ID |
| **question** | TEXT | NOT NULL | ì‚¬ìš©ì ì§ˆë¬¸ |
| **answer** | TEXT | NOT NULL | AI ë‹µë³€ |
| **accuracy_score** | INT | CHECK (0~10) | ì •í™•ë„ ì ìˆ˜ (ì°¸ê³  ë¬¸ì„œ ì¼ì¹˜ë„) |
| **relevance_score** | INT | CHECK (0~10) | ê´€ë ¨ì„± ì ìˆ˜ (ì§ˆë¬¸-ë‹µë³€ ì—°ê´€ì„±) |
| **difficulty_score** | INT | CHECK (0~10) | ë‚œì´ë„ ì í•©ì„± ì ìˆ˜ (Easy/Hard ëª¨ë“œ) |
| **citation_score** | INT | CHECK (0~10) | ì¶œì²˜ ëª…ì‹œ ì ìˆ˜ (ë…¼ë¬¸ ì œëª©, ì €ì) |
| **total_score** | INT | CHECK (0~40) | ì´ì  (4ê°œ í•­ëª© í•©ê³„) |
| **comment** | TEXT | - | í‰ê°€ ì½”ë©˜íŠ¸ (ìƒì„¸ í”¼ë“œë°±) |
| **created_at** | TIMESTAMP | DEFAULT CURRENT_TIMESTAMP | ìƒì„± ì‹œê°„ |

#### ì¸ë±ìŠ¤

```sql
-- ì‹œê°„ ê¸°ë°˜ ì¡°íšŒ ì¸ë±ìŠ¤ (ìµœì‹ ìˆœ)
CREATE INDEX idx_evaluation_results_created_at
ON evaluation_results(created_at DESC);

-- ì´ì  ì •ë ¬ ì¸ë±ìŠ¤ (ì„±ëŠ¥ ìˆœìœ„)
CREATE INDEX idx_evaluation_results_total_score
ON evaluation_results(total_score DESC);
```

#### ì‚¬ìš© ì‹œì 

**ì„±ëŠ¥ í‰ê°€ ì‹œìŠ¤í…œ** (`src/evaluation/evaluator.py`):
1. **ë‹µë³€ í‰ê°€**: LLM-as-a-Judge ë°©ì‹ìœ¼ë¡œ ì±—ë´‡ ë‹µë³€ í’ˆì§ˆ í‰ê°€
2. **DB ì €ì¥**:
   ```sql
   INSERT INTO evaluation_results (
       question, answer,
       accuracy_score, relevance_score, difficulty_score, citation_score,
       total_score, comment
   ) VALUES (?, ?, ?, ?, ?, ?, ?, ?)
   ```
3. **í†µê³„ ë¶„ì„**:
   ```sql
   SELECT
       AVG(accuracy_score) AS avg_accuracy,
       AVG(relevance_score) AS avg_relevance,
       AVG(total_score) AS avg_total
   FROM evaluation_results
   WHERE created_at >= NOW() - INTERVAL '7 days'
   ```

**í‰ê°€ ê¸°ì¤€** (LLM-as-a-Judge):
- **accuracy_score**: ì°¸ê³  ë¬¸ì„œ ë‚´ìš©ê³¼ ì¼ì¹˜ë„
- **relevance_score**: ì§ˆë¬¸ ì˜ë„ ë¶€í•©ë„
- **difficulty_score**: Easy/Hard ëª¨ë“œ ì í•©ì„±
- **citation_score**: ì¶œì²˜(ë…¼ë¬¸ ì œëª©, ì €ì) ëª…ì‹œ ì—¬ë¶€

---

### 5. langchain_pg_collection (VectorDB ì»¬ë ‰ì…˜ ë©”íƒ€ë°ì´í„°)

#### ìŠ¤í‚¤ë§ˆ (LangChain ìë™ ìƒì„±)

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|--------|------|------|
| **uuid** | UUID | ì»¬ë ‰ì…˜ ê³ ìœ  ID |
| **name** | VARCHAR | ì»¬ë ‰ì…˜ ì´ë¦„ (ì˜ˆ: "paper_chunks") |
| **cmetadata** | JSONB | ì»¬ë ‰ì…˜ ë©”íƒ€ë°ì´í„° |

**ì»¬ë ‰ì…˜ ëª©ë¡**:
- `paper_chunks`: ë…¼ë¬¸ ë³¸ë¬¸ ì²­í¬ ì„ë² ë”©
- (í–¥í›„ í™•ì¥ ê°€ëŠ¥: paper_abstracts, glossary_embeddings)

---

### 6. langchain_pg_embedding (VectorDB ë²¡í„° ë°ì´í„°)

#### ìŠ¤í‚¤ë§ˆ (LangChain ìë™ ìƒì„±)

| ì»¬ëŸ¼ëª… | íƒ€ì… | ì„¤ëª… |
|--------|------|------|
| **uuid** | UUID | ì„ë² ë”© ê³ ìœ  ID |
| **collection_id** | UUID | ì»¬ë ‰ì…˜ ID (FK) |
| **embedding** | vector(1536) | ë²¡í„° ì„ë² ë”© (1536ì°¨ì›) |
| **document** | TEXT | ì›ë³¸ í…ìŠ¤íŠ¸ |
| **cmetadata** | JSONB | ë©”íƒ€ë°ì´í„° (paper_id, chunk_index ë“±) |

**ì„ë² ë”© ë²¡í„°**:
- **ëª¨ë¸**: OpenAI `text-embedding-3-small`
- **ì°¨ì›**: 1536
- **ì •ê·œí™”**: ë‹¨ìœ„ ë²¡í„° (ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ìµœì í™”)

**ë©”íƒ€ë°ì´í„° ì˜ˆì‹œ**:
```json
{
  "paper_id": 123,
  "chunk_index": 0,
  "title": "Attention Is All You Need",
  "source": "arXiv"
}
```

#### ì¸ë±ìŠ¤

```sql
-- IVFFlat ì¸ë±ìŠ¤ (ì½”ì‚¬ì¸ ìœ ì‚¬ë„)
CREATE INDEX langchain_pg_embedding_embedding_idx
ON langchain_pg_embedding
USING ivfflat (embedding vector_cosine_ops)
WITH (lists = 100);
```

**ì¸ë±ìŠ¤ íŒŒë¼ë¯¸í„°**:
- `lists`: í´ëŸ¬ìŠ¤í„° ê°œìˆ˜ (100 = ì¤‘ê°„ ì†ë„/ì •í™•ë„)
- `vector_cosine_ops`: ì½”ì‚¬ì¸ ìœ ì‚¬ë„ ì—°ì‚°ì

#### ì‚¬ìš© ì‹œì 

**RAG ê²€ìƒ‰ (search_paper ë„êµ¬)**:
1. **ì‚¬ìš©ì ì§ˆë¬¸ ì„ë² ë”©**: "What is Transformer?" â†’ `[0.1, 0.2, ..., 0.8]` (1536ì°¨ì›)
2. **ìœ ì‚¬ë„ ê²€ìƒ‰**:
   ```sql
   SELECT document, embedding <=> '[0.1, 0.2, ...]'::vector AS distance
   FROM langchain_pg_embedding
   WHERE collection_id = (SELECT uuid FROM langchain_pg_collection WHERE name = 'paper_chunks')
   ORDER BY distance
   LIMIT 5;
   ```
3. **ë©”íƒ€ë°ì´í„° ì¡°ì¸**:
   ```python
   # LangChainì´ ìë™ìœ¼ë¡œ ì²˜ë¦¬
   docs = vectorstore.similarity_search("What is Transformer?", k=5)
   # ë°˜í™˜: Document ë¦¬ìŠ¤íŠ¸ (page_content + metadata)
   ```

---

## ğŸ”— DB ì—°ê²° ì‹œìŠ¤í…œ

### Connection Pool (src/database/db.py)

**Connection Pool**ì€ **DB ì—°ê²°ì„ ì¬ì‚¬ìš©**í•˜ì—¬ ì„±ëŠ¥ì„ í–¥ìƒì‹œí‚¤ëŠ” ì‹œìŠ¤í…œì…ë‹ˆë‹¤.

**êµ¬í˜„**:
```python
class PostgreSQLConnectionPool:
    def __init__(self, min_connections=1, max_connections=10):
        db_config = get_db_config()
        pg_config = db_config['postgresql']

        self.connection_pool = psycopg2.pool.SimpleConnectionPool(
            minconn=min_connections,
            maxconn=max_connections,
            host=pg_config['host'],
            port=pg_config['port'],
            database=pg_config['database'],
            user=pg_config['user'],
            password=pg_config['password']
        )
```

**ì¥ì **:
- **ì„±ëŠ¥ í–¥ìƒ**: ì—°ê²° ìƒì„± ì˜¤ë²„í—¤ë“œ ì œê±°
- **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**: ìµœëŒ€ ì—°ê²° ìˆ˜ ì œí•œ (10ê°œ)
- **ë™ì‹œì„± ì§€ì›**: ì—¬ëŸ¬ ìš”ì²­ ë™ì‹œ ì²˜ë¦¬

### ì„¤ì • íŒŒì¼ (configs/db_config.yaml)

**êµ¬ì¡°**:
```yaml
postgresql:
  host: ${POSTGRES_HOST}
  port: ${POSTGRES_PORT}
  database: ${POSTGRES_DB}
  user: ${POSTGRES_USER}
  password: ${POSTGRES_PASSWORD}

pgvector:
  collections:
    - name: paper_chunks
      dimension: 1536
```

**í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜**:
- `${POSTGRES_HOST}` â†’ `.env` íŒŒì¼ì˜ `POSTGRES_HOST` ê°’
- `config_loader.py`ê°€ ìë™ìœ¼ë¡œ ì¹˜í™˜

### í™˜ê²½ ë³€ìˆ˜ (.env)

```bash
# PostgreSQL ì„¤ì •
POSTGRES_USER=langchain
POSTGRES_PASSWORD=dusrufdmlalswhr
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=papers
```

**ë¡œë“œ ë°©ì‹**:
1. `.env` íŒŒì¼ ì½ê¸° (`python-dotenv`)
2. `configs/db_config.yaml` ë¡œë“œ (`config_loader.py`)
3. í™˜ê²½ ë³€ìˆ˜ ì¹˜í™˜
4. Connection Pool ì´ˆê¸°í™”

---

## ğŸ”„ í”„ë¡œì íŠ¸ ì‹¤í–‰ ë‹¨ê³„ë³„ DB ì‚¬ìš©

### 1. ì• í”Œë¦¬ì¼€ì´ì…˜ ì´ˆê¸°í™”

**ì‹¤í–‰ ìˆœì„œ**:
```
Streamlit ì‹œì‘ (ui/app.py)
    â†“
Agent ì´ˆê¸°í™” (@st.cache_resource)
    â†“
Connection Pool ì´ˆê¸°í™” (src/database/db.py)
    â†“
PGVector VectorStore ì´ˆê¸°í™” (src/database/vector_store.py)
```

**DB ì—°ê²°**:
- **ì‹œì **: ì• í”Œë¦¬ì¼€ì´ì…˜ ì‹œì‘ ì‹œ 1íšŒ
- **ë°©ì‹**: Connection Pool (min=1, max=10)
- **ìºì‹±**: Streamlit `@st.cache_resource`ë¡œ ì¬ì‚¬ìš©

---

### 2. RAG ê²€ìƒ‰ (search_paper ë„êµ¬)

**ì‹¤í–‰ íë¦„**:
```
ì‚¬ìš©ì ì§ˆë¬¸: "What is Transformer?"
    â†“
Router ë…¸ë“œ â†’ search_paper ë„êµ¬ ì„ íƒ
    â†“
RAGRetriever.retrieve()
    â†“
[DB ì ‘ê·¼ 1] PGVector ìœ ì‚¬ë„ ê²€ìƒ‰
    SELECT * FROM langchain_pg_embedding
    WHERE collection_id = '...'
    ORDER BY embedding <=> '[0.1, 0.2, ...]'::vector
    LIMIT 5
    â†“
[DB ì ‘ê·¼ 2] papers í…Œì´ë¸” ì¡°ì¸ (ë©”íƒ€ë°ì´í„°)
    SELECT p.title, p.authors, p.publish_date
    FROM papers p
    WHERE p.paper_id IN (...)
    â†“
Document ë¦¬ìŠ¤íŠ¸ ë°˜í™˜ â†’ LLM ë‹µë³€ ìƒì„±
```

**DB ì—°ê²°**:
- **í…Œì´ë¸”**: `langchain_pg_embedding`, `papers`
- **ì¸ë±ìŠ¤ ì‚¬ìš©**: IVFFlat ì¸ë±ìŠ¤ (ë²¡í„° ê²€ìƒ‰), idx_papers_category
- **ì¿¼ë¦¬ ìˆ˜**: 1~2íšŒ

---

### 3. ìš©ì–´ì§‘ ê²€ìƒ‰ (glossary ë„êµ¬)

**ì‹¤í–‰ íë¦„**:
```
ì‚¬ìš©ì ì§ˆë¬¸: "BERTê°€ ë­ì•¼?"
    â†“
Router ë…¸ë“œ â†’ glossary ë„êµ¬ ì„ íƒ
    â†“
LLM ìš©ì–´ ì¶”ì¶œ: "BERT"
    â†“
[DB ì ‘ê·¼] glossary í…Œì´ë¸” ê²€ìƒ‰
    SELECT term, easy_explanation, hard_explanation
    FROM glossary
    WHERE term ILIKE '%BERT%'
    LIMIT 1
    â†“
ë‚œì´ë„ë³„ ì„¤ëª… ì„ íƒ (easy_explanation ë˜ëŠ” hard_explanation)
    â†“
ë‹µë³€ ë°˜í™˜
```

**DB ì—°ê²°**:
- **í…Œì´ë¸”**: `glossary`
- **ì¸ë±ìŠ¤ ì‚¬ìš©**: idx_glossary_term
- **ì¿¼ë¦¬ ìˆ˜**: 1íšŒ

---

### 4. Text-to-SQL (text2sql ë„êµ¬)

**ì‹¤í–‰ íë¦„**:
```
ì‚¬ìš©ì ì§ˆë¬¸: "2024ë…„ ë…¼ë¬¸ ê°œìˆ˜ëŠ”?"
    â†“
Router ë…¸ë“œ â†’ text2sql ë„êµ¬ ì„ íƒ
    â†“
LLM SQL ìƒì„±:
    SELECT COUNT(*) FROM papers
    WHERE EXTRACT(YEAR FROM publish_date) = 2024
    â†“
[DB ì ‘ê·¼ 1] SQL ì‹¤í–‰
    â†“
[DB ì ‘ê·¼ 2] query_logs í…Œì´ë¸” ë¡œê·¸ ì €ì¥
    INSERT INTO query_logs (user_query, tool_used, ...)
    VALUES (...)
    â†“
Markdown í‘œ í˜•ì‹ìœ¼ë¡œ ê²°ê³¼ ë°˜í™˜
```

**DB ì—°ê²°**:
- **í…Œì´ë¸”**: `papers`, `query_logs`
- **ì¸ë±ìŠ¤ ì‚¬ìš©**: idx_papers_publish_date
- **ì¿¼ë¦¬ ìˆ˜**: 2íšŒ (í†µê³„ ì¡°íšŒ + ë¡œê·¸ ì €ì¥)

---

### 5. ë…¼ë¬¸ ìš”ì•½ (summarize ë„êµ¬)

**ì‹¤í–‰ íë¦„**:
```
ì‚¬ìš©ì ì§ˆë¬¸: "Attention Is All You Need ìš”ì•½í•´ì¤˜"
    â†“
Router ë…¸ë“œ â†’ summarize ë„êµ¬ ì„ íƒ
    â†“
[DB ì ‘ê·¼ 1] papers í…Œì´ë¸” ì œëª© ê²€ìƒ‰
    SELECT paper_id FROM papers
    WHERE title ILIKE '%Attention Is All You Need%'
    LIMIT 1
    â†“
[DB ì ‘ê·¼ 2] PGVector ë…¼ë¬¸ ì „ì²´ ì²­í¬ ì¡°íšŒ
    SELECT document FROM langchain_pg_embedding
    WHERE cmetadata->>'paper_id' = '...'
    ORDER BY cmetadata->>'chunk_index'
    LIMIT 10
    â†“
ì²­í¬ ê²°í•© â†’ LLM ìš”ì•½ ìƒì„± â†’ ë‹µë³€ ë°˜í™˜
```

**DB ì—°ê²°**:
- **í…Œì´ë¸”**: `papers`, `langchain_pg_embedding`
- **ì¸ë±ìŠ¤ ì‚¬ìš©**: idx_papers_title (GIN ì¸ë±ìŠ¤)
- **ì¿¼ë¦¬ ìˆ˜**: 2íšŒ

---

### 6. ì›¹ ê²€ìƒ‰ + arXiv ì €ì¥ (web_search ë„êµ¬)

**ì‹¤í–‰ íë¦„**:
```
ì‚¬ìš©ì ì§ˆë¬¸: "2025ë…„ ìµœì‹  LLM ë…¼ë¬¸?"
    â†“
Router ë…¸ë“œ â†’ web_search ë„êµ¬ ì„ íƒ
    â†“
Tavily API í˜¸ì¶œ â†’ ê²€ìƒ‰ ê²°ê³¼ íšë“
    â†“
arXiv URL ê°ì§€? (ì˜ˆ: https://arxiv.org/abs/2301.12345)
    â†“
ArxivPaperHandler.process_arxiv_paper()
    â†“
[DB ì ‘ê·¼ 1] papers í…Œì´ë¸” ì €ì¥
    INSERT INTO papers (...) VALUES (...)
    ON CONFLICT (url) DO NOTHING
    RETURNING paper_id
    â†“
PDF ë‹¤ìš´ë¡œë“œ â†’ í…ìŠ¤íŠ¸ ì¶”ì¶œ â†’ ì²­í‚¹
    â†“
[DB ì ‘ê·¼ 2] PGVector ì„ë² ë”© ì €ì¥
    INSERT INTO langchain_pg_embedding (...)
    VALUES (...)
    â†“
ê²€ìƒ‰ ê²°ê³¼ LLM ì •ë¦¬ â†’ ë‹µë³€ ë°˜í™˜
```

**DB ì—°ê²°**:
- **í…Œì´ë¸”**: `papers`, `langchain_pg_embedding`
- **ì¿¼ë¦¬ ìˆ˜**: 2íšŒ (ë…¼ë¬¸ ì €ì¥ + ì„ë² ë”© ì €ì¥)

---

## ğŸ“ˆ DB ì„±ëŠ¥ ìµœì í™”

### ì¸ë±ìŠ¤ ì „ëµ

**Full-text Search (GIN ì¸ë±ìŠ¤)**:
- **í…Œì´ë¸”**: papers.title
- **ìš©ë„**: ì œëª© ì „ë¬¸ ê²€ìƒ‰
- **ì¿¼ë¦¬**: `WHERE to_tsvector('english', title) @@ to_tsquery('transformer')`

**B-tree ì¸ë±ìŠ¤**:
- **í…Œì´ë¸”**: papers.category, papers.publish_date
- **ìš©ë„**: í•„í„°ë§ ë° ì •ë ¬
- **ì¿¼ë¦¬**: `WHERE category = 'cs.CL' ORDER BY publish_date DESC`

**IVFFlat ì¸ë±ìŠ¤ (pgvector)**:
- **í…Œì´ë¸”**: langchain_pg_embedding.embedding
- **ìš©ë„**: ë²¡í„° ìœ ì‚¬ë„ ê²€ìƒ‰
- **ì¿¼ë¦¬**: `ORDER BY embedding <=> '[...]'::vector LIMIT 5`

### Connection Pool ì„¤ì •

**íŒŒë¼ë¯¸í„°**:
- **min_connections**: 1 (ìµœì†Œ ì—°ê²° ìˆ˜)
- **max_connections**: 10 (ìµœëŒ€ ì—°ê²° ìˆ˜)

**íŠœë‹ ê°€ì´ë“œ**:
- **ë™ì‹œ ì‚¬ìš©ì 10ëª… ì´í•˜**: max=10
- **ë™ì‹œ ì‚¬ìš©ì 10~50ëª…**: max=20
- **ë™ì‹œ ì‚¬ìš©ì 50ëª… ì´ìƒ**: max=50 + pgBouncer ë„ì…

### ì¿¼ë¦¬ ìµœì í™”

**EXPLAIN ANALYZE ì‚¬ìš©**:
```sql
EXPLAIN ANALYZE
SELECT * FROM papers
WHERE category = 'cs.CL'
ORDER BY publish_date DESC
LIMIT 10;
```

**ì¸ë±ìŠ¤ í™œìš© í™•ì¸**:
```
Index Scan using idx_papers_category on papers  (cost=0.29..45.76 rows=10 width=...)
  Index Cond: ((category)::text = 'cs.CL'::text)
  Filter: (publish_date IS NOT NULL)
```

---

## ğŸ”— ê´€ë ¨ ë¬¸ì„œ

- **[PRD/11_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md](../PRD/11_ë°ì´í„°ë² ì´ìŠ¤_ì„¤ê³„.md)** - ë°ì´í„°ë² ì´ìŠ¤ ì„¤ê³„ ëª…ì„¸
- **[09_RAG_ì‹œìŠ¤í…œ.md](./09_RAG_ì‹œìŠ¤í…œ.md)** - RAG ì‹œìŠ¤í…œì—ì„œ DB ì‚¬ìš©
- **[06_ë„êµ¬_ì‹œìŠ¤í…œ.md](./06_ë„êµ¬_ì‹œìŠ¤í…œ.md)** - ë„êµ¬ë³„ DB ì‚¬ìš© ë°©ì‹
- **[01_ê°œë°œí™˜ê²½_ë°_ê¸°ìˆ ìŠ¤íƒ.md](./01_ê°œë°œí™˜ê²½_ë°_ê¸°ìˆ ìŠ¤íƒ.md)** - PostgreSQL ì„¤ì¹˜ ê°€ì´ë“œ

---

## ğŸ“ ìš”ì•½

### í•µì‹¬ êµ¬ì„± ìš”ì†Œ

**ë°ì´í„°ë² ì´ìŠ¤**:
- PostgreSQL 15.5
- pgvector 0.5.0

**RDBMS í…Œì´ë¸”** (3ê°œ):
- papers (ë…¼ë¬¸ ë©”íƒ€ë°ì´í„°)
- glossary (ìš©ì–´ì§‘)
- query_logs (ë¡œê·¸)

**pgvector í…Œì´ë¸”** (LangChain, 2ê°œ):
- langchain_pg_collection (ì»¬ë ‰ì…˜)
- langchain_pg_embedding (ë²¡í„° ì„ë² ë”©)

### ì—°ê²° ì •ë³´

**ì‚¬ìš©ì**: langchain / dusrufdmlalswhr
**ë°ì´í„°ë² ì´ìŠ¤**: papers
**í˜¸ìŠ¤íŠ¸**: localhost:5432
**Connection Pool**: min=1, max=10

### ë„êµ¬ë³„ DB ì‚¬ìš©

| ë„êµ¬ | ì‚¬ìš© í…Œì´ë¸” | ì¿¼ë¦¬ ìˆ˜ |
|------|-------------|---------|
| **search_paper** | langchain_pg_embedding, papers | 1~2íšŒ |
| **glossary** | glossary | 1íšŒ |
| **summarize** | papers, langchain_pg_embedding | 2íšŒ |
| **text2sql** | papers, query_logs | 2íšŒ |
| **web_search** | papers, langchain_pg_embedding | 2íšŒ (arXiv ì‹œ) |

### ì„±ëŠ¥ ìµœì í™”

- âœ… IVFFlat ì¸ë±ìŠ¤ (ë²¡í„° ê²€ìƒ‰)
- âœ… GIN ì¸ë±ìŠ¤ (Full-text search)
- âœ… B-tree ì¸ë±ìŠ¤ (í•„í„°ë§/ì •ë ¬)
- âœ… Connection Pool (ì—°ê²° ì¬ì‚¬ìš©)
- âœ… í™˜ê²½ ë³€ìˆ˜ ê¸°ë°˜ ì„¤ì • (configs/db_config.yaml)
