# 멀티턴 맥락 참조 라우팅 개선

## 📋 문서 정보
- **작성일**: 2025-11-05
- **작성자**: 최현화[팀장]
- **이슈 유형**: 버그 수정 + 기능 개선
- **우선순위**: ⭐⭐⭐ (긴급 - 사용자 기능 미작동)
- **상태**: ✅ 완료

---

## 🎯 이슈 개요

### 문제 상황
사용자가 **"관련", "그거", "이거"** 같은 대명사나 맥락 참조 표현을 사용할 때, 이전 대화 내용을 고려하지 않고 도구를 선택하는 문제 발생.

**예시**:
```
[1] 사용자: "Vision Transformer가 뭐야?"
    → glossary 도구 실행 (정상)

[2] 사용자: "관련 논문 찾아줘"
    → 문제: "관련"이 무엇을 가리키는지 이전 대화(Vision Transformer)를 고려하지 않음
    → search_paper 도구가 "관련"이라는 모호한 키워드로 검색 시도
```

### 로그 분석 결과

**실험 폴더**: `experiments/20251105/20251105_231329_session_033`

#### 대화 흐름 (chatbot.log)
```
Line 16: 라우터 노드 실행: Vision Transformer가 뭐야?
Line 17: 다중 요청 감지: ['뭐야'] → ['glossary']
Line 19: 단일 도구 실행: glossary
Line 27: 도구 실행 성공: glossary

Line 35: 라우터 노드 실행: 관련 논문 찾아줘
Line 36: 다중 요청 감지: ['논문', '찾'] → ['search_paper']
Line 38: 단일 도구 실행: search_paper
```

#### 문제점
- **Line 36**: "관련 논문 찾아줘" → 패턴 매칭으로 `['논문', '찾']` 키워드 감지
- **패턴 매칭이 먼저 실행되어 즉시 return** → Multi-turn 컨텍스트 처리 로직(Line 116-129)이 실행되지 않음
- **결과**: "관련"이 "Vision Transformer"를 가리킨다는 맥락 정보를 활용하지 못함

---

## 📝 근본 원인 분석

### 라우터 노드 실행 순서 (src/agent/nodes.py)

**이전 로직 순서**:
```python
def router_node(state: AgentState, exp_manager=None):
    question = state["question"]

    # 1. 패턴 매칭 (Line 48-89)
    for pattern in multi_request_patterns:
        if keywords_match and not exclude_match:
            state["tool_choice"] = tools[0]
            return state  # ← 여기서 즉시 return! ❌

    # 2. Multi-turn 컨텍스트 처리 (Line 116-129) - 실행되지 않음 ❌
    messages = state.get("messages", [])
    if len(messages) > 1:
        # 이전 대화 컨텍스트 추출
        context = "..."
        routing_prompt = f"{context}{base_prompt}"
```

### 문제점
1. **패턴 매칭이 최우선 순위**로 실행
2. "논문 + 찾" 키워드가 있으면 즉시 `search_paper` 선택 후 return
3. **Multi-turn 컨텍스트 처리 로직이 실행되지 않음**
4. "관련"이라는 대명사가 무엇을 가리키는지 파악할 기회가 없음

---

## 🔧 해결 방안

### 방안: 패턴 매칭 전 맥락 참조 감지

**핵심 아이디어**:
- 대명사나 맥락 참조 표현이 있으면 패턴 매칭을 건너뛰고 LLM 라우팅으로 진행
- LLM 라우팅은 이전 대화 컨텍스트를 고려하여 질문을 정확하게 이해

**수정 전** (src/agent/nodes.py:44-52):
```python
# -------------- 로깅 -------------- #
if exp_manager:
    exp_manager.logger.write(f"라우터 노드 실행: {question}")

# -------------- 다중 요청 감지 (YAML 패턴 기반) -------------- #
# YAML 파일에서 패턴 로드 (우선순위 정렬됨)
multi_request_patterns = get_multi_request_patterns()

# 다중 요청 패턴 확인 (우선순위 높은 순서대로)
for pattern in multi_request_patterns:
```

**수정 후** (src/agent/nodes.py:44-66):
```python
# -------------- 로깅 -------------- #
if exp_manager:
    exp_manager.logger.write(f"라우터 노드 실행: {question}")

# -------------- Multi-turn 맥락 참조 감지 -------------- #
# 대명사나 맥락 참조 표현이 있으면 이전 대화 컨텍스트를 고려해야 함
# 이 경우 패턴 매칭을 건너뛰고 LLM 라우팅으로 진행
contextual_keywords = ["관련", "그거", "이거", "저거", "해당", "방금", "위", "앞서", "이전", "그"]
has_contextual_ref = any(kw in question for kw in contextual_keywords)

if has_contextual_ref and len(state.get("messages", [])) > 1:
    # 맥락 참조가 있고 이전 대화가 있는 경우
    if exp_manager:
        exp_manager.logger.write(f"Multi-turn 맥락 참조 감지: 패턴 매칭 건너뛰고 LLM 라우팅 사용")
    # 패턴 매칭을 건너뛰고 LLM 라우팅으로 진행 (tool_choice는 None으로 유지)
    pass
else:
    # -------------- 다중 요청 감지 (YAML 패턴 기반) -------------- #
    # YAML 파일에서 패턴 로드 (우선순위 정렬됨)
    multi_request_patterns = get_multi_request_patterns()

    # 다중 요청 패턴 확인 (우선순위 높은 순서대로)
    for pattern in multi_request_patterns:
        # ... 기존 패턴 매칭 로직 ...
```

### 변경 사항
1. **맥락 참조 키워드 목록 정의** (Line 51):
   - `["관련", "그거", "이거", "저거", "해당", "방금", "위", "앞서", "이전", "그"]`
2. **맥락 참조 감지** (Line 52):
   - 질문에 맥락 참조 키워드가 포함되어 있는지 확인
3. **패턴 매칭 건너뛰기** (Line 54-59):
   - 맥락 참조가 있고 이전 대화가 존재하면 패턴 매칭을 건너뛰고 LLM 라우팅으로 진행
4. **기존 패턴 매칭 로직** (Line 60-102):
   - 맥락 참조가 없는 경우에만 실행

---

## ✅ 개선 효과

### 1. 멀티턴 대화 정상 작동

**이전**:
```
사용자: "Vision Transformer가 뭐야?"
→ glossary 실행

사용자: "관련 논문 찾아줘"
→ 패턴 매칭: ['논문', '찾'] → search_paper
→ search_paper("관련 논문") - 모호한 검색 ❌
```

**개선 후**:
```
사용자: "Vision Transformer가 뭐야?"
→ glossary 실행

사용자: "관련 논문 찾아줘"
→ Multi-turn 맥락 참조 감지
→ 패턴 매칭 건너뛰고 LLM 라우팅 사용
→ LLM이 이전 대화 컨텍스트 고려:
   [이전 대화 컨텍스트]
   사용자: Vision Transformer가 뭐야?
   AI: Vision Transformer는...

   현재 질문: 관련 논문 찾아줘
→ search_paper("Vision Transformer 논문") - 정확한 검색 ✅
```

### 2. 다양한 맥락 참조 표현 지원

테스트 결과 (scripts/tests/test_multiturn_routing.py):
```
✅ "그거 논문 찾아줘" → Multi-turn 감지됨
✅ "이거 관련 논문 검색해줘" → Multi-turn 감지됨
✅ "방금 말한 거 논문 찾아줘" → Multi-turn 감지됨
✅ "위에서 설명한 거 논문 보여줘" → Multi-turn 감지됨
✅ "해당 논문 찾아줘" → Multi-turn 감지됨
```

### 3. 기존 패턴 매칭 성능 유지

**맥락 참조가 없는 경우**:
```
사용자: "Transformer 논문 찾아줘"
→ 맥락 참조 키워드 없음
→ 패턴 매칭 실행
→ ['논문', '찾'] → search_paper
→ search_paper("Transformer 논문") - 정확한 검색 ✅
```

---

## 🧪 테스트 시나리오

### 시나리오 1: 멀티턴 맥락 참조
**질문 순서**:
1. "Vision Transformer가 뭐야?"
2. "관련 논문 찾아줘"

**예상 동작**:
1. glossary 실행 → "Vision Transformer" 설명 생성
2. Multi-turn 맥락 참조 감지 → LLM 라우팅
3. LLM이 이전 대화 컨텍스트 고려 → "Vision Transformer 논문 찾아줘"로 해석
4. search_paper("Vision Transformer 논문") 실행

### 시나리오 2: 맥락 참조 없는 일반 질문
**질문**: "Transformer 논문 찾아줘"

**예상 동작**:
1. 맥락 참조 키워드 없음
2. 패턴 매칭 실행
3. ['논문', '찾'] 키워드 감지 → search_paper 선택
4. search_paper("Transformer 논문") 실행

### 시나리오 3: 다양한 맥락 참조 키워드
**질문**: "그거", "이거", "해당", "방금", "위" 등

**예상 동작**:
- 모두 Multi-turn 맥락 참조로 감지
- LLM 라우팅 사용
- 이전 대화 컨텍스트 고려하여 정확한 도구 선택

---

## 📁 수정된 파일 목록

| 파일 경로 | 수정 내용 | 변경 라인 |
|-----------|----------|-----------|
| `src/agent/nodes.py` | Multi-turn 맥락 참조 감지 로직 추가, 패턴 매칭 조건부 실행 | 48-102 |
| `scripts/tests/test_multiturn_routing.py` | 멀티턴 라우팅 테스트 스크립트 작성 (신규) | 전체 |

---

## 🔗 관련 문서

- **[06_라우터_시스템.md](../modularization/06_라우터_시스템.md)** - 라우터 노드 설명
- **[06-1_다중_요청_처리.md](../modularization/06-1_다중_요청_처리.md)** - 다중 요청 패턴 매칭

---

## 📝 요약

1. **문제**: 패턴 매칭이 먼저 실행되어 Multi-turn 컨텍스트 처리 로직이 실행되지 않음
2. **해결**: 맥락 참조 키워드 감지 → 패턴 매칭 건너뛰고 LLM 라우팅 사용
3. **효과**:
   - "관련", "그거" 등 대명사 표현 시 이전 대화 맥락 고려
   - LLM이 정확한 주제로 질문 재해석
   - 맥락 참조 없는 일반 질문은 기존 패턴 매칭 사용 (성능 유지)

이로써 사용자가 "관련 논문 찾아줘" 요청 시:
- Multi-turn 맥락 참조 감지
- 이전 대화에서 주제 추출 ("Vision Transformer")
- 정확한 검색 수행
